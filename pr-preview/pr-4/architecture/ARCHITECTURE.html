<!DOCTYPE html>
<html lang="en" data-accent-color="violet" data-content_root="../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Async Python Debug Toolbar - Architecture Document - Async Debug Toolbar 0.1.0 documentation</title><link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="ADR-001: Dual Package Architecture" href="adr/ADR-001-dual-package-architecture.html" /><link rel="prev" title="debug_toolbar.litestar.routes.handlers" href="../api/_autosummary/debug_toolbar.litestar.routes.handlers.html" /><script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(localStorage._theme||"auto");
  </script><link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=e1a1ceaf" />
    <link rel="stylesheet" type="text/css" href="../_static/shibuya.css?v=14737038" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link media="print" rel="stylesheet" type="text/css" href="../_static/print.css?v=20ff2c19" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-text: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
  --sy-f-heading: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/><meta property="og:title" content="Async Python Debug Toolbar - Architecture Document"/>
    <meta name="twitter:card" content="summary"/>
  </head>
<body><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand" href="../index.html">
      
      
      <strong>Async Debug Toolbar</strong>
    </a>
    <div class="sy-head-nav" id="head-nav">
      <nav class="sy-head-links"><ul><li class="link">
          <a href="https://litestar.dev">
            <span>Litestar</span></a>
        </li><li class="link">
          <a href="https://pypi.org/project/debug-toolbar">
            <span>PyPI</span></a>
        </li></ul></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form><div class="sy-head-socials">
  <a href="https://github.com/JacobCoffee/async-python-debug-toolbar" aria-label="GitHub">
    <iconify-icon icon="simple-icons:github"></iconify-icon>
  </a></div></div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden"><button class="js-theme theme-switch flex items-center"
data-aria-auto="Switch to light color mode"
data-aria-light="Switch to dark color mode"
data-aria-dark="Switch to auto color mode">
<i class="i-lucide theme-icon"></i>
</button><button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="head-nav" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2"></span>
          <span class="hamburger_3"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="lside" class="sy-lside md:w-72 md:shrink-0 print:hidden">
    <div class="sy-lside-inner md:sticky">
      <div class="sy-scrollbar p-6">
        <div class="globaltoc" data-expand-depth="0"><p class="caption" role="heading" aria-level="3"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../panels.html">Built-in Panels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../custom-panels.html">Creating Custom Panels</a></li>
</ul>
<p class="caption" role="heading" aria-level="3"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../api/_autosummary/debug_toolbar.html">debug_toolbar</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/_autosummary/debug_toolbar.core.html">debug_toolbar.core</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/_autosummary/debug_toolbar.core.config.html">debug_toolbar.core.config</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/_autosummary/debug_toolbar.core.context.html">debug_toolbar.core.context</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/_autosummary/debug_toolbar.core.panel.html">debug_toolbar.core.panel</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/_autosummary/debug_toolbar.core.panels.html">debug_toolbar.core.panels</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/_autosummary/debug_toolbar.core.storage.html">debug_toolbar.core.storage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/_autosummary/debug_toolbar.core.toolbar.html">debug_toolbar.core.toolbar</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/_autosummary/debug_toolbar.extras.html">debug_toolbar.extras</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/_autosummary/debug_toolbar.extras.advanced_alchemy.html">debug_toolbar.extras.advanced_alchemy</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/_autosummary/debug_toolbar.litestar.html">debug_toolbar.litestar</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/_autosummary/debug_toolbar.litestar.config.html">debug_toolbar.litestar.config</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/_autosummary/debug_toolbar.litestar.middleware.html">debug_toolbar.litestar.middleware</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/_autosummary/debug_toolbar.litestar.panels.html">debug_toolbar.litestar.panels</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/_autosummary/debug_toolbar.litestar.plugin.html">debug_toolbar.litestar.plugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/_autosummary/debug_toolbar.litestar.routes.html">debug_toolbar.litestar.routes</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading" aria-level="3"><span class="caption-text">Architecture</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Async Python Debug Toolbar - Architecture Document</a></li>
<li class="toctree-l1"><a class="reference internal" href="adr/ADR-001-dual-package-architecture.html">ADR-001: Dual Package Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="adr/ADR-002-panel-system-design.html">ADR-002: Panel System Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="adr/ADR-003-storage-and-context.html">ADR-003: Storage and Context Management</a></li>
</ul>

        </div>
      </div>
    </div>
  </aside>
  <div class="lside-overlay js-menu" role="button" aria-label="Close left sidebar" aria-controls="lside" aria-expanded="false"></div>
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-lucide close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><div class="localtoc"><h3>On this page</h3><ul>
<li><a class="reference internal" href="#table-of-contents">Table of Contents</a></li>
<li><a class="reference internal" href="#overview">1. Overview</a><ul>
<li><a class="reference internal" href="#purpose">1.1 Purpose</a></li>
<li><a class="reference internal" href="#design-goals">1.2 Design Goals</a></li>
<li><a class="reference internal" href="#architecture-principles">1.3 Architecture Principles</a></li>
</ul>
</li>
<li><a class="reference internal" href="#package-structure">2. Package Structure</a><ul>
<li><a class="reference internal" href="#repository-layout">2.1 Repository Layout</a></li>
<li><a class="reference internal" href="#package-dependencies">2.2 Package Dependencies</a></li>
</ul>
</li>
<li><a class="reference internal" href="#core-components">3. Core Components</a><ul>
<li><a class="reference internal" href="#debugtoolbar-manager">3.1 DebugToolbar Manager</a></li>
<li><a class="reference internal" href="#base-panel-class">3.2 Base Panel Class</a></li>
<li><a class="reference internal" href="#configuration-system">3.3 Configuration System</a></li>
<li><a class="reference internal" href="#storage-backend">3.4 Storage Backend</a></li>
<li><a class="reference internal" href="#request-context">3.5 Request Context</a></li>
<li><a class="reference internal" href="#template-rendering-system">3.6 Template/Rendering System</a></li>
<li><a class="reference internal" href="#abstract-asgi-adapter">3.7 Abstract ASGI Adapter</a></li>
</ul>
</li>
<li><a class="reference internal" href="#built-in-panels">4. Built-in Panels</a><ul>
<li><a class="reference internal" href="#timerpanel">4.1 TimerPanel</a></li>
<li><a class="reference internal" href="#requestpanel">4.2 RequestPanel</a></li>
<li><a class="reference internal" href="#responsepanel">4.3 ResponsePanel</a></li>
<li><a class="reference internal" href="#loggingpanel">4.4 LoggingPanel</a></li>
<li><a class="reference internal" href="#profilingpanel">4.5 ProfilingPanel</a></li>
<li><a class="reference internal" href="#versionspanel">4.6 VersionsPanel</a></li>
<li><a class="reference internal" href="#routespanel">4.7 RoutesPanel</a></li>
</ul>
</li>
<li><a class="reference internal" href="#extension-points">5. Extension Points</a><ul>
<li><a class="reference internal" href="#creating-custom-panels">5.1 Creating Custom Panels</a></li>
<li><a class="reference internal" href="#panel-registration">5.2 Panel Registration</a></li>
<li><a class="reference internal" href="#hook-system">5.3 Hook System</a></li>
<li><a class="reference internal" href="#template-customization">5.4 Template Customization</a></li>
</ul>
</li>
<li><a class="reference internal" href="#litestar-plugin-design">6. Litestar Plugin Design</a><ul>
<li><a class="reference internal" href="#plugin-implementation">6.1 Plugin Implementation</a></li>
<li><a class="reference internal" href="#middleware-implementation">6.2 Middleware Implementation</a></li>
<li><a class="reference internal" href="#litestar-adapter">6.3 Litestar Adapter</a></li>
<li><a class="reference internal" href="#toolbar-route-handlers">6.4 Toolbar Route Handlers</a></li>
<li><a class="reference internal" href="#litestar-routes-panel">6.5 Litestar Routes Panel</a></li>
</ul>
</li>
<li><a class="reference internal" href="#advanced-alchemy-integration">7. Advanced-Alchemy Integration</a><ul>
<li><a class="reference internal" href="#sqlalchemy-panel">7.1 SQLAlchemy Panel</a></li>
<li><a class="reference internal" href="#advanced-alchemy-event-hooks">7.2 Advanced-Alchemy Event Hooks</a></li>
<li><a class="reference internal" href="#integration-with-litestar-plugin">7.3 Integration with Litestar Plugin</a></li>
</ul>
</li>
<li><a class="reference internal" href="#data-flow">8. Data Flow</a><ul>
<li><a class="reference internal" href="#request-lifecycle">8.1 Request Lifecycle</a></li>
<li><a class="reference internal" href="#panel-data-collection">8.2 Panel Data Collection</a></li>
<li><a class="reference internal" href="#storage-architecture">8.3 Storage Architecture</a></li>
</ul>
</li>
<li><a class="reference internal" href="#security-considerations">9. Security Considerations</a><ul>
<li><a class="reference internal" href="#access-control">9.1 Access Control</a></li>
<li><a class="reference internal" href="#configuration-best-practices">9.2 Configuration Best Practices</a></li>
<li><a class="reference internal" href="#data-sanitization">9.3 Data Sanitization</a></li>
</ul>
</li>
<li><a class="reference internal" href="#performance-considerations">10. Performance Considerations</a><ul>
<li><a class="reference internal" href="#overhead-analysis">10.1 Overhead Analysis</a></li>
<li><a class="reference internal" href="#optimization-strategies">10.2 Optimization Strategies</a></li>
<li><a class="reference internal" href="#memory-usage">10.3 Memory Usage</a></li>
<li><a class="reference internal" href="#profiling-panel-impact">10.4 Profiling Panel Impact</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementation-roadmap">11. Implementation Roadmap</a><ul>
<li><a class="reference internal" href="#phase-1-core-foundation-week-1-2">Phase 1: Core Foundation (Week 1-2)</a></li>
<li><a class="reference internal" href="#phase-2-built-in-panels-week-2-3">Phase 2: Built-in Panels (Week 2-3)</a></li>
<li><a class="reference internal" href="#phase-3-litestar-integration-week-3-4">Phase 3: Litestar Integration (Week 3-4)</a></li>
<li><a class="reference internal" href="#phase-4-advanced-features-week-4-5">Phase 4: Advanced Features (Week 4-5)</a></li>
<li><a class="reference internal" href="#phase-5-ui-ux-week-5-6">Phase 5: UI/UX (Week 5-6)</a></li>
<li><a class="reference internal" href="#phase-6-testing-documentation-week-6-7">Phase 6: Testing &amp; Documentation (Week 6-7)</a></li>
<li><a class="reference internal" href="#phase-7-polish-release-week-7-8">Phase 7: Polish &amp; Release (Week 7-8)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#appendix-a-api-quick-reference">Appendix A: API Quick Reference</a><ul>
<li><a class="reference internal" href="#toolbar-configuration">Toolbar Configuration</a></li>
<li><a class="reference internal" href="#litestar-integration">Litestar Integration</a></li>
<li><a class="reference internal" href="#custom-panel">Custom Panel</a></li>
<li><a class="reference internal" href="#id1">Advanced-Alchemy Integration</a></li>
</ul>
</li>
<li><a class="reference internal" href="#appendix-b-template-structure">Appendix B: Template Structure</a><ul>
<li><a class="reference internal" href="#base-toolbar-template">Base Toolbar Template</a></li>
</ul>
</li>
</ul>
</div><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div></div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="sy-main w-full max-sm:max-w-full print:pt-6">
<div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-lucide menu"></i>
      </button>
    </div>
    <ol class="flex-1" itemscope itemtype="https://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../index.html"><span itemprop="name">Async Debug Toolbar</span></a>
        <span>/</span>
        <meta itemprop="position" content="1" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <strong itemprop="name">Async Python Debug Toolbar - Architecture Document</strong>
        <meta itemprop="position" content="2" />
      </li></ol>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-lucide outdent"></i>
      </button>
    </div>
  </div>
</div><div class="flex flex-col break-words justify-between">
      <div class="min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
        <article class="yue" role="main">
          <section id="async-python-debug-toolbar-architecture-document">
<h1>Async Python Debug Toolbar - Architecture Document<a class="headerlink" href="#async-python-debug-toolbar-architecture-document" title="Link to this heading">¶</a></h1>
<p><strong>Version:</strong> 1.0.0
<strong>Status:</strong> Proposed
<strong>Author:</strong> Architecture Agent
<strong>Date:</strong> 2025-11-26</p>
<hr class="docutils" />
<section id="table-of-contents">
<h2>Table of Contents<a class="headerlink" href="#table-of-contents" title="Link to this heading">¶</a></h2>
<ol class="arabic simple">
<li><p><a class="reference internal" href="#1-overview"><span class="xref myst">Overview</span></a></p></li>
<li><p><a class="reference internal" href="#2-package-structure"><span class="xref myst">Package Structure</span></a></p></li>
<li><p><a class="reference internal" href="#3-core-components"><span class="xref myst">Core Components</span></a></p></li>
<li><p><a class="reference internal" href="#4-built-in-panels"><span class="xref myst">Built-in Panels</span></a></p></li>
<li><p><a class="reference internal" href="#5-extension-points"><span class="xref myst">Extension Points</span></a></p></li>
<li><p><a class="reference internal" href="#6-litestar-plugin-design"><span class="xref myst">Litestar Plugin Design</span></a></p></li>
<li><p><a class="reference internal" href="#7-advanced-alchemy-integration"><span class="xref myst">Advanced-Alchemy Integration</span></a></p></li>
<li><p><a class="reference internal" href="#8-data-flow"><span class="xref myst">Data Flow</span></a></p></li>
<li><p><a class="reference internal" href="#9-security-considerations"><span class="xref myst">Security Considerations</span></a></p></li>
<li><p><a class="reference internal" href="#10-performance-considerations"><span class="xref myst">Performance Considerations</span></a></p></li>
<li><p><a class="reference internal" href="#11-implementation-roadmap"><span class="xref myst">Implementation Roadmap</span></a></p></li>
</ol>
</section>
<hr class="docutils" />
<section id="overview">
<h2>1. Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<section id="purpose">
<h3>1.1 Purpose<a class="headerlink" href="#purpose" title="Link to this heading">¶</a></h3>
<p>The Async Python Debug Toolbar provides real-time debugging and profiling capabilities for async Python web applications. It consists of two packages:</p>
<ol class="arabic simple">
<li><p><strong>async-debug-toolbar</strong> (core): Framework-agnostic debug toolbar with async-first design</p></li>
<li><p><strong>litestar-debug-toolbar</strong> (plugin): Thin integration layer for Litestar applications</p></li>
</ol>
</section>
<section id="design-goals">
<h3>1.2 Design Goals<a class="headerlink" href="#design-goals" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><strong>Async-Native</strong>: Built from the ground up for async/await patterns</p></li>
<li><p><strong>Framework-Agnostic Core</strong>: Core package has no framework dependencies</p></li>
<li><p><strong>Pluggable Panels</strong>: Easy to add, remove, or customize panels</p></li>
<li><p><strong>Minimal Overhead</strong>: Negligible performance impact in production (disabled state)</p></li>
<li><p><strong>Type-Safe</strong>: Full type annotations with strict mypy/ty compliance</p></li>
<li><p><strong>Modern Python</strong>: Requires Python 3.11+ for optimal async performance</p></li>
</ul>
</section>
<section id="architecture-principles">
<h3>1.3 Architecture Principles<a class="headerlink" href="#architecture-principles" title="Link to this heading">¶</a></h3>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Principle</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Separation of Concerns</p></td>
<td><p>Core toolbar logic separate from framework integration</p></td>
</tr>
<tr class="row-odd"><td><p>Dependency Injection</p></td>
<td><p>Panels receive context, not global state</p></td>
</tr>
<tr class="row-even"><td><p>Async Context Propagation</p></td>
<td><p>Use contextvars for request-scoped data</p></td>
</tr>
<tr class="row-odd"><td><p>Lazy Evaluation</p></td>
<td><p>Panels compute data only when accessed</p></td>
</tr>
<tr class="row-even"><td><p>LRU Caching</p></td>
<td><p>Bounded memory usage for toolbar data storage</p></td>
</tr>
</tbody>
</table>
</div>
</section>
</section>
<hr class="docutils" />
<section id="package-structure">
<h2>2. Package Structure<a class="headerlink" href="#package-structure" title="Link to this heading">¶</a></h2>
<section id="repository-layout">
<h3>2.1 Repository Layout<a class="headerlink" href="#repository-layout" title="Link to this heading">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span data-line="1">async-python-debug-toolbar/
</span><span data-line="2">├── src/
</span><span data-line="3">│   ├── async_debug_toolbar/          # Core package
</span><span data-line="4">│   │   ├── __init__.py
</span><span data-line="5">│   │   ├── py.typed
</span><span data-line="6">│   │   ├── toolbar.py                # DebugToolbar manager
</span><span data-line="7">│   │   ├── panel.py                  # Base Panel class
</span><span data-line="8">│   │   ├── config.py                 # Settings system
</span><span data-line="9">│   │   ├── storage.py                # LRU cache storage
</span><span data-line="10">│   │   ├── context.py                # Request context (contextvars)
</span><span data-line="11">│   │   ├── rendering/
</span><span data-line="12">│   │   │   ├── __init__.py
</span><span data-line="13">│   │   │   ├── engine.py             # Template engine abstraction
</span><span data-line="14">│   │   │   ├── jinja.py              # Jinja2 implementation
</span><span data-line="15">│   │   │   └── templates/            # Default HTML templates
</span><span data-line="16">│   │   ├── assets/
</span><span data-line="17">│   │   │   ├── css/
</span><span data-line="18">│   │   │   └── js/
</span><span data-line="19">│   │   ├── panels/
</span><span data-line="20">│   │   │   ├── __init__.py
</span><span data-line="21">│   │   │   ├── timer.py
</span><span data-line="22">│   │   │   ├── request.py
</span><span data-line="23">│   │   │   ├── response.py
</span><span data-line="24">│   │   │   ├── logging.py
</span><span data-line="25">│   │   │   ├── profiling.py
</span><span data-line="26">│   │   │   ├── versions.py
</span><span data-line="27">│   │   │   └── routes.py
</span><span data-line="28">│   │   ├── adapters/
</span><span data-line="29">│   │   │   ├── __init__.py
</span><span data-line="30">│   │   │   └── base.py               # Abstract ASGI adapter
</span><span data-line="31">│   │   └── utils/
</span><span data-line="32">│   │       ├── __init__.py
</span><span data-line="33">│   │       ├── timing.py
</span><span data-line="34">│   │       └── formatting.py
</span><span data-line="35">│   │
</span><span data-line="36">│   └── litestar_debug_toolbar/       # Litestar plugin package
</span><span data-line="37">│       ├── __init__.py
</span><span data-line="38">│       ├── py.typed
</span><span data-line="39">│       ├── plugin.py                 # LitestarDebugToolbarPlugin
</span><span data-line="40">│       ├── middleware.py             # LitestarDebugToolbarMiddleware
</span><span data-line="41">│       ├── adapter.py                # Litestar ASGI adapter
</span><span data-line="42">│       ├── config.py                 # Litestar-specific config
</span><span data-line="43">│       └── panels/
</span><span data-line="44">│           └── routes.py             # Litestar routes panel
</span><span data-line="45">│
</span><span data-line="46">├── extras/
</span><span data-line="47">│   └── advanced_alchemy/             # Optional AA integration
</span><span data-line="48">│       ├── __init__.py
</span><span data-line="49">│       ├── panel.py                  # SQLAlchemyPanel
</span><span data-line="50">│       └── hooks.py                  # Session event hooks
</span><span data-line="51">│
</span><span data-line="52">├── tests/
</span><span data-line="53">│   ├── unit/
</span><span data-line="54">│   ├── integration/
</span><span data-line="55">│   └── conftest.py
</span><span data-line="56">│
</span><span data-line="57">├── docs/
</span><span data-line="58">│   ├── architecture/
</span><span data-line="59">│   └── api/
</span><span data-line="60">│
</span><span data-line="61">├── pyproject.toml
</span><span data-line="62">├── Makefile
</span><span data-line="63">└── README.md
</span></pre></div>
</div>
</section>
<section id="package-dependencies">
<h3>2.2 Package Dependencies<a class="headerlink" href="#package-dependencies" title="Link to this heading">¶</a></h3>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># pyproject.toml - Core package</span>
</span><span data-line="2"><span class="k">[project]</span>
</span><span data-line="3"><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;async-debug-toolbar&quot;</span>
</span><span data-line="4"><span class="n">requires-python</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&gt;=3.11&quot;</span>
</span><span data-line="5"><span class="n">dependencies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
</span><span data-line="6"><span class="w">    </span><span class="s2">&quot;jinja2&gt;=3.1&quot;</span><span class="p">,</span>
</span><span data-line="7"><span class="w">    </span><span class="s2">&quot;markupsafe&gt;=2.1&quot;</span><span class="p">,</span>
</span><span data-line="8"><span class="p">]</span>
</span><span data-line="9">
</span><span data-line="10"><span class="k">[project.optional-dependencies]</span>
</span><span data-line="11"><span class="n">litestar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;litestar-debug-toolbar&quot;</span><span class="p">]</span>
</span><span data-line="12"><span class="n">sqlalchemy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;async-debug-toolbar[advanced-alchemy]&quot;</span><span class="p">]</span>
</span><span data-line="13"><span class="n">advanced-alchemy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
</span><span data-line="14"><span class="w">    </span><span class="s2">&quot;advanced-alchemy&gt;=0.10&quot;</span><span class="p">,</span>
</span><span data-line="15"><span class="w">    </span><span class="s2">&quot;sqlalchemy&gt;=2.0&quot;</span><span class="p">,</span>
</span><span data-line="16"><span class="p">]</span>
</span><span data-line="17">
</span><span data-line="18"><span class="c1"># Litestar plugin package</span>
</span><span data-line="19"><span class="k">[project]</span>
</span><span data-line="20"><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;litestar-debug-toolbar&quot;</span>
</span><span data-line="21"><span class="n">dependencies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
</span><span data-line="22"><span class="w">    </span><span class="s2">&quot;async-debug-toolbar&gt;=1.0&quot;</span><span class="p">,</span>
</span><span data-line="23"><span class="w">    </span><span class="s2">&quot;litestar&gt;=2.0&quot;</span><span class="p">,</span>
</span><span data-line="24"><span class="p">]</span>
</span></pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="core-components">
<h2>3. Core Components<a class="headerlink" href="#core-components" title="Link to this heading">¶</a></h2>
<section id="debugtoolbar-manager">
<h3>3.1 DebugToolbar Manager<a class="headerlink" href="#debugtoolbar-manager" title="Link to this heading">¶</a></h3>
<p>The central orchestrator managing panel lifecycle and data collection.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># src/async_debug_toolbar/toolbar.py</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span data-line="3">
</span><span data-line="4"><span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
</span><span data-line="5"><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrderedDict</span>
</span><span data-line="6"><span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">lru_cache</span>
</span><span data-line="7"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Sequence</span>
</span><span data-line="8">
</span><span data-line="9"><span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">DebugToolbarConfig</span>
</span><span data-line="10"><span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.context</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_request_context</span><span class="p">,</span> <span class="n">set_request_context</span>
</span><span data-line="11"><span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.storage</span><span class="w"> </span><span class="kn">import</span> <span class="n">ToolbarStorage</span>
</span><span data-line="12">
</span><span data-line="13"><span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="14">    <span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.panel</span><span class="w"> </span><span class="kn">import</span> <span class="n">Panel</span>
</span><span data-line="15">    <span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.adapters.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">ASGIAdapter</span>
</span><span data-line="16">
</span><span data-line="17">
</span><span data-line="18"><span class="k">class</span><span class="w"> </span><span class="nc">DebugToolbar</span><span class="p">:</span>
</span><span data-line="19"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Main debug toolbar manager.</span>
</span><span data-line="20">
</span><span data-line="21"><span class="sd">    Responsibilities:</span>
</span><span data-line="22"><span class="sd">    - Panel lifecycle management (create, enable/disable, destroy)</span>
</span><span data-line="23"><span class="sd">    - Request context initialization</span>
</span><span data-line="24"><span class="sd">    - Data collection orchestration</span>
</span><span data-line="25"><span class="sd">    - Toolbar rendering coordination</span>
</span><span data-line="26"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="27">
</span><span data-line="28">    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="29">        <span class="s2">&quot;_config&quot;</span><span class="p">,</span>
</span><span data-line="30">        <span class="s2">&quot;_storage&quot;</span><span class="p">,</span>
</span><span data-line="31">        <span class="s2">&quot;_panels&quot;</span><span class="p">,</span>
</span><span data-line="32">        <span class="s2">&quot;_adapter&quot;</span><span class="p">,</span>
</span><span data-line="33">        <span class="s2">&quot;_request_id&quot;</span><span class="p">,</span>
</span><span data-line="34">    <span class="p">)</span>
</span><span data-line="35">
</span><span data-line="36">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="37">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="38">        <span class="n">config</span><span class="p">:</span> <span class="n">DebugToolbarConfig</span><span class="p">,</span>
</span><span data-line="39">        <span class="n">adapter</span><span class="p">:</span> <span class="n">ASGIAdapter</span><span class="p">,</span>
</span><span data-line="40">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="41">        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">config</span>
</span><span data-line="42">        <span class="bp">self</span><span class="o">.</span><span class="n">_adapter</span> <span class="o">=</span> <span class="n">adapter</span>
</span><span data-line="43">        <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span> <span class="o">=</span> <span class="n">ToolbarStorage</span><span class="p">(</span><span class="n">max_size</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_history</span><span class="p">)</span>
</span><span data-line="44">        <span class="bp">self</span><span class="o">.</span><span class="n">_panels</span><span class="p">:</span> <span class="n">OrderedDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Panel</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
</span><span data-line="45">        <span class="bp">self</span><span class="o">.</span><span class="n">_request_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="46">
</span><span data-line="47">        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_panels</span><span class="p">()</span>
</span><span data-line="48">
</span><span data-line="49">    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_panels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="50"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Load and instantiate configured panels.&quot;&quot;&quot;</span>
</span><span data-line="51">        <span class="k">for</span> <span class="n">panel_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">panels</span><span class="p">:</span>
</span><span data-line="52">            <span class="n">panel_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_panel_class</span><span class="p">(</span><span class="n">panel_path</span><span class="p">)</span>
</span><span data-line="53">            <span class="n">panel</span> <span class="o">=</span> <span class="n">panel_class</span><span class="p">(</span><span class="n">toolbar</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">)</span>
</span><span data-line="54">            <span class="bp">self</span><span class="o">.</span><span class="n">_panels</span><span class="p">[</span><span class="n">panel</span><span class="o">.</span><span class="n">panel_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">panel</span>
</span><span data-line="55">
</span><span data-line="56">    <span class="nd">@staticmethod</span>
</span><span data-line="57">    <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
</span><span data-line="58">    <span class="k">def</span><span class="w"> </span><span class="nf">_load_panel_class</span><span class="p">(</span><span class="n">panel_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">type</span><span class="p">[</span><span class="n">Panel</span><span class="p">]:</span>
</span><span data-line="59"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Dynamically load panel class from dotted path.&quot;&quot;&quot;</span>
</span><span data-line="60">        <span class="n">module_path</span><span class="p">,</span> <span class="n">class_name</span> <span class="o">=</span> <span class="n">panel_path</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span data-line="61">        <span class="n">module</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">module_path</span><span class="p">,</span> <span class="n">fromlist</span><span class="o">=</span><span class="p">[</span><span class="n">class_name</span><span class="p">])</span>
</span><span data-line="62">        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>
</span><span data-line="63">
</span><span data-line="64">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="65"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize context for a new request. Returns request_id.&quot;&quot;&quot;</span>
</span><span data-line="66">        <span class="bp">self</span><span class="o">.</span><span class="n">_request_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
</span><span data-line="67">
</span><span data-line="68">        <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span>
</span><span data-line="69">            <span class="s2">&quot;request_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request_id</span><span class="p">,</span>
</span><span data-line="70">            <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="n">scope</span><span class="p">,</span>
</span><span data-line="71">            <span class="s2">&quot;panels_data&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span data-line="72">            <span class="s2">&quot;start_time&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="73">            <span class="s2">&quot;end_time&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="74">        <span class="p">}</span>
</span><span data-line="75">        <span class="n">set_request_context</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
</span><span data-line="76">
</span><span data-line="77">        <span class="k">for</span> <span class="n">panel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_panels</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span data-line="78">            <span class="k">if</span> <span class="n">panel</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
</span><span data-line="79">                <span class="k">await</span> <span class="n">panel</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
</span><span data-line="80">
</span><span data-line="81">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request_id</span>
</span><span data-line="82">
</span><span data-line="83">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_response</span><span class="p">(</span>
</span><span data-line="84">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="85">        <span class="n">scope</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span data-line="86">        <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span data-line="87">        <span class="n">headers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]],</span>
</span><span data-line="88">        <span class="n">body</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
</span><span data-line="89">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="90"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Finalize data collection after response.&quot;&quot;&quot;</span>
</span><span data-line="91">        <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_request_context</span><span class="p">()</span>
</span><span data-line="92">        <span class="k">if</span> <span class="n">ctx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="93">            <span class="k">return</span>
</span><span data-line="94">
</span><span data-line="95">        <span class="k">for</span> <span class="n">panel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_panels</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span data-line="96">            <span class="k">if</span> <span class="n">panel</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
</span><span data-line="97">                <span class="k">await</span> <span class="n">panel</span><span class="o">.</span><span class="n">process_response</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
</span><span data-line="98">
</span><span data-line="99">        <span class="c1"># Store collected data</span>
</span><span data-line="100">        <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">store</span><span class="p">(</span>
</span><span data-line="101">            <span class="n">request_id</span><span class="o">=</span><span class="n">ctx</span><span class="p">[</span><span class="s2">&quot;request_id&quot;</span><span class="p">],</span>
</span><span data-line="102">            <span class="n">data</span><span class="o">=</span><span class="p">{</span>
</span><span data-line="103">                <span class="s2">&quot;panels&quot;</span><span class="p">:</span> <span class="n">ctx</span><span class="p">[</span><span class="s2">&quot;panels_data&quot;</span><span class="p">],</span>
</span><span data-line="104">                <span class="s2">&quot;start_time&quot;</span><span class="p">:</span> <span class="n">ctx</span><span class="p">[</span><span class="s2">&quot;start_time&quot;</span><span class="p">],</span>
</span><span data-line="105">                <span class="s2">&quot;end_time&quot;</span><span class="p">:</span> <span class="n">ctx</span><span class="p">[</span><span class="s2">&quot;end_time&quot;</span><span class="p">],</span>
</span><span data-line="106">                <span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="n">status_code</span><span class="p">,</span>
</span><span data-line="107">                <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">scope</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">),</span>
</span><span data-line="108">                <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">scope</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;method&quot;</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">),</span>
</span><span data-line="109">            <span class="p">},</span>
</span><span data-line="110">        <span class="p">)</span>
</span><span data-line="111">
</span><span data-line="112">    <span class="k">def</span><span class="w"> </span><span class="nf">get_panel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">panel_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Panel</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="113"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve panel by ID.&quot;&quot;&quot;</span>
</span><span data-line="114">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_panels</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">panel_id</span><span class="p">)</span>
</span><span data-line="115">
</span><span data-line="116">    <span class="k">def</span><span class="w"> </span><span class="nf">get_panels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Panel</span><span class="p">]:</span>
</span><span data-line="117"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all panels in order.&quot;&quot;&quot;</span>
</span><span data-line="118">        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_panels</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span data-line="119">
</span><span data-line="120">    <span class="nd">@property</span>
</span><span data-line="121">    <span class="k">def</span><span class="w"> </span><span class="nf">storage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolbarStorage</span><span class="p">:</span>
</span><span data-line="122"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Access toolbar storage.&quot;&quot;&quot;</span>
</span><span data-line="123">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span>
</span><span data-line="124">
</span><span data-line="125">    <span class="nd">@property</span>
</span><span data-line="126">    <span class="k">def</span><span class="w"> </span><span class="nf">config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DebugToolbarConfig</span><span class="p">:</span>
</span><span data-line="127"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Access toolbar configuration.&quot;&quot;&quot;</span>
</span><span data-line="128">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span>
</span><span data-line="129">
</span><span data-line="130">    <span class="nd">@property</span>
</span><span data-line="131">    <span class="k">def</span><span class="w"> </span><span class="nf">adapter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ASGIAdapter</span><span class="p">:</span>
</span><span data-line="132"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Access framework adapter.&quot;&quot;&quot;</span>
</span><span data-line="133">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adapter</span>
</span></pre></div>
</div>
</section>
<section id="base-panel-class">
<h3>3.2 Base Panel Class<a class="headerlink" href="#base-panel-class" title="Link to this heading">¶</a></h3>
<p>Abstract base class defining the panel interface.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># src/async_debug_toolbar/panel.py</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span data-line="3">
</span><span data-line="4"><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
</span><span data-line="5"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">ClassVar</span>
</span><span data-line="6">
</span><span data-line="7"><span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.context</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_request_context</span>
</span><span data-line="8">
</span><span data-line="9"><span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="10">    <span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.toolbar</span><span class="w"> </span><span class="kn">import</span> <span class="n">DebugToolbar</span>
</span><span data-line="11">    <span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">DebugToolbarConfig</span>
</span><span data-line="12">
</span><span data-line="13">
</span><span data-line="14"><span class="k">class</span><span class="w"> </span><span class="nc">Panel</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
</span><span data-line="15"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract base class for debug toolbar panels.</span>
</span><span data-line="16">
</span><span data-line="17"><span class="sd">    Lifecycle:</span>
</span><span data-line="18"><span class="sd">    1. __init__: Panel instantiation (once per toolbar)</span>
</span><span data-line="19"><span class="sd">    2. process_request: Called at request start</span>
</span><span data-line="20"><span class="sd">    3. process_response: Called after response</span>
</span><span data-line="21"><span class="sd">    4. generate_stats: Compute panel statistics</span>
</span><span data-line="22"><span class="sd">    5. generate_server_timing: Generate Server-Timing header value</span>
</span><span data-line="23"><span class="sd">    6. render: Generate panel HTML</span>
</span><span data-line="24"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="25">
</span><span data-line="26">    <span class="c1"># Class-level configuration</span>
</span><span data-line="27">    <span class="n">panel_id</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span data-line="28">    <span class="n">title</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span data-line="29">    <span class="n">template</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span data-line="30">
</span><span data-line="31">    <span class="c1"># Whether panel is enabled by default</span>
</span><span data-line="32">    <span class="n">default_enabled</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="33">
</span><span data-line="34">    <span class="c1"># Panel ordering weight (lower = earlier)</span>
</span><span data-line="35">    <span class="n">weight</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>
</span><span data-line="36">
</span><span data-line="37">    <span class="c1"># Scripts to include in rendered toolbar</span>
</span><span data-line="38">    <span class="n">scripts</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="39">
</span><span data-line="40">    <span class="c1"># Styles to include in rendered toolbar</span>
</span><span data-line="41">    <span class="n">styles</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="42">
</span><span data-line="43">    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;_toolbar&quot;</span><span class="p">,</span> <span class="s2">&quot;_config&quot;</span><span class="p">,</span> <span class="s2">&quot;_enabled&quot;</span><span class="p">)</span>
</span><span data-line="44">
</span><span data-line="45">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="46">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="47">        <span class="n">toolbar</span><span class="p">:</span> <span class="n">DebugToolbar</span><span class="p">,</span>
</span><span data-line="48">        <span class="n">config</span><span class="p">:</span> <span class="n">DebugToolbarConfig</span><span class="p">,</span>
</span><span data-line="49">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="50">        <span class="bp">self</span><span class="o">.</span><span class="n">_toolbar</span> <span class="o">=</span> <span class="n">toolbar</span>
</span><span data-line="51">        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">config</span>
</span><span data-line="52">        <span class="bp">self</span><span class="o">.</span><span class="n">_enabled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_enabled</span>
</span><span data-line="53">
</span><span data-line="54">    <span class="nd">@property</span>
</span><span data-line="55">    <span class="k">def</span><span class="w"> </span><span class="nf">enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="56"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if panel is enabled.&quot;&quot;&quot;</span>
</span><span data-line="57">        <span class="n">panel_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">panel_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">panel_id</span><span class="p">,</span> <span class="p">{})</span>
</span><span data-line="58">        <span class="k">return</span> <span class="n">panel_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enabled&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enabled</span><span class="p">)</span>
</span><span data-line="59">
</span><span data-line="60">    <span class="nd">@enabled</span><span class="o">.</span><span class="n">setter</span>
</span><span data-line="61">    <span class="k">def</span><span class="w"> </span><span class="nf">enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="62"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set panel enabled state.&quot;&quot;&quot;</span>
</span><span data-line="63">        <span class="bp">self</span><span class="o">.</span><span class="n">_enabled</span> <span class="o">=</span> <span class="n">value</span>
</span><span data-line="64">
</span><span data-line="65">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="66"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Hook called at request start. Override to collect request data.&quot;&quot;&quot;</span>
</span><span data-line="67">        <span class="k">pass</span>
</span><span data-line="68">
</span><span data-line="69">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_response</span><span class="p">(</span>
</span><span data-line="70">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="71">        <span class="n">scope</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span data-line="72">        <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span data-line="73">        <span class="n">headers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]],</span>
</span><span data-line="74">        <span class="n">body</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
</span><span data-line="75">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="76"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Hook called after response. Override to collect response data.&quot;&quot;&quot;</span>
</span><span data-line="77">        <span class="k">pass</span>
</span><span data-line="78">
</span><span data-line="79">    <span class="nd">@abstractmethod</span>
</span><span data-line="80">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span data-line="81"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate statistics for this panel.</span>
</span><span data-line="82">
</span><span data-line="83"><span class="sd">        Returns:</span>
</span><span data-line="84"><span class="sd">            Dictionary of statistics to be stored and rendered.</span>
</span><span data-line="85"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="86">        <span class="o">...</span>
</span><span data-line="87">
</span><span data-line="88">    <span class="k">def</span><span class="w"> </span><span class="nf">generate_server_timing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="89"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate Server-Timing header value for this panel.</span>
</span><span data-line="90">
</span><span data-line="91"><span class="sd">        Returns:</span>
</span><span data-line="92"><span class="sd">            Server-Timing metric string or None if not applicable.</span>
</span><span data-line="93"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="94">        <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="95">
</span><span data-line="96">    <span class="k">def</span><span class="w"> </span><span class="nf">record_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stats</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="97"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Store statistics in request context.&quot;&quot;&quot;</span>
</span><span data-line="98">        <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_request_context</span><span class="p">()</span>
</span><span data-line="99">        <span class="k">if</span> <span class="n">ctx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="100">            <span class="n">ctx</span><span class="p">[</span><span class="s2">&quot;panels_data&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">panel_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span>
</span><span data-line="101">
</span><span data-line="102">    <span class="k">def</span><span class="w"> </span><span class="nf">get_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span data-line="103"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve stored statistics from context.&quot;&quot;&quot;</span>
</span><span data-line="104">        <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_request_context</span><span class="p">()</span>
</span><span data-line="105">        <span class="k">if</span> <span class="n">ctx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="106">            <span class="k">return</span> <span class="p">{}</span>
</span><span data-line="107">        <span class="k">return</span> <span class="n">ctx</span><span class="p">[</span><span class="s2">&quot;panels_data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">panel_id</span><span class="p">,</span> <span class="p">{})</span>
</span><span data-line="108">
</span><span data-line="109">    <span class="nd">@property</span>
</span><span data-line="110">    <span class="k">def</span><span class="w"> </span><span class="nf">nav_title</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="111"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Title shown in toolbar navigation.&quot;&quot;&quot;</span>
</span><span data-line="112">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span>
</span><span data-line="113">
</span><span data-line="114">    <span class="nd">@property</span>
</span><span data-line="115">    <span class="k">def</span><span class="w"> </span><span class="nf">nav_subtitle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="116"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Subtitle shown in toolbar navigation (e.g., timing).&quot;&quot;&quot;</span>
</span><span data-line="117">        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
</span><span data-line="118">
</span><span data-line="119">    <span class="nd">@property</span>
</span><span data-line="120">    <span class="k">def</span><span class="w"> </span><span class="nf">has_content</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="121"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Whether panel has content to display.&quot;&quot;&quot;</span>
</span><span data-line="122">        <span class="k">return</span> <span class="kc">True</span>
</span><span data-line="123">
</span><span data-line="124">    <span class="k">def</span><span class="w"> </span><span class="nf">get_template_context</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span data-line="125"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get context for template rendering.&quot;&quot;&quot;</span>
</span><span data-line="126">        <span class="k">return</span> <span class="p">{</span>
</span><span data-line="127">            <span class="s2">&quot;panel&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span>
</span><span data-line="128">            <span class="s2">&quot;stats&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stats</span><span class="p">(),</span>
</span><span data-line="129">        <span class="p">}</span>
</span></pre></div>
</div>
</section>
<section id="configuration-system">
<h3>3.3 Configuration System<a class="headerlink" href="#configuration-system" title="Link to this heading">¶</a></h3>
<p>Dataclass-based configuration with sensible defaults.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># src/async_debug_toolbar/config.py</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span data-line="3">
</span><span data-line="4"><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
</span><span data-line="5"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span>
</span><span data-line="6">
</span><span data-line="7">
</span><span data-line="8"><span class="c1"># Default panels in display order</span>
</span><span data-line="9"><span class="n">DEFAULT_PANELS</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="10">    <span class="s2">&quot;async_debug_toolbar.panels.timer.TimerPanel&quot;</span><span class="p">,</span>
</span><span data-line="11">    <span class="s2">&quot;async_debug_toolbar.panels.request.RequestPanel&quot;</span><span class="p">,</span>
</span><span data-line="12">    <span class="s2">&quot;async_debug_toolbar.panels.response.ResponsePanel&quot;</span><span class="p">,</span>
</span><span data-line="13">    <span class="s2">&quot;async_debug_toolbar.panels.logging.LoggingPanel&quot;</span><span class="p">,</span>
</span><span data-line="14">    <span class="s2">&quot;async_debug_toolbar.panels.versions.VersionsPanel&quot;</span><span class="p">,</span>
</span><span data-line="15">    <span class="s2">&quot;async_debug_toolbar.panels.routes.RoutesPanel&quot;</span><span class="p">,</span>
</span><span data-line="16"><span class="p">]</span>
</span><span data-line="17">
</span><span data-line="18">
</span><span data-line="19"><span class="nd">@dataclass</span>
</span><span data-line="20"><span class="k">class</span><span class="w"> </span><span class="nc">DebugToolbarConfig</span><span class="p">:</span>
</span><span data-line="21"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration for the debug toolbar.</span>
</span><span data-line="22">
</span><span data-line="23"><span class="sd">    Attributes:</span>
</span><span data-line="24"><span class="sd">        enabled: Master switch for toolbar (default: True in DEBUG mode)</span>
</span><span data-line="25"><span class="sd">        panels: List of panel class paths to load</span>
</span><span data-line="26"><span class="sd">        panel_options: Per-panel configuration overrides</span>
</span><span data-line="27"><span class="sd">        max_history: Maximum requests to keep in history (LRU)</span>
</span><span data-line="28"><span class="sd">        show_on_redirects: Show toolbar on redirect responses</span>
</span><span data-line="29"><span class="sd">        intercept_redirects: Intercept and display redirect info</span>
</span><span data-line="30"><span class="sd">        results_cache_size: Size of template rendering cache</span>
</span><span data-line="31"><span class="sd">        root_path: URL path prefix for toolbar endpoints</span>
</span><span data-line="32"><span class="sd">        show_toolbar_callback: Callable to determine if toolbar shows</span>
</span><span data-line="33"><span class="sd">        insert_before: HTML tag before which to insert toolbar</span>
</span><span data-line="34"><span class="sd">        extra_scripts: Additional JS files to include</span>
</span><span data-line="35"><span class="sd">        extra_styles: Additional CSS files to include</span>
</span><span data-line="36"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="37">
</span><span data-line="38">    <span class="n">enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="39">    <span class="n">panels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">DEFAULT_PANELS</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
</span><span data-line="40">    <span class="n">panel_options</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</span><span data-line="41">    <span class="n">max_history</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span>
</span><span data-line="42">    <span class="n">show_on_redirects</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="43">    <span class="n">intercept_redirects</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="44">    <span class="n">results_cache_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span>
</span><span data-line="45">    <span class="n">root_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;/_debug_toolbar&quot;</span>
</span><span data-line="46">    <span class="n">show_toolbar_callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="47">    <span class="n">insert_before</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&lt;/body&gt;&quot;</span>
</span><span data-line="48">    <span class="n">extra_scripts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
</span><span data-line="49">    <span class="n">extra_styles</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
</span><span data-line="50">
</span><span data-line="51">    <span class="c1"># Security settings</span>
</span><span data-line="52">    <span class="n">allowed_hosts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="s2">&quot;localhost&quot;</span><span class="p">])</span>
</span><span data-line="53">    <span class="n">require_local</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="54">
</span><span data-line="55">    <span class="c1"># Performance settings</span>
</span><span data-line="56">    <span class="n">enable_profiling</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="57">    <span class="n">profiling_threshold_ms</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">100.0</span>
</span><span data-line="58">
</span><span data-line="59">    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="60">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
</span><span data-line="61">            <span class="bp">self</span><span class="o">.</span><span class="n">root_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">root_path</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span data-line="62">        <span class="bp">self</span><span class="o">.</span><span class="n">root_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_path</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
</span><span data-line="63">
</span><span data-line="64">    <span class="k">def</span><span class="w"> </span><span class="nf">should_show_toolbar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="65"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine if toolbar should be displayed for this request.&quot;&quot;&quot;</span>
</span><span data-line="66">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
</span><span data-line="67">            <span class="k">return</span> <span class="kc">False</span>
</span><span data-line="68">
</span><span data-line="69">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_toolbar_callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="70">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_toolbar_callback</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
</span><span data-line="71">
</span><span data-line="72">        <span class="c1"># Check for local request if required</span>
</span><span data-line="73">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">require_local</span><span class="p">:</span>
</span><span data-line="74">            <span class="n">client</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;client&quot;</span><span class="p">)</span>
</span><span data-line="75">            <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="76">                <span class="k">return</span> <span class="kc">False</span>
</span><span data-line="77">            <span class="n">client_host</span> <span class="o">=</span> <span class="n">client</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="k">else</span> <span class="n">client</span>
</span><span data-line="78">            <span class="k">if</span> <span class="n">client_host</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_hosts</span><span class="p">:</span>
</span><span data-line="79">                <span class="k">return</span> <span class="kc">False</span>
</span><span data-line="80">
</span><span data-line="81">        <span class="c1"># Skip toolbar&#39;s own requests</span>
</span><span data-line="82">        <span class="n">path</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span data-line="83">        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_path</span><span class="p">):</span>
</span><span data-line="84">            <span class="k">return</span> <span class="kc">False</span>
</span><span data-line="85">
</span><span data-line="86">        <span class="k">return</span> <span class="kc">True</span>
</span><span data-line="87">
</span><span data-line="88">    <span class="k">def</span><span class="w"> </span><span class="nf">add_panel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">panel_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="89"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a panel to the configuration.&quot;&quot;&quot;</span>
</span><span data-line="90">        <span class="k">if</span> <span class="n">panel_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">panels</span><span class="p">:</span>
</span><span data-line="91">            <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="92">                <span class="bp">self</span><span class="o">.</span><span class="n">panels</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">panel_path</span><span class="p">)</span>
</span><span data-line="93">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="94">                <span class="bp">self</span><span class="o">.</span><span class="n">panels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">panel_path</span><span class="p">)</span>
</span><span data-line="95">
</span><span data-line="96">    <span class="k">def</span><span class="w"> </span><span class="nf">remove_panel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">panel_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="97"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove a panel from the configuration.&quot;&quot;&quot;</span>
</span><span data-line="98">        <span class="k">if</span> <span class="n">panel_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">panels</span><span class="p">:</span>
</span><span data-line="99">            <span class="bp">self</span><span class="o">.</span><span class="n">panels</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">panel_path</span><span class="p">)</span>
</span></pre></div>
</div>
</section>
<section id="storage-backend">
<h3>3.4 Storage Backend<a class="headerlink" href="#storage-backend" title="Link to this heading">¶</a></h3>
<p>LRU-based storage for toolbar request history.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># src/async_debug_toolbar/storage.py</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span data-line="3">
</span><span data-line="4"><span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
</span><span data-line="5"><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrderedDict</span>
</span><span data-line="6"><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
</span><span data-line="7"><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
</span><span data-line="8"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>
</span><span data-line="9">
</span><span data-line="10">
</span><span data-line="11"><span class="nd">@dataclass</span>
</span><span data-line="12"><span class="k">class</span><span class="w"> </span><span class="nc">ToolbarRecord</span><span class="p">:</span>
</span><span data-line="13"><span class="w">    </span><span class="sd">&quot;&quot;&quot;A single toolbar record for one request.&quot;&quot;&quot;</span>
</span><span data-line="14">
</span><span data-line="15">    <span class="n">request_id</span><span class="p">:</span> <span class="nb">str</span>
</span><span data-line="16">    <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span>
</span><span data-line="17">    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span>
</span><span data-line="18">    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span>
</span><span data-line="19">    <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span>
</span><span data-line="20">    <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span>
</span><span data-line="21">    <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span>
</span><span data-line="22">    <span class="n">panels_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span data-line="23">
</span><span data-line="24">    <span class="nd">@property</span>
</span><span data-line="25">    <span class="k">def</span><span class="w"> </span><span class="nf">duration_ms</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="26"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Request duration in milliseconds.&quot;&quot;&quot;</span>
</span><span data-line="27">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="28">            <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="29">        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
</span><span data-line="30">
</span><span data-line="31">
</span><span data-line="32"><span class="k">class</span><span class="w"> </span><span class="nc">ToolbarStorage</span><span class="p">:</span>
</span><span data-line="33"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Thread-safe LRU storage for toolbar data.</span>
</span><span data-line="34">
</span><span data-line="35"><span class="sd">    Uses OrderedDict for O(1) access and LRU eviction.</span>
</span><span data-line="36"><span class="sd">    Thread-safe for concurrent access from multiple requests.</span>
</span><span data-line="37"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="38">
</span><span data-line="39">    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;_max_size&quot;</span><span class="p">,</span> <span class="s2">&quot;_data&quot;</span><span class="p">,</span> <span class="s2">&quot;_lock&quot;</span><span class="p">)</span>
</span><span data-line="40">
</span><span data-line="41">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="42">        <span class="bp">self</span><span class="o">.</span><span class="n">_max_size</span> <span class="o">=</span> <span class="n">max_size</span>
</span><span data-line="43">        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span> <span class="n">OrderedDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ToolbarRecord</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
</span><span data-line="44">        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>
</span><span data-line="45">
</span><span data-line="46">    <span class="k">def</span><span class="w"> </span><span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="47"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Store toolbar data for a request.&quot;&quot;&quot;</span>
</span><span data-line="48">        <span class="n">record</span> <span class="o">=</span> <span class="n">ToolbarRecord</span><span class="p">(</span>
</span><span data-line="49">            <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">,</span>
</span><span data-line="50">            <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
</span><span data-line="51">            <span class="n">method</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;method&quot;</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">),</span>
</span><span data-line="52">            <span class="n">path</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">),</span>
</span><span data-line="53">            <span class="n">status_code</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status_code&quot;</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span>
</span><span data-line="54">            <span class="n">start_time</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;start_time&quot;</span><span class="p">),</span>
</span><span data-line="55">            <span class="n">end_time</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;end_time&quot;</span><span class="p">),</span>
</span><span data-line="56">            <span class="n">panels_data</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;panels&quot;</span><span class="p">,</span> <span class="p">{}),</span>
</span><span data-line="57">        <span class="p">)</span>
</span><span data-line="58">
</span><span data-line="59">        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
</span><span data-line="60">            <span class="c1"># Move to end if exists (LRU update)</span>
</span><span data-line="61">            <span class="k">if</span> <span class="n">request_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
</span><span data-line="62">                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">move_to_end</span><span class="p">(</span><span class="n">request_id</span><span class="p">)</span>
</span><span data-line="63">            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">record</span>
</span><span data-line="64">
</span><span data-line="65">            <span class="c1"># Evict oldest if over capacity</span>
</span><span data-line="66">            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_size</span><span class="p">:</span>
</span><span data-line="67">                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">popitem</span><span class="p">(</span><span class="n">last</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span data-line="68">
</span><span data-line="69">    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolbarRecord</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="70"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve toolbar data by request ID.&quot;&quot;&quot;</span>
</span><span data-line="71">        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
</span><span data-line="72">            <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request_id</span><span class="p">)</span>
</span><span data-line="73">            <span class="k">if</span> <span class="n">record</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="74">                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">move_to_end</span><span class="p">(</span><span class="n">request_id</span><span class="p">)</span>
</span><span data-line="75">            <span class="k">return</span> <span class="n">record</span>
</span><span data-line="76">
</span><span data-line="77">    <span class="k">def</span><span class="w"> </span><span class="nf">get_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">ToolbarRecord</span><span class="p">]:</span>
</span><span data-line="78"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get request history, most recent first.&quot;&quot;&quot;</span>
</span><span data-line="79">        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
</span><span data-line="80">            <span class="n">records</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
</span><span data-line="81">            <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="82">                <span class="n">records</span> <span class="o">=</span> <span class="n">records</span><span class="p">[:</span><span class="n">limit</span><span class="p">]</span>
</span><span data-line="83">            <span class="k">return</span> <span class="n">records</span>
</span><span data-line="84">
</span><span data-line="85">    <span class="k">def</span><span class="w"> </span><span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="86"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear all stored data.&quot;&quot;&quot;</span>
</span><span data-line="87">        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
</span><span data-line="88">            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span data-line="89">
</span><span data-line="90">    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span data-line="91">        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
</span><span data-line="92">            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>
</span></pre></div>
</div>
</section>
<section id="request-context">
<h3>3.5 Request Context<a class="headerlink" href="#request-context" title="Link to this heading">¶</a></h3>
<p>Context variable management for request-scoped data.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># src/async_debug_toolbar/context.py</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span data-line="3">
</span><span data-line="4"><span class="kn">from</span><span class="w"> </span><span class="nn">contextvars</span><span class="w"> </span><span class="kn">import</span> <span class="n">ContextVar</span>
</span><span data-line="5"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">TypedDict</span>
</span><span data-line="6">
</span><span data-line="7">
</span><span data-line="8"><span class="k">class</span><span class="w"> </span><span class="nc">RequestContext</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
</span><span data-line="9"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Type definition for request context.&quot;&quot;&quot;</span>
</span><span data-line="10">
</span><span data-line="11">    <span class="n">request_id</span><span class="p">:</span> <span class="nb">str</span>
</span><span data-line="12">    <span class="n">scope</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span data-line="13">    <span class="n">panels_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span data-line="14">    <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span>
</span><span data-line="15">    <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span>
</span><span data-line="16">
</span><span data-line="17">
</span><span data-line="18"><span class="n">_request_context</span><span class="p">:</span> <span class="n">ContextVar</span><span class="p">[</span><span class="n">RequestContext</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">ContextVar</span><span class="p">(</span>
</span><span data-line="19">    <span class="s2">&quot;debug_toolbar_context&quot;</span><span class="p">,</span>
</span><span data-line="20">    <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span data-line="21"><span class="p">)</span>
</span><span data-line="22">
</span><span data-line="23">
</span><span data-line="24"><span class="k">def</span><span class="w"> </span><span class="nf">get_request_context</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">RequestContext</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="25"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the current request context.&quot;&quot;&quot;</span>
</span><span data-line="26">    <span class="k">return</span> <span class="n">_request_context</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span><span data-line="27">
</span><span data-line="28">
</span><span data-line="29"><span class="k">def</span><span class="w"> </span><span class="nf">set_request_context</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">RequestContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="30"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the current request context.&quot;&quot;&quot;</span>
</span><span data-line="31">    <span class="n">_request_context</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
</span><span data-line="32">
</span><span data-line="33">
</span><span data-line="34"><span class="k">def</span><span class="w"> </span><span class="nf">clear_request_context</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="35"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Clear the current request context.&quot;&quot;&quot;</span>
</span><span data-line="36">    <span class="n">_request_context</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span data-line="37">
</span><span data-line="38">
</span><span data-line="39"><span class="k">class</span><span class="w"> </span><span class="nc">RequestContextManager</span><span class="p">:</span>
</span><span data-line="40"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Async context manager for request context lifecycle.&quot;&quot;&quot;</span>
</span><span data-line="41">
</span><span data-line="42">    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;_ctx&quot;</span><span class="p">,</span> <span class="s2">&quot;_token&quot;</span><span class="p">)</span>
</span><span data-line="43">
</span><span data-line="44">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">RequestContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="45">        <span class="bp">self</span><span class="o">.</span><span class="n">_ctx</span> <span class="o">=</span> <span class="n">ctx</span>
</span><span data-line="46">        <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="47">
</span><span data-line="48">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__aenter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RequestContext</span><span class="p">:</span>
</span><span data-line="49">        <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="o">=</span> <span class="n">_request_context</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ctx</span><span class="p">)</span>
</span><span data-line="50">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ctx</span>
</span><span data-line="51">
</span><span data-line="52">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__aexit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="53">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="54">            <span class="n">_request_context</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_token</span><span class="p">)</span>
</span></pre></div>
</div>
</section>
<section id="template-rendering-system">
<h3>3.6 Template/Rendering System<a class="headerlink" href="#template-rendering-system" title="Link to this heading">¶</a></h3>
<p>Jinja2-based rendering with async support.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># src/async_debug_toolbar/rendering/engine.py</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span data-line="3">
</span><span data-line="4"><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
</span><span data-line="5"><span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">lru_cache</span>
</span><span data-line="6"><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
</span><span data-line="7"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span>
</span><span data-line="8">
</span><span data-line="9"><span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="10">    <span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.panel</span><span class="w"> </span><span class="kn">import</span> <span class="n">Panel</span>
</span><span data-line="11">    <span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.toolbar</span><span class="w"> </span><span class="kn">import</span> <span class="n">DebugToolbar</span>
</span><span data-line="12">
</span><span data-line="13">
</span><span data-line="14"><span class="k">class</span><span class="w"> </span><span class="nc">TemplateEngine</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
</span><span data-line="15"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract template engine interface.&quot;&quot;&quot;</span>
</span><span data-line="16">
</span><span data-line="17">    <span class="nd">@abstractmethod</span>
</span><span data-line="18">    <span class="k">def</span><span class="w"> </span><span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="19"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Render a template with context.&quot;&quot;&quot;</span>
</span><span data-line="20">        <span class="o">...</span>
</span><span data-line="21">
</span><span data-line="22">    <span class="nd">@abstractmethod</span>
</span><span data-line="23">    <span class="k">def</span><span class="w"> </span><span class="nf">render_toolbar</span><span class="p">(</span>
</span><span data-line="24">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="25">        <span class="n">toolbar</span><span class="p">:</span> <span class="n">DebugToolbar</span><span class="p">,</span>
</span><span data-line="26">        <span class="n">request_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span data-line="27">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="28"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Render the complete toolbar HTML.&quot;&quot;&quot;</span>
</span><span data-line="29">        <span class="o">...</span>
</span><span data-line="30">
</span><span data-line="31">    <span class="nd">@abstractmethod</span>
</span><span data-line="32">    <span class="k">def</span><span class="w"> </span><span class="nf">render_panel</span><span class="p">(</span>
</span><span data-line="33">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="34">        <span class="n">panel</span><span class="p">:</span> <span class="n">Panel</span><span class="p">,</span>
</span><span data-line="35">        <span class="n">stats</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span data-line="36">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="37"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Render a single panel&#39;s content.&quot;&quot;&quot;</span>
</span><span data-line="38">        <span class="o">...</span>
</span></pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># src/async_debug_toolbar/rendering/jinja.py</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span data-line="3">
</span><span data-line="4"><span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">lru_cache</span>
</span><span data-line="5"><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
</span><span data-line="6"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span>
</span><span data-line="7">
</span><span data-line="8"><span class="kn">from</span><span class="w"> </span><span class="nn">jinja2</span><span class="w"> </span><span class="kn">import</span> <span class="n">Environment</span><span class="p">,</span> <span class="n">FileSystemLoader</span><span class="p">,</span> <span class="n">select_autoescape</span>
</span><span data-line="9"><span class="kn">from</span><span class="w"> </span><span class="nn">markupsafe</span><span class="w"> </span><span class="kn">import</span> <span class="n">Markup</span>
</span><span data-line="10">
</span><span data-line="11"><span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.rendering.engine</span><span class="w"> </span><span class="kn">import</span> <span class="n">TemplateEngine</span>
</span><span data-line="12">
</span><span data-line="13"><span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="14">    <span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.panel</span><span class="w"> </span><span class="kn">import</span> <span class="n">Panel</span>
</span><span data-line="15">    <span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.toolbar</span><span class="w"> </span><span class="kn">import</span> <span class="n">DebugToolbar</span>
</span><span data-line="16">
</span><span data-line="17">
</span><span data-line="18"><span class="n">TEMPLATES_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;templates&quot;</span>
</span><span data-line="19">
</span><span data-line="20">
</span><span data-line="21"><span class="k">class</span><span class="w"> </span><span class="nc">JinjaTemplateEngine</span><span class="p">(</span><span class="n">TemplateEngine</span><span class="p">):</span>
</span><span data-line="22"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Jinja2-based template engine implementation.&quot;&quot;&quot;</span>
</span><span data-line="23">
</span><span data-line="24">    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;_env&quot;</span><span class="p">,</span> <span class="s2">&quot;_cache_size&quot;</span><span class="p">)</span>
</span><span data-line="25">
</span><span data-line="26">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="27">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="28">        <span class="n">templates_dir</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="29">        <span class="n">cache_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span>
</span><span data-line="30">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="31">        <span class="bp">self</span><span class="o">.</span><span class="n">_cache_size</span> <span class="o">=</span> <span class="n">cache_size</span>
</span><span data-line="32">
</span><span data-line="33">        <span class="n">loader</span> <span class="o">=</span> <span class="n">FileSystemLoader</span><span class="p">([</span>
</span><span data-line="34">            <span class="n">templates_dir</span> <span class="ow">or</span> <span class="n">TEMPLATES_DIR</span><span class="p">,</span>
</span><span data-line="35">            <span class="n">TEMPLATES_DIR</span><span class="p">,</span>  <span class="c1"># Fallback to defaults</span>
</span><span data-line="36">        <span class="p">])</span>
</span><span data-line="37">
</span><span data-line="38">        <span class="bp">self</span><span class="o">.</span><span class="n">_env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span>
</span><span data-line="39">            <span class="n">loader</span><span class="o">=</span><span class="n">loader</span><span class="p">,</span>
</span><span data-line="40">            <span class="n">autoescape</span><span class="o">=</span><span class="n">select_autoescape</span><span class="p">([</span><span class="s2">&quot;html&quot;</span><span class="p">,</span> <span class="s2">&quot;xml&quot;</span><span class="p">]),</span>
</span><span data-line="41">            <span class="n">enable_async</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Sync rendering for simplicity</span>
</span><span data-line="42">        <span class="p">)</span>
</span><span data-line="43">
</span><span data-line="44">        <span class="c1"># Register custom filters</span>
</span><span data-line="45">        <span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="s2">&quot;format_bytes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_bytes</span>
</span><span data-line="46">        <span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="s2">&quot;format_duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_duration</span>
</span><span data-line="47">        <span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="s2">&quot;highlight_sql&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_highlight_sql</span>
</span><span data-line="48">
</span><span data-line="49">    <span class="nd">@staticmethod</span>
</span><span data-line="50">    <span class="k">def</span><span class="w"> </span><span class="nf">_format_bytes</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="51"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Format byte size for display.&quot;&quot;&quot;</span>
</span><span data-line="52">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;KB&quot;</span><span class="p">,</span> <span class="s2">&quot;MB&quot;</span><span class="p">,</span> <span class="s2">&quot;GB&quot;</span><span class="p">]:</span>
</span><span data-line="53">            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">:</span>
</span><span data-line="54">                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span data-line="55">            <span class="n">value</span> <span class="o">/=</span> <span class="mi">1024</span>
</span><span data-line="56">        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> TB&quot;</span>
</span><span data-line="57">
</span><span data-line="58">    <span class="nd">@staticmethod</span>
</span><span data-line="59">    <span class="k">def</span><span class="w"> </span><span class="nf">_format_duration</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="60"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Format duration in ms for display.&quot;&quot;&quot;</span>
</span><span data-line="61">        <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span data-line="62">            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">value</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> us&quot;</span>
</span><span data-line="63">        <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
</span><span data-line="64">            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> ms&quot;</span>
</span><span data-line="65">        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">value</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> s&quot;</span>
</span><span data-line="66">
</span><span data-line="67">    <span class="nd">@staticmethod</span>
</span><span data-line="68">    <span class="k">def</span><span class="w"> </span><span class="nf">_highlight_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Markup</span><span class="p">:</span>
</span><span data-line="69"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Basic SQL syntax highlighting.&quot;&quot;&quot;</span>
</span><span data-line="70">        <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="71">            <span class="s2">&quot;SELECT&quot;</span><span class="p">,</span> <span class="s2">&quot;FROM&quot;</span><span class="p">,</span> <span class="s2">&quot;WHERE&quot;</span><span class="p">,</span> <span class="s2">&quot;JOIN&quot;</span><span class="p">,</span> <span class="s2">&quot;LEFT&quot;</span><span class="p">,</span> <span class="s2">&quot;RIGHT&quot;</span><span class="p">,</span> <span class="s2">&quot;INNER&quot;</span><span class="p">,</span>
</span><span data-line="72">            <span class="s2">&quot;OUTER&quot;</span><span class="p">,</span> <span class="s2">&quot;ON&quot;</span><span class="p">,</span> <span class="s2">&quot;AND&quot;</span><span class="p">,</span> <span class="s2">&quot;OR&quot;</span><span class="p">,</span> <span class="s2">&quot;INSERT&quot;</span><span class="p">,</span> <span class="s2">&quot;UPDATE&quot;</span><span class="p">,</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">,</span>
</span><span data-line="73">            <span class="s2">&quot;CREATE&quot;</span><span class="p">,</span> <span class="s2">&quot;DROP&quot;</span><span class="p">,</span> <span class="s2">&quot;ALTER&quot;</span><span class="p">,</span> <span class="s2">&quot;INDEX&quot;</span><span class="p">,</span> <span class="s2">&quot;TABLE&quot;</span><span class="p">,</span> <span class="s2">&quot;INTO&quot;</span><span class="p">,</span> <span class="s2">&quot;VALUES&quot;</span><span class="p">,</span>
</span><span data-line="74">            <span class="s2">&quot;SET&quot;</span><span class="p">,</span> <span class="s2">&quot;ORDER&quot;</span><span class="p">,</span> <span class="s2">&quot;BY&quot;</span><span class="p">,</span> <span class="s2">&quot;GROUP&quot;</span><span class="p">,</span> <span class="s2">&quot;HAVING&quot;</span><span class="p">,</span> <span class="s2">&quot;LIMIT&quot;</span><span class="p">,</span> <span class="s2">&quot;OFFSET&quot;</span><span class="p">,</span>
</span><span data-line="75">            <span class="s2">&quot;UNION&quot;</span><span class="p">,</span> <span class="s2">&quot;ALL&quot;</span><span class="p">,</span> <span class="s2">&quot;DISTINCT&quot;</span><span class="p">,</span> <span class="s2">&quot;AS&quot;</span><span class="p">,</span> <span class="s2">&quot;IN&quot;</span><span class="p">,</span> <span class="s2">&quot;NOT&quot;</span><span class="p">,</span> <span class="s2">&quot;NULL&quot;</span><span class="p">,</span> <span class="s2">&quot;IS&quot;</span><span class="p">,</span>
</span><span data-line="76">            <span class="s2">&quot;LIKE&quot;</span><span class="p">,</span> <span class="s2">&quot;BETWEEN&quot;</span><span class="p">,</span> <span class="s2">&quot;EXISTS&quot;</span><span class="p">,</span> <span class="s2">&quot;CASE&quot;</span><span class="p">,</span> <span class="s2">&quot;WHEN&quot;</span><span class="p">,</span> <span class="s2">&quot;THEN&quot;</span><span class="p">,</span> <span class="s2">&quot;ELSE&quot;</span><span class="p">,</span> <span class="s2">&quot;END&quot;</span><span class="p">,</span>
</span><span data-line="77">        <span class="p">]</span>
</span><span data-line="78">
</span><span data-line="79">        <span class="n">result</span> <span class="o">=</span> <span class="n">sql</span>
</span><span data-line="80">        <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">:</span>
</span><span data-line="81">            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
</span><span data-line="82">                <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">kw</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">,</span>
</span><span data-line="83">                <span class="sa">f</span><span class="s1">&#39; &lt;span class=&quot;sql-keyword&quot;&gt;</span><span class="si">{</span><span class="n">kw</span><span class="si">}</span><span class="s1">&lt;/span&gt; &#39;</span><span class="p">,</span>
</span><span data-line="84">            <span class="p">)</span>
</span><span data-line="85">        <span class="k">return</span> <span class="n">Markup</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span data-line="86">
</span><span data-line="87">    <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
</span><span data-line="88">    <span class="k">def</span><span class="w"> </span><span class="nf">_get_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span data-line="89"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get cached template.&quot;&quot;&quot;</span>
</span><span data-line="90">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="n">template_name</span><span class="p">)</span>
</span><span data-line="91">
</span><span data-line="92">    <span class="k">def</span><span class="w"> </span><span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="93"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Render a template with context.&quot;&quot;&quot;</span>
</span><span data-line="94">        <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_template</span><span class="p">(</span><span class="n">template_name</span><span class="p">)</span>
</span><span data-line="95">        <span class="k">return</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span><span data-line="96">
</span><span data-line="97">    <span class="k">def</span><span class="w"> </span><span class="nf">render_toolbar</span><span class="p">(</span>
</span><span data-line="98">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="99">        <span class="n">toolbar</span><span class="p">:</span> <span class="n">DebugToolbar</span><span class="p">,</span>
</span><span data-line="100">        <span class="n">request_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span data-line="101">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="102"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Render the complete toolbar HTML.&quot;&quot;&quot;</span>
</span><span data-line="103">        <span class="n">record</span> <span class="o">=</span> <span class="n">toolbar</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request_id</span><span class="p">)</span>
</span><span data-line="104">        <span class="k">if</span> <span class="n">record</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="105">            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
</span><span data-line="106">
</span><span data-line="107">        <span class="n">panels_html</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="108">        <span class="k">for</span> <span class="n">panel</span> <span class="ow">in</span> <span class="n">toolbar</span><span class="o">.</span><span class="n">get_panels</span><span class="p">():</span>
</span><span data-line="109">            <span class="k">if</span> <span class="n">panel</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
</span><span data-line="110">                <span class="n">panel_stats</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">panels_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">panel</span><span class="o">.</span><span class="n">panel_id</span><span class="p">,</span> <span class="p">{})</span>
</span><span data-line="111">                <span class="n">panels_html</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span data-line="112">                    <span class="s2">&quot;panel&quot;</span><span class="p">:</span> <span class="n">panel</span><span class="p">,</span>
</span><span data-line="113">                    <span class="s2">&quot;stats&quot;</span><span class="p">:</span> <span class="n">panel_stats</span><span class="p">,</span>
</span><span data-line="114">                    <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_panel</span><span class="p">(</span><span class="n">panel</span><span class="p">,</span> <span class="n">panel_stats</span><span class="p">),</span>
</span><span data-line="115">                <span class="p">})</span>
</span><span data-line="116">
</span><span data-line="117">        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
</span><span data-line="118">            <span class="s2">&quot;toolbar&quot;</span><span class="p">:</span> <span class="n">toolbar</span><span class="p">,</span>
</span><span data-line="119">            <span class="s2">&quot;request_id&quot;</span><span class="p">:</span> <span class="n">request_id</span><span class="p">,</span>
</span><span data-line="120">            <span class="s2">&quot;record&quot;</span><span class="p">:</span> <span class="n">record</span><span class="p">,</span>
</span><span data-line="121">            <span class="s2">&quot;panels&quot;</span><span class="p">:</span> <span class="n">panels_html</span><span class="p">,</span>
</span><span data-line="122">            <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">toolbar</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
</span><span data-line="123">        <span class="p">}</span>
</span><span data-line="124">
</span><span data-line="125">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s2">&quot;toolbar.html&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span data-line="126">
</span><span data-line="127">    <span class="k">def</span><span class="w"> </span><span class="nf">render_panel</span><span class="p">(</span>
</span><span data-line="128">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="129">        <span class="n">panel</span><span class="p">:</span> <span class="n">Panel</span><span class="p">,</span>
</span><span data-line="130">        <span class="n">stats</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span data-line="131">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="132"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Render a single panel&#39;s content.&quot;&quot;&quot;</span>
</span><span data-line="133">        <span class="n">context</span> <span class="o">=</span> <span class="n">panel</span><span class="o">.</span><span class="n">get_template_context</span><span class="p">()</span>
</span><span data-line="134">        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span>
</span><span data-line="135">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">panel</span><span class="o">.</span><span class="n">template</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span></pre></div>
</div>
</section>
<section id="abstract-asgi-adapter">
<h3>3.7 Abstract ASGI Adapter<a class="headerlink" href="#abstract-asgi-adapter" title="Link to this heading">¶</a></h3>
<p>Interface for framework-specific integration.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># src/async_debug_toolbar/adapters/base.py</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span data-line="3">
</span><span data-line="4"><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
</span><span data-line="5"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Awaitable</span>
</span><span data-line="6">
</span><span data-line="7"><span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="8">    <span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.toolbar</span><span class="w"> </span><span class="kn">import</span> <span class="n">DebugToolbar</span>
</span><span data-line="9">
</span><span data-line="10"><span class="n">ASGIApp</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[</span>
</span><span data-line="11">    <span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="nb">dict</span><span class="p">]],</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]]],</span>
</span><span data-line="12">    <span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span>
</span><span data-line="13"><span class="p">]</span>
</span><span data-line="14">
</span><span data-line="15">
</span><span data-line="16"><span class="k">class</span><span class="w"> </span><span class="nc">ASGIAdapter</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
</span><span data-line="17"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract adapter for framework-specific ASGI integration.</span>
</span><span data-line="18">
</span><span data-line="19"><span class="sd">    Implement this for each framework to handle:</span>
</span><span data-line="20"><span class="sd">    - Route extraction</span>
</span><span data-line="21"><span class="sd">    - Request/response body access</span>
</span><span data-line="22"><span class="sd">    - Framework-specific features</span>
</span><span data-line="23"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="24">
</span><span data-line="25">    <span class="nd">@abstractmethod</span>
</span><span data-line="26">    <span class="k">def</span><span class="w"> </span><span class="nf">get_routes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span data-line="27"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract available routes from the application.</span>
</span><span data-line="28">
</span><span data-line="29"><span class="sd">        Returns:</span>
</span><span data-line="30"><span class="sd">            List of route dictionaries with keys:</span>
</span><span data-line="31"><span class="sd">            - path: URL pattern</span>
</span><span data-line="32"><span class="sd">            - methods: List of HTTP methods</span>
</span><span data-line="33"><span class="sd">            - name: Route name (optional)</span>
</span><span data-line="34"><span class="sd">            - handler: Handler function/class name</span>
</span><span data-line="35"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="36">        <span class="o">...</span>
</span><span data-line="37">
</span><span data-line="38">    <span class="nd">@abstractmethod</span>
</span><span data-line="39">    <span class="k">def</span><span class="w"> </span><span class="nf">get_request_body</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bytes</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="40"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the request body if available.</span>
</span><span data-line="41">
</span><span data-line="42"><span class="sd">        Note: Body may need to be buffered by middleware.</span>
</span><span data-line="43"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="44">        <span class="o">...</span>
</span><span data-line="45">
</span><span data-line="46">    <span class="nd">@abstractmethod</span>
</span><span data-line="47">    <span class="k">def</span><span class="w"> </span><span class="nf">get_response_body</span><span class="p">(</span>
</span><span data-line="48">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="49">        <span class="n">scope</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span data-line="50">        <span class="n">body</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
</span><span data-line="51">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span><span data-line="52"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the response body for inspection.&quot;&quot;&quot;</span>
</span><span data-line="53">        <span class="o">...</span>
</span><span data-line="54">
</span><span data-line="55">    <span class="nd">@abstractmethod</span>
</span><span data-line="56">    <span class="k">def</span><span class="w"> </span><span class="nf">should_inject_toolbar</span><span class="p">(</span>
</span><span data-line="57">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="58">        <span class="n">scope</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span data-line="59">        <span class="n">headers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]],</span>
</span><span data-line="60">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="61"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine if toolbar should be injected into response.&quot;&quot;&quot;</span>
</span><span data-line="62">        <span class="o">...</span>
</span><span data-line="63">
</span><span data-line="64">    <span class="nd">@abstractmethod</span>
</span><span data-line="65">    <span class="k">def</span><span class="w"> </span><span class="nf">inject_toolbar</span><span class="p">(</span>
</span><span data-line="66">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="67">        <span class="n">body</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
</span><span data-line="68">        <span class="n">toolbar_html</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span data-line="69">        <span class="n">insert_before</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span data-line="70">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span><span data-line="71"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Inject toolbar HTML into response body.&quot;&quot;&quot;</span>
</span><span data-line="72">        <span class="o">...</span>
</span><span data-line="73">
</span><span data-line="74">    <span class="k">def</span><span class="w"> </span><span class="nf">get_dependency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span data-line="75"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a framework dependency by name (e.g., database session).&quot;&quot;&quot;</span>
</span><span data-line="76">        <span class="k">return</span> <span class="kc">None</span>
</span></pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="built-in-panels">
<h2>4. Built-in Panels<a class="headerlink" href="#built-in-panels" title="Link to this heading">¶</a></h2>
<section id="timerpanel">
<h3>4.1 TimerPanel<a class="headerlink" href="#timerpanel" title="Link to this heading">¶</a></h3>
<p>Captures request timing metrics.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># src/async_debug_toolbar/panels/timer.py</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span data-line="3">
</span><span data-line="4"><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span data-line="5"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">ClassVar</span>
</span><span data-line="6">
</span><span data-line="7"><span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.context</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_request_context</span>
</span><span data-line="8"><span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.panel</span><span class="w"> </span><span class="kn">import</span> <span class="n">Panel</span>
</span><span data-line="9">
</span><span data-line="10">
</span><span data-line="11"><span class="k">class</span><span class="w"> </span><span class="nc">TimerPanel</span><span class="p">(</span><span class="n">Panel</span><span class="p">):</span>
</span><span data-line="12"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Panel displaying request timing information.&quot;&quot;&quot;</span>
</span><span data-line="13">
</span><span data-line="14">    <span class="n">panel_id</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;timer&quot;</span>
</span><span data-line="15">    <span class="n">title</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Time&quot;</span>
</span><span data-line="16">    <span class="n">template</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;panels/timer.html&quot;</span>
</span><span data-line="17">    <span class="n">weight</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
</span><span data-line="18">
</span><span data-line="19">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="20">        <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_request_context</span><span class="p">()</span>
</span><span data-line="21">        <span class="k">if</span> <span class="n">ctx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="22">            <span class="n">ctx</span><span class="p">[</span><span class="s2">&quot;start_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</span><span data-line="23">
</span><span data-line="24">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_response</span><span class="p">(</span>
</span><span data-line="25">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="26">        <span class="n">scope</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span data-line="27">        <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span data-line="28">        <span class="n">headers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]],</span>
</span><span data-line="29">        <span class="n">body</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
</span><span data-line="30">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="31">        <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_request_context</span><span class="p">()</span>
</span><span data-line="32">        <span class="k">if</span> <span class="n">ctx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="33">            <span class="n">ctx</span><span class="p">[</span><span class="s2">&quot;end_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</span><span data-line="34">
</span><span data-line="35">        <span class="n">stats</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_stats</span><span class="p">()</span>
</span><span data-line="36">        <span class="bp">self</span><span class="o">.</span><span class="n">record_stats</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
</span><span data-line="37">
</span><span data-line="38">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span data-line="39">        <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_request_context</span><span class="p">()</span>
</span><span data-line="40">        <span class="k">if</span> <span class="n">ctx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="41">            <span class="k">return</span> <span class="p">{}</span>
</span><span data-line="42">
</span><span data-line="43">        <span class="n">start</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;start_time&quot;</span><span class="p">)</span>
</span><span data-line="44">        <span class="n">end</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;end_time&quot;</span><span class="p">)</span>
</span><span data-line="45">
</span><span data-line="46">        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="47">            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;total_time_ms&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
</span><span data-line="48">
</span><span data-line="49">        <span class="n">total_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
</span><span data-line="50">
</span><span data-line="51">        <span class="k">return</span> <span class="p">{</span>
</span><span data-line="52">            <span class="s2">&quot;total_time_ms&quot;</span><span class="p">:</span> <span class="n">total_time</span><span class="p">,</span>
</span><span data-line="53">            <span class="s2">&quot;start_time&quot;</span><span class="p">:</span> <span class="n">start</span><span class="p">,</span>
</span><span data-line="54">            <span class="s2">&quot;end_time&quot;</span><span class="p">:</span> <span class="n">end</span><span class="p">,</span>
</span><span data-line="55">        <span class="p">}</span>
</span><span data-line="56">
</span><span data-line="57">    <span class="k">def</span><span class="w"> </span><span class="nf">generate_server_timing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="58">        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stats</span><span class="p">()</span>
</span><span data-line="59">        <span class="n">total</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total_time_ms&quot;</span><span class="p">)</span>
</span><span data-line="60">        <span class="k">if</span> <span class="n">total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="61">            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;total;dur=</span><span class="si">{</span><span class="n">total</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span data-line="62">        <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="63">
</span><span data-line="64">    <span class="nd">@property</span>
</span><span data-line="65">    <span class="k">def</span><span class="w"> </span><span class="nf">nav_subtitle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="66">        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stats</span><span class="p">()</span>
</span><span data-line="67">        <span class="n">total</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total_time_ms&quot;</span><span class="p">)</span>
</span><span data-line="68">        <span class="k">if</span> <span class="n">total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="69">            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">total</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> ms&quot;</span>
</span><span data-line="70">        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
</span></pre></div>
</div>
</section>
<section id="requestpanel">
<h3>4.2 RequestPanel<a class="headerlink" href="#requestpanel" title="Link to this heading">¶</a></h3>
<p>Displays request information.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># src/async_debug_toolbar/panels/request.py</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span data-line="3">
</span><span data-line="4"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">ClassVar</span>
</span><span data-line="5"><span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">parse_qs</span>
</span><span data-line="6">
</span><span data-line="7"><span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.panel</span><span class="w"> </span><span class="kn">import</span> <span class="n">Panel</span>
</span><span data-line="8">
</span><span data-line="9">
</span><span data-line="10"><span class="k">class</span><span class="w"> </span><span class="nc">RequestPanel</span><span class="p">(</span><span class="n">Panel</span><span class="p">):</span>
</span><span data-line="11"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Panel displaying request information.&quot;&quot;&quot;</span>
</span><span data-line="12">
</span><span data-line="13">    <span class="n">panel_id</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;request&quot;</span>
</span><span data-line="14">    <span class="n">title</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Request&quot;</span>
</span><span data-line="15">    <span class="n">template</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;panels/request.html&quot;</span>
</span><span data-line="16">    <span class="n">weight</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>
</span><span data-line="17">
</span><span data-line="18">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="19">        <span class="n">stats</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_stats</span><span class="p">()</span>
</span><span data-line="20">        <span class="bp">self</span><span class="o">.</span><span class="n">record_stats</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
</span><span data-line="21">
</span><span data-line="22">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span data-line="23">        <span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.context</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_request_context</span>
</span><span data-line="24">
</span><span data-line="25">        <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_request_context</span><span class="p">()</span>
</span><span data-line="26">        <span class="k">if</span> <span class="n">ctx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="27">            <span class="k">return</span> <span class="p">{}</span>
</span><span data-line="28">
</span><span data-line="29">        <span class="n">scope</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">[</span><span class="s2">&quot;scope&quot;</span><span class="p">]</span>
</span><span data-line="30">
</span><span data-line="31">        <span class="c1"># Parse headers</span>
</span><span data-line="32">        <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="33">        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">scope</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;headers&quot;</span><span class="p">,</span> <span class="p">[]):</span>
</span><span data-line="34">            <span class="n">key_str</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;latin-1&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span> <span class="k">else</span> <span class="n">key</span>
</span><span data-line="35">            <span class="n">value_str</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;latin-1&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span> <span class="k">else</span> <span class="n">value</span>
</span><span data-line="36">            <span class="n">headers</span><span class="p">[</span><span class="n">key_str</span><span class="p">]</span> <span class="o">=</span> <span class="n">value_str</span>
</span><span data-line="37">
</span><span data-line="38">        <span class="c1"># Parse query string</span>
</span><span data-line="39">        <span class="n">query_string</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;query_string&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span data-line="40">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query_string</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
</span><span data-line="41">            <span class="n">query_string</span> <span class="o">=</span> <span class="n">query_string</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;latin-1&quot;</span><span class="p">)</span>
</span><span data-line="42">        <span class="n">query_params</span> <span class="o">=</span> <span class="n">parse_qs</span><span class="p">(</span><span class="n">query_string</span><span class="p">)</span>
</span><span data-line="43">
</span><span data-line="44">        <span class="c1"># Get cookies</span>
</span><span data-line="45">        <span class="n">cookies</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="46">        <span class="n">cookie_header</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cookie&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span data-line="47">        <span class="k">if</span> <span class="n">cookie_header</span><span class="p">:</span>
</span><span data-line="48">            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cookie_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">):</span>
</span><span data-line="49">                <span class="k">if</span> <span class="s2">&quot;=&quot;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
</span><span data-line="50">                    <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span data-line="51">                    <span class="n">cookies</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span data-line="52">
</span><span data-line="53">        <span class="k">return</span> <span class="p">{</span>
</span><span data-line="54">            <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">scope</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;method&quot;</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">),</span>
</span><span data-line="55">            <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">scope</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">),</span>
</span><span data-line="56">            <span class="s2">&quot;query_string&quot;</span><span class="p">:</span> <span class="n">query_string</span><span class="p">,</span>
</span><span data-line="57">            <span class="s2">&quot;query_params&quot;</span><span class="p">:</span> <span class="n">query_params</span><span class="p">,</span>
</span><span data-line="58">            <span class="s2">&quot;headers&quot;</span><span class="p">:</span> <span class="n">headers</span><span class="p">,</span>
</span><span data-line="59">            <span class="s2">&quot;cookies&quot;</span><span class="p">:</span> <span class="n">cookies</span><span class="p">,</span>
</span><span data-line="60">            <span class="s2">&quot;client&quot;</span><span class="p">:</span> <span class="n">scope</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;client&quot;</span><span class="p">),</span>
</span><span data-line="61">            <span class="s2">&quot;server&quot;</span><span class="p">:</span> <span class="n">scope</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;server&quot;</span><span class="p">),</span>
</span><span data-line="62">            <span class="s2">&quot;scheme&quot;</span><span class="p">:</span> <span class="n">scope</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scheme&quot;</span><span class="p">,</span> <span class="s2">&quot;http&quot;</span><span class="p">),</span>
</span><span data-line="63">            <span class="s2">&quot;http_version&quot;</span><span class="p">:</span> <span class="n">scope</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;http_version&quot;</span><span class="p">,</span> <span class="s2">&quot;1.1&quot;</span><span class="p">),</span>
</span><span data-line="64">            <span class="s2">&quot;asgi&quot;</span><span class="p">:</span> <span class="n">scope</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;asgi&quot;</span><span class="p">,</span> <span class="p">{}),</span>
</span><span data-line="65">        <span class="p">}</span>
</span></pre></div>
</div>
</section>
<section id="responsepanel">
<h3>4.3 ResponsePanel<a class="headerlink" href="#responsepanel" title="Link to this heading">¶</a></h3>
<p>Displays response information.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># src/async_debug_toolbar/panels/response.py</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span data-line="3">
</span><span data-line="4"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">ClassVar</span>
</span><span data-line="5">
</span><span data-line="6"><span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.panel</span><span class="w"> </span><span class="kn">import</span> <span class="n">Panel</span>
</span><span data-line="7">
</span><span data-line="8">
</span><span data-line="9"><span class="k">class</span><span class="w"> </span><span class="nc">ResponsePanel</span><span class="p">(</span><span class="n">Panel</span><span class="p">):</span>
</span><span data-line="10"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Panel displaying response information.&quot;&quot;&quot;</span>
</span><span data-line="11">
</span><span data-line="12">    <span class="n">panel_id</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;response&quot;</span>
</span><span data-line="13">    <span class="n">title</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Response&quot;</span>
</span><span data-line="14">    <span class="n">template</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;panels/response.html&quot;</span>
</span><span data-line="15">    <span class="n">weight</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>
</span><span data-line="16">
</span><span data-line="17">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_response</span><span class="p">(</span>
</span><span data-line="18">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="19">        <span class="n">scope</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span data-line="20">        <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span data-line="21">        <span class="n">headers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]],</span>
</span><span data-line="22">        <span class="n">body</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
</span><span data-line="23">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="24">        <span class="n">stats</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_response_stats</span><span class="p">(</span><span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
</span><span data-line="25">        <span class="bp">self</span><span class="o">.</span><span class="n">record_stats</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
</span><span data-line="26">
</span><span data-line="27">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_generate_response_stats</span><span class="p">(</span>
</span><span data-line="28">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="29">        <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span data-line="30">        <span class="n">headers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]],</span>
</span><span data-line="31">        <span class="n">body</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
</span><span data-line="32">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span data-line="33">        <span class="c1"># Parse headers</span>
</span><span data-line="34">        <span class="n">response_headers</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="35">        <span class="n">content_type</span> <span class="o">=</span> <span class="s2">&quot;application/octet-stream&quot;</span>
</span><span data-line="36">
</span><span data-line="37">        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
</span><span data-line="38">            <span class="n">key_str</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;latin-1&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span> <span class="k">else</span> <span class="n">key</span>
</span><span data-line="39">            <span class="n">value_str</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;latin-1&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span> <span class="k">else</span> <span class="n">value</span>
</span><span data-line="40">            <span class="n">response_headers</span><span class="p">[</span><span class="n">key_str</span><span class="p">]</span> <span class="o">=</span> <span class="n">value_str</span>
</span><span data-line="41">            <span class="k">if</span> <span class="n">key_str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;content-type&quot;</span><span class="p">:</span>
</span><span data-line="42">                <span class="n">content_type</span> <span class="o">=</span> <span class="n">value_str</span>
</span><span data-line="43">
</span><span data-line="44">        <span class="c1"># Body preview (truncated for large responses)</span>
</span><span data-line="45">        <span class="n">body_preview</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="46">        <span class="n">body_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
</span><span data-line="47">
</span><span data-line="48">        <span class="k">if</span> <span class="n">body_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">body_size</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">:</span>
</span><span data-line="49">            <span class="k">if</span> <span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="n">content_type</span> <span class="ow">or</span> <span class="s2">&quot;json&quot;</span> <span class="ow">in</span> <span class="n">content_type</span> <span class="ow">or</span> <span class="s2">&quot;xml&quot;</span> <span class="ow">in</span> <span class="n">content_type</span><span class="p">:</span>
</span><span data-line="50">                <span class="k">try</span><span class="p">:</span>
</span><span data-line="51">                    <span class="n">body_preview</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
</span><span data-line="52">                <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
</span><span data-line="53">                    <span class="n">body_preview</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;latin-1&quot;</span><span class="p">)</span>
</span><span data-line="54">
</span><span data-line="55">        <span class="k">return</span> <span class="p">{</span>
</span><span data-line="56">            <span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="n">status_code</span><span class="p">,</span>
</span><span data-line="57">            <span class="s2">&quot;headers&quot;</span><span class="p">:</span> <span class="n">response_headers</span><span class="p">,</span>
</span><span data-line="58">            <span class="s2">&quot;content_type&quot;</span><span class="p">:</span> <span class="n">content_type</span><span class="p">,</span>
</span><span data-line="59">            <span class="s2">&quot;body_size&quot;</span><span class="p">:</span> <span class="n">body_size</span><span class="p">,</span>
</span><span data-line="60">            <span class="s2">&quot;body_preview&quot;</span><span class="p">:</span> <span class="n">body_preview</span><span class="p">,</span>
</span><span data-line="61">        <span class="p">}</span>
</span><span data-line="62">
</span><span data-line="63">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span data-line="64">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stats</span><span class="p">()</span>
</span><span data-line="65">
</span><span data-line="66">    <span class="nd">@property</span>
</span><span data-line="67">    <span class="k">def</span><span class="w"> </span><span class="nf">nav_subtitle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="68">        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stats</span><span class="p">()</span>
</span><span data-line="69">        <span class="n">status</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status_code&quot;</span><span class="p">)</span>
</span><span data-line="70">        <span class="k">if</span> <span class="n">status</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="71">            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
</span><span data-line="72">        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
</span></pre></div>
</div>
</section>
<section id="loggingpanel">
<h3>4.4 LoggingPanel<a class="headerlink" href="#loggingpanel" title="Link to this heading">¶</a></h3>
<p>Captures logs during request processing.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># src/async_debug_toolbar/panels/logging.py</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span data-line="3">
</span><span data-line="4"><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
</span><span data-line="5"><span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
</span><span data-line="6"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">ClassVar</span>
</span><span data-line="7">
</span><span data-line="8"><span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.context</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_request_context</span>
</span><span data-line="9"><span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.panel</span><span class="w"> </span><span class="kn">import</span> <span class="n">Panel</span>
</span><span data-line="10">
</span><span data-line="11">
</span><span data-line="12"><span class="k">class</span><span class="w"> </span><span class="nc">ToolbarLoggingHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Handler</span><span class="p">):</span>
</span><span data-line="13"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Logging handler that captures logs for the toolbar.&quot;&quot;&quot;</span>
</span><span data-line="14">
</span><span data-line="15">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="16">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span data-line="17">        <span class="bp">self</span><span class="o">.</span><span class="n">_records</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="18">        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>
</span><span data-line="19">
</span><span data-line="20">    <span class="k">def</span><span class="w"> </span><span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">LogRecord</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="21">        <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_request_context</span><span class="p">()</span>
</span><span data-line="22">        <span class="k">if</span> <span class="n">ctx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="23">            <span class="k">return</span>
</span><span data-line="24">
</span><span data-line="25">        <span class="n">request_id</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">[</span><span class="s2">&quot;request_id&quot;</span><span class="p">]</span>
</span><span data-line="26">
</span><span data-line="27">        <span class="n">log_entry</span> <span class="o">=</span> <span class="p">{</span>
</span><span data-line="28">            <span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">levelname</span><span class="p">,</span>
</span><span data-line="29">            <span class="s2">&quot;logger&quot;</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span data-line="30">            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">getMessage</span><span class="p">(),</span>
</span><span data-line="31">            <span class="s2">&quot;pathname&quot;</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">pathname</span><span class="p">,</span>
</span><span data-line="32">            <span class="s2">&quot;lineno&quot;</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span>
</span><span data-line="33">            <span class="s2">&quot;funcname&quot;</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">funcName</span><span class="p">,</span>
</span><span data-line="34">            <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">created</span><span class="p">,</span>
</span><span data-line="35">        <span class="p">}</span>
</span><span data-line="36">
</span><span data-line="37">        <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">exc_info</span><span class="p">:</span>
</span><span data-line="38">            <span class="n">log_entry</span><span class="p">[</span><span class="s2">&quot;exception&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
</span><span data-line="39">
</span><span data-line="40">        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
</span><span data-line="41">            <span class="k">if</span> <span class="n">request_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_records</span><span class="p">:</span>
</span><span data-line="42">                <span class="bp">self</span><span class="o">.</span><span class="n">_records</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="43">            <span class="bp">self</span><span class="o">.</span><span class="n">_records</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log_entry</span><span class="p">)</span>
</span><span data-line="44">
</span><span data-line="45">    <span class="k">def</span><span class="w"> </span><span class="nf">get_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span data-line="46">        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
</span><span data-line="47">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_records</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="p">[])</span>
</span><span data-line="48">
</span><span data-line="49">
</span><span data-line="50"><span class="k">class</span><span class="w"> </span><span class="nc">LoggingPanel</span><span class="p">(</span><span class="n">Panel</span><span class="p">):</span>
</span><span data-line="51"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Panel displaying captured log messages.&quot;&quot;&quot;</span>
</span><span data-line="52">
</span><span data-line="53">    <span class="n">panel_id</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;logging&quot;</span>
</span><span data-line="54">    <span class="n">title</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Logging&quot;</span>
</span><span data-line="55">    <span class="n">template</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;panels/logging.html&quot;</span>
</span><span data-line="56">    <span class="n">weight</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">40</span>
</span><span data-line="57">
</span><span data-line="58">    <span class="n">_handler</span><span class="p">:</span> <span class="n">ToolbarLoggingHandler</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="59">
</span><span data-line="60">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="61">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="62">        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_handler</span><span class="p">()</span>
</span><span data-line="63">
</span><span data-line="64">    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="65">        <span class="k">if</span> <span class="n">LoggingPanel</span><span class="o">.</span><span class="n">_handler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="66">            <span class="n">LoggingPanel</span><span class="o">.</span><span class="n">_handler</span> <span class="o">=</span> <span class="n">ToolbarLoggingHandler</span><span class="p">()</span>
</span><span data-line="67">            <span class="n">LoggingPanel</span><span class="o">.</span><span class="n">_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
</span><span data-line="68">            <span class="n">logging</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">LoggingPanel</span><span class="o">.</span><span class="n">_handler</span><span class="p">)</span>
</span><span data-line="69">
</span><span data-line="70">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_response</span><span class="p">(</span>
</span><span data-line="71">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="72">        <span class="n">scope</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span data-line="73">        <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span data-line="74">        <span class="n">headers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]],</span>
</span><span data-line="75">        <span class="n">body</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
</span><span data-line="76">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="77">        <span class="n">stats</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_stats</span><span class="p">()</span>
</span><span data-line="78">        <span class="bp">self</span><span class="o">.</span><span class="n">record_stats</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
</span><span data-line="79">
</span><span data-line="80">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span data-line="81">        <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_request_context</span><span class="p">()</span>
</span><span data-line="82">        <span class="k">if</span> <span class="n">ctx</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="83">            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;records&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
</span><span data-line="84">
</span><span data-line="85">        <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handler</span><span class="o">.</span><span class="n">get_records</span><span class="p">(</span><span class="n">ctx</span><span class="p">[</span><span class="s2">&quot;request_id&quot;</span><span class="p">])</span>
</span><span data-line="86">
</span><span data-line="87">        <span class="c1"># Group by level</span>
</span><span data-line="88">        <span class="n">by_level</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="89">        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
</span><span data-line="90">            <span class="n">level</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s2">&quot;level&quot;</span><span class="p">]</span>
</span><span data-line="91">            <span class="k">if</span> <span class="n">level</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">by_level</span><span class="p">:</span>
</span><span data-line="92">                <span class="n">by_level</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span data-line="93">            <span class="n">by_level</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span data-line="94">
</span><span data-line="95">        <span class="k">return</span> <span class="p">{</span>
</span><span data-line="96">            <span class="s2">&quot;records&quot;</span><span class="p">:</span> <span class="n">records</span><span class="p">,</span>
</span><span data-line="97">            <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">records</span><span class="p">),</span>
</span><span data-line="98">            <span class="s2">&quot;by_level&quot;</span><span class="p">:</span> <span class="n">by_level</span><span class="p">,</span>
</span><span data-line="99">        <span class="p">}</span>
</span><span data-line="100">
</span><span data-line="101">    <span class="nd">@property</span>
</span><span data-line="102">    <span class="k">def</span><span class="w"> </span><span class="nf">nav_subtitle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="103">        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stats</span><span class="p">()</span>
</span><span data-line="104">        <span class="n">count</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span data-line="105">        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="106">            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
</span><span data-line="107">        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
</span></pre></div>
</div>
</section>
<section id="profilingpanel">
<h3>4.5 ProfilingPanel<a class="headerlink" href="#profilingpanel" title="Link to this heading">¶</a></h3>
<p>cProfile integration for detailed profiling.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># src/async_debug_toolbar/panels/profiling.py</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span data-line="3">
</span><span data-line="4"><span class="kn">import</span><span class="w"> </span><span class="nn">cProfile</span>
</span><span data-line="5"><span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
</span><span data-line="6"><span class="kn">import</span><span class="w"> </span><span class="nn">pstats</span>
</span><span data-line="7"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">ClassVar</span>
</span><span data-line="8">
</span><span data-line="9"><span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.context</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_request_context</span>
</span><span data-line="10"><span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.panel</span><span class="w"> </span><span class="kn">import</span> <span class="n">Panel</span>
</span><span data-line="11">
</span><span data-line="12">
</span><span data-line="13"><span class="k">class</span><span class="w"> </span><span class="nc">ProfilingPanel</span><span class="p">(</span><span class="n">Panel</span><span class="p">):</span>
</span><span data-line="14"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Panel for cProfile-based request profiling.&quot;&quot;&quot;</span>
</span><span data-line="15">
</span><span data-line="16">    <span class="n">panel_id</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;profiling&quot;</span>
</span><span data-line="17">    <span class="n">title</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Profiling&quot;</span>
</span><span data-line="18">    <span class="n">template</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;panels/profiling.html&quot;</span>
</span><span data-line="19">    <span class="n">weight</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">90</span>
</span><span data-line="20">    <span class="n">default_enabled</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Disabled by default due to overhead</span>
</span><span data-line="21">
</span><span data-line="22">    <span class="n">_profiler</span><span class="p">:</span> <span class="n">cProfile</span><span class="o">.</span><span class="n">Profile</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="23">
</span><span data-line="24">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="25">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">enable_profiling</span><span class="p">:</span>
</span><span data-line="26">            <span class="k">return</span>
</span><span data-line="27">
</span><span data-line="28">        <span class="bp">self</span><span class="o">.</span><span class="n">_profiler</span> <span class="o">=</span> <span class="n">cProfile</span><span class="o">.</span><span class="n">Profile</span><span class="p">()</span>
</span><span data-line="29">        <span class="bp">self</span><span class="o">.</span><span class="n">_profiler</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>
</span><span data-line="30">
</span><span data-line="31">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_response</span><span class="p">(</span>
</span><span data-line="32">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="33">        <span class="n">scope</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span data-line="34">        <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span data-line="35">        <span class="n">headers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]],</span>
</span><span data-line="36">        <span class="n">body</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
</span><span data-line="37">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="38">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_profiler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="39">            <span class="k">return</span>
</span><span data-line="40">
</span><span data-line="41">        <span class="bp">self</span><span class="o">.</span><span class="n">_profiler</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>
</span><span data-line="42">        <span class="n">stats</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_stats</span><span class="p">()</span>
</span><span data-line="43">        <span class="bp">self</span><span class="o">.</span><span class="n">record_stats</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
</span><span data-line="44">        <span class="bp">self</span><span class="o">.</span><span class="n">_profiler</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="45">
</span><span data-line="46">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span data-line="47">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_profiler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="48">            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;stats&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
</span><span data-line="49">
</span><span data-line="50">        <span class="c1"># Generate stats output</span>
</span><span data-line="51">        <span class="n">stream</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
</span><span data-line="52">        <span class="n">ps</span> <span class="o">=</span> <span class="n">pstats</span><span class="o">.</span><span class="n">Stats</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_profiler</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>
</span><span data-line="53">        <span class="n">ps</span><span class="o">.</span><span class="n">sort_stats</span><span class="p">(</span><span class="s2">&quot;cumulative&quot;</span><span class="p">)</span>
</span><span data-line="54">        <span class="n">ps</span><span class="o">.</span><span class="n">print_stats</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</span><span data-line="55">
</span><span data-line="56">        <span class="n">stats_text</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
</span><span data-line="57">
</span><span data-line="58">        <span class="c1"># Parse into structured data</span>
</span><span data-line="59">        <span class="n">calls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="60">        <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">ps</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span data-line="61">            <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">func</span><span class="p">),</span> <span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">nc</span><span class="p">,</span> <span class="n">tt</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">callers</span><span class="p">)</span> <span class="o">=</span> <span class="n">stat</span>
</span><span data-line="62">            <span class="n">calls</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span data-line="63">                <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
</span><span data-line="64">                <span class="s2">&quot;lineno&quot;</span><span class="p">:</span> <span class="n">lineno</span><span class="p">,</span>
</span><span data-line="65">                <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="n">func</span><span class="p">,</span>
</span><span data-line="66">                <span class="s2">&quot;primitive_calls&quot;</span><span class="p">:</span> <span class="n">cc</span><span class="p">,</span>
</span><span data-line="67">                <span class="s2">&quot;total_calls&quot;</span><span class="p">:</span> <span class="n">nc</span><span class="p">,</span>
</span><span data-line="68">                <span class="s2">&quot;total_time&quot;</span><span class="p">:</span> <span class="n">tt</span><span class="p">,</span>
</span><span data-line="69">                <span class="s2">&quot;cumulative_time&quot;</span><span class="p">:</span> <span class="n">ct</span><span class="p">,</span>
</span><span data-line="70">            <span class="p">})</span>
</span><span data-line="71">
</span><span data-line="72">        <span class="c1"># Sort by cumulative time</span>
</span><span data-line="73">        <span class="n">calls</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;cumulative_time&quot;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="74">
</span><span data-line="75">        <span class="k">return</span> <span class="p">{</span>
</span><span data-line="76">            <span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="77">            <span class="s2">&quot;stats_text&quot;</span><span class="p">:</span> <span class="n">stats_text</span><span class="p">,</span>
</span><span data-line="78">            <span class="s2">&quot;calls&quot;</span><span class="p">:</span> <span class="n">calls</span><span class="p">[:</span><span class="mi">50</span><span class="p">],</span>  <span class="c1"># Top 50 calls</span>
</span><span data-line="79">            <span class="s2">&quot;total_calls&quot;</span><span class="p">:</span> <span class="n">ps</span><span class="o">.</span><span class="n">total_calls</span><span class="p">,</span>
</span><span data-line="80">            <span class="s2">&quot;total_time&quot;</span><span class="p">:</span> <span class="n">ps</span><span class="o">.</span><span class="n">total_tt</span><span class="p">,</span>
</span><span data-line="81">        <span class="p">}</span>
</span><span data-line="82">
</span><span data-line="83">    <span class="nd">@property</span>
</span><span data-line="84">    <span class="k">def</span><span class="w"> </span><span class="nf">nav_subtitle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="85">        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stats</span><span class="p">()</span>
</span><span data-line="86">        <span class="k">if</span> <span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enabled&quot;</span><span class="p">):</span>
</span><span data-line="87">            <span class="n">total_time</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span data-line="88">            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">total_time</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> ms&quot;</span>
</span><span data-line="89">        <span class="k">return</span> <span class="s2">&quot;Off&quot;</span>
</span></pre></div>
</div>
</section>
<section id="versionspanel">
<h3>4.6 VersionsPanel<a class="headerlink" href="#versionspanel" title="Link to this heading">¶</a></h3>
<p>Displays Python and package versions.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># src/async_debug_toolbar/panels/versions.py</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span data-line="3">
</span><span data-line="4"><span class="kn">import</span><span class="w"> </span><span class="nn">platform</span>
</span><span data-line="5"><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
</span><span data-line="6"><span class="kn">from</span><span class="w"> </span><span class="nn">importlib.metadata</span><span class="w"> </span><span class="kn">import</span> <span class="n">distributions</span><span class="p">,</span> <span class="n">version</span>
</span><span data-line="7"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">ClassVar</span>
</span><span data-line="8">
</span><span data-line="9"><span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.panel</span><span class="w"> </span><span class="kn">import</span> <span class="n">Panel</span>
</span><span data-line="10">
</span><span data-line="11">
</span><span data-line="12"><span class="k">class</span><span class="w"> </span><span class="nc">VersionsPanel</span><span class="p">(</span><span class="n">Panel</span><span class="p">):</span>
</span><span data-line="13"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Panel displaying Python and package versions.&quot;&quot;&quot;</span>
</span><span data-line="14">
</span><span data-line="15">    <span class="n">panel_id</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;versions&quot;</span>
</span><span data-line="16">    <span class="n">title</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Versions&quot;</span>
</span><span data-line="17">    <span class="n">template</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;panels/versions.html&quot;</span>
</span><span data-line="18">    <span class="n">weight</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>
</span><span data-line="19">
</span><span data-line="20">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span data-line="21">        <span class="c1"># Python info</span>
</span><span data-line="22">        <span class="n">python_info</span> <span class="o">=</span> <span class="p">{</span>
</span><span data-line="23">            <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
</span><span data-line="24">            <span class="s2">&quot;version_info&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">),</span>
</span><span data-line="25">            <span class="s2">&quot;implementation&quot;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">python_implementation</span><span class="p">(),</span>
</span><span data-line="26">            <span class="s2">&quot;platform&quot;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">platform</span><span class="p">(),</span>
</span><span data-line="27">            <span class="s2">&quot;executable&quot;</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span>
</span><span data-line="28">        <span class="p">}</span>
</span><span data-line="29">
</span><span data-line="30">        <span class="c1"># Installed packages</span>
</span><span data-line="31">        <span class="n">packages</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="32">        <span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="n">distributions</span><span class="p">():</span>
</span><span data-line="33">            <span class="n">packages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span data-line="34">                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">dist</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">],</span>
</span><span data-line="35">                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">dist</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;Version&quot;</span><span class="p">],</span>
</span><span data-line="36">            <span class="p">})</span>
</span><span data-line="37">
</span><span data-line="38">        <span class="n">packages</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
</span><span data-line="39">
</span><span data-line="40">        <span class="c1"># Key packages (highlight these)</span>
</span><span data-line="41">        <span class="n">key_packages</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="42">            <span class="s2">&quot;litestar&quot;</span><span class="p">,</span>
</span><span data-line="43">            <span class="s2">&quot;async-debug-toolbar&quot;</span><span class="p">,</span>
</span><span data-line="44">            <span class="s2">&quot;litestar-debug-toolbar&quot;</span><span class="p">,</span>
</span><span data-line="45">            <span class="s2">&quot;sqlalchemy&quot;</span><span class="p">,</span>
</span><span data-line="46">            <span class="s2">&quot;advanced-alchemy&quot;</span><span class="p">,</span>
</span><span data-line="47">            <span class="s2">&quot;pydantic&quot;</span><span class="p">,</span>
</span><span data-line="48">            <span class="s2">&quot;uvicorn&quot;</span><span class="p">,</span>
</span><span data-line="49">            <span class="s2">&quot;starlette&quot;</span><span class="p">,</span>
</span><span data-line="50">        <span class="p">]</span>
</span><span data-line="51">
</span><span data-line="52">        <span class="n">highlighted</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="53">        <span class="k">for</span> <span class="n">pkg_name</span> <span class="ow">in</span> <span class="n">key_packages</span><span class="p">:</span>
</span><span data-line="54">            <span class="k">try</span><span class="p">:</span>
</span><span data-line="55">                <span class="n">pkg_version</span> <span class="o">=</span> <span class="n">version</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>
</span><span data-line="56">                <span class="n">highlighted</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">pkg_name</span><span class="p">,</span> <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">pkg_version</span><span class="p">})</span>
</span><span data-line="57">            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span data-line="58">                <span class="k">pass</span>
</span><span data-line="59">
</span><span data-line="60">        <span class="k">return</span> <span class="p">{</span>
</span><span data-line="61">            <span class="s2">&quot;python&quot;</span><span class="p">:</span> <span class="n">python_info</span><span class="p">,</span>
</span><span data-line="62">            <span class="s2">&quot;packages&quot;</span><span class="p">:</span> <span class="n">packages</span><span class="p">,</span>
</span><span data-line="63">            <span class="s2">&quot;highlighted&quot;</span><span class="p">:</span> <span class="n">highlighted</span><span class="p">,</span>
</span><span data-line="64">        <span class="p">}</span>
</span><span data-line="65">
</span><span data-line="66">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="67">        <span class="n">stats</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_stats</span><span class="p">()</span>
</span><span data-line="68">        <span class="bp">self</span><span class="o">.</span><span class="n">record_stats</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
</span></pre></div>
</div>
</section>
<section id="routespanel">
<h3>4.7 RoutesPanel<a class="headerlink" href="#routespanel" title="Link to this heading">¶</a></h3>
<p>Displays available routes.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># src/async_debug_toolbar/panels/routes.py</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span data-line="3">
</span><span data-line="4"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">ClassVar</span>
</span><span data-line="5">
</span><span data-line="6"><span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.panel</span><span class="w"> </span><span class="kn">import</span> <span class="n">Panel</span>
</span><span data-line="7">
</span><span data-line="8">
</span><span data-line="9"><span class="k">class</span><span class="w"> </span><span class="nc">RoutesPanel</span><span class="p">(</span><span class="n">Panel</span><span class="p">):</span>
</span><span data-line="10"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Panel displaying available application routes.&quot;&quot;&quot;</span>
</span><span data-line="11">
</span><span data-line="12">    <span class="n">panel_id</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;routes&quot;</span>
</span><span data-line="13">    <span class="n">title</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Routes&quot;</span>
</span><span data-line="14">    <span class="n">template</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;panels/routes.html&quot;</span>
</span><span data-line="15">    <span class="n">weight</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">80</span>
</span><span data-line="16">
</span><span data-line="17">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span data-line="18">        <span class="n">adapter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toolbar</span><span class="o">.</span><span class="n">adapter</span>
</span><span data-line="19">        <span class="n">routes</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">.</span><span class="n">get_routes</span><span class="p">()</span>
</span><span data-line="20">
</span><span data-line="21">        <span class="c1"># Group routes by path prefix</span>
</span><span data-line="22">        <span class="n">grouped</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="23">        <span class="k">for</span> <span class="n">route</span> <span class="ow">in</span> <span class="n">routes</span><span class="p">:</span>
</span><span data-line="24">            <span class="n">path</span> <span class="o">=</span> <span class="n">route</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
</span><span data-line="25">            <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">path</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">path</span> <span class="o">!=</span> <span class="s2">&quot;/&quot;</span> <span class="k">else</span> <span class="s2">&quot;/&quot;</span>
</span><span data-line="26">            <span class="k">if</span> <span class="n">prefix</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">:</span>
</span><span data-line="27">                <span class="n">grouped</span><span class="p">[</span><span class="n">prefix</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="28">            <span class="n">grouped</span><span class="p">[</span><span class="n">prefix</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">route</span><span class="p">)</span>
</span><span data-line="29">
</span><span data-line="30">        <span class="k">return</span> <span class="p">{</span>
</span><span data-line="31">            <span class="s2">&quot;routes&quot;</span><span class="p">:</span> <span class="n">routes</span><span class="p">,</span>
</span><span data-line="32">            <span class="s2">&quot;grouped&quot;</span><span class="p">:</span> <span class="n">grouped</span><span class="p">,</span>
</span><span data-line="33">            <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">routes</span><span class="p">),</span>
</span><span data-line="34">        <span class="p">}</span>
</span><span data-line="35">
</span><span data-line="36">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="37">        <span class="n">stats</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_stats</span><span class="p">()</span>
</span><span data-line="38">        <span class="bp">self</span><span class="o">.</span><span class="n">record_stats</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
</span><span data-line="39">
</span><span data-line="40">    <span class="nd">@property</span>
</span><span data-line="41">    <span class="k">def</span><span class="w"> </span><span class="nf">nav_subtitle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="42">        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stats</span><span class="p">()</span>
</span><span data-line="43">        <span class="n">count</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span data-line="44">        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
</span></pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="extension-points">
<h2>5. Extension Points<a class="headerlink" href="#extension-points" title="Link to this heading">¶</a></h2>
<section id="creating-custom-panels">
<h3>5.1 Creating Custom Panels<a class="headerlink" href="#creating-custom-panels" title="Link to this heading">¶</a></h3>
<p>Custom panels extend the base <code class="docutils literal notranslate"><span class="pre">Panel</span></code> class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># Example: Custom CachePanel</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.panel</span><span class="w"> </span><span class="kn">import</span> <span class="n">Panel</span>
</span><span data-line="3"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">ClassVar</span>
</span><span data-line="4">
</span><span data-line="5">
</span><span data-line="6"><span class="k">class</span><span class="w"> </span><span class="nc">CachePanel</span><span class="p">(</span><span class="n">Panel</span><span class="p">):</span>
</span><span data-line="7"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom panel for cache statistics.&quot;&quot;&quot;</span>
</span><span data-line="8">
</span><span data-line="9">    <span class="n">panel_id</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;cache&quot;</span>
</span><span data-line="10">    <span class="n">title</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Cache&quot;</span>
</span><span data-line="11">    <span class="n">template</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;panels/cache.html&quot;</span>
</span><span data-line="12">    <span class="n">weight</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">60</span>
</span><span data-line="13">
</span><span data-line="14">    <span class="c1"># Track cache operations</span>
</span><span data-line="15">    <span class="n">_hits</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span data-line="16">    <span class="n">_misses</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span data-line="17">    <span class="n">_operations</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="18">
</span><span data-line="19">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="20">        <span class="c1"># Reset per-request state</span>
</span><span data-line="21">        <span class="bp">self</span><span class="o">.</span><span class="n">_hits</span> <span class="o">=</span> <span class="mi">0</span>
</span><span data-line="22">        <span class="bp">self</span><span class="o">.</span><span class="n">_misses</span> <span class="o">=</span> <span class="mi">0</span>
</span><span data-line="23">        <span class="bp">self</span><span class="o">.</span><span class="n">_operations</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="24">
</span><span data-line="25">    <span class="k">def</span><span class="w"> </span><span class="nf">record_hit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="26"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Call this from your cache wrapper.&quot;&quot;&quot;</span>
</span><span data-line="27">        <span class="bp">self</span><span class="o">.</span><span class="n">_hits</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span data-line="28">        <span class="bp">self</span><span class="o">.</span><span class="n">_operations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span data-line="29">            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;hit&quot;</span><span class="p">,</span>
</span><span data-line="30">            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span>
</span><span data-line="31">        <span class="p">})</span>
</span><span data-line="32">
</span><span data-line="33">    <span class="k">def</span><span class="w"> </span><span class="nf">record_miss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="34"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Call this from your cache wrapper.&quot;&quot;&quot;</span>
</span><span data-line="35">        <span class="bp">self</span><span class="o">.</span><span class="n">_misses</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span data-line="36">        <span class="bp">self</span><span class="o">.</span><span class="n">_operations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span data-line="37">            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;miss&quot;</span><span class="p">,</span>
</span><span data-line="38">            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span>
</span><span data-line="39">        <span class="p">})</span>
</span><span data-line="40">
</span><span data-line="41">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span data-line="42">        <span class="k">return</span> <span class="p">{</span>
</span><span data-line="43">            <span class="s2">&quot;hits&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hits</span><span class="p">,</span>
</span><span data-line="44">            <span class="s2">&quot;misses&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_misses</span><span class="p">,</span>
</span><span data-line="45">            <span class="s2">&quot;operations&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_operations</span><span class="p">,</span>
</span><span data-line="46">            <span class="s2">&quot;hit_rate&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hits</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hits</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_misses</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_operations</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
</span><span data-line="47">        <span class="p">}</span>
</span><span data-line="48">
</span><span data-line="49">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_response</span><span class="p">(</span>
</span><span data-line="50">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="51">        <span class="n">scope</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span data-line="52">        <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span data-line="53">        <span class="n">headers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]],</span>
</span><span data-line="54">        <span class="n">body</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
</span><span data-line="55">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="56">        <span class="n">stats</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_stats</span><span class="p">()</span>
</span><span data-line="57">        <span class="bp">self</span><span class="o">.</span><span class="n">record_stats</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
</span></pre></div>
</div>
</section>
<section id="panel-registration">
<h3>5.2 Panel Registration<a class="headerlink" href="#panel-registration" title="Link to this heading">¶</a></h3>
<p>Register custom panels via configuration:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">DebugToolbarConfig</span>
</span><span data-line="2">
</span><span data-line="3"><span class="n">config</span> <span class="o">=</span> <span class="n">DebugToolbarConfig</span><span class="p">(</span>
</span><span data-line="4">    <span class="n">panels</span><span class="o">=</span><span class="p">[</span>
</span><span data-line="5">        <span class="c1"># Built-in panels</span>
</span><span data-line="6">        <span class="s2">&quot;async_debug_toolbar.panels.timer.TimerPanel&quot;</span><span class="p">,</span>
</span><span data-line="7">        <span class="s2">&quot;async_debug_toolbar.panels.request.RequestPanel&quot;</span><span class="p">,</span>
</span><span data-line="8">        <span class="c1"># Custom panel</span>
</span><span data-line="9">        <span class="s2">&quot;myapp.panels.cache.CachePanel&quot;</span><span class="p">,</span>
</span><span data-line="10">    <span class="p">],</span>
</span><span data-line="11">    <span class="n">panel_options</span><span class="o">=</span><span class="p">{</span>
</span><span data-line="12">        <span class="s2">&quot;cache&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span data-line="13">            <span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="14">            <span class="s2">&quot;show_values&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="15">        <span class="p">},</span>
</span><span data-line="16">    <span class="p">},</span>
</span><span data-line="17"><span class="p">)</span>
</span></pre></div>
</div>
</section>
<section id="hook-system">
<h3>5.3 Hook System<a class="headerlink" href="#hook-system" title="Link to this heading">¶</a></h3>
<p>Hooks allow panels to intercept various points in the request lifecycle:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># src/async_debug_toolbar/hooks.py</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span data-line="3">
</span><span data-line="4"><span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
</span><span data-line="5"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Awaitable</span>
</span><span data-line="6">
</span><span data-line="7">
</span><span data-line="8"><span class="k">class</span><span class="w"> </span><span class="nc">HookType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
</span><span data-line="9"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Available hook points.&quot;&quot;&quot;</span>
</span><span data-line="10">
</span><span data-line="11">    <span class="n">PRE_REQUEST</span> <span class="o">=</span> <span class="s2">&quot;pre_request&quot;</span>
</span><span data-line="12">    <span class="n">POST_REQUEST</span> <span class="o">=</span> <span class="s2">&quot;post_request&quot;</span>
</span><span data-line="13">    <span class="n">PRE_RESPONSE</span> <span class="o">=</span> <span class="s2">&quot;pre_response&quot;</span>
</span><span data-line="14">    <span class="n">POST_RESPONSE</span> <span class="o">=</span> <span class="s2">&quot;post_response&quot;</span>
</span><span data-line="15">    <span class="n">ON_ERROR</span> <span class="o">=</span> <span class="s2">&quot;on_error&quot;</span>
</span><span data-line="16">
</span><span data-line="17">
</span><span data-line="18"><span class="n">HookCallback</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]]</span>
</span><span data-line="19">
</span><span data-line="20">
</span><span data-line="21"><span class="k">class</span><span class="w"> </span><span class="nc">HookRegistry</span><span class="p">:</span>
</span><span data-line="22"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Registry for toolbar hooks.&quot;&quot;&quot;</span>
</span><span data-line="23">
</span><span data-line="24">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="25">        <span class="bp">self</span><span class="o">.</span><span class="n">_hooks</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">HookType</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">HookCallback</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
</span><span data-line="26">            <span class="n">hook</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">HookType</span>
</span><span data-line="27">        <span class="p">}</span>
</span><span data-line="28">
</span><span data-line="29">    <span class="k">def</span><span class="w"> </span><span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hook_type</span><span class="p">:</span> <span class="n">HookType</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">HookCallback</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="30"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Register a hook callback.&quot;&quot;&quot;</span>
</span><span data-line="31">        <span class="bp">self</span><span class="o">.</span><span class="n">_hooks</span><span class="p">[</span><span class="n">hook_type</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
</span><span data-line="32">
</span><span data-line="33">    <span class="k">def</span><span class="w"> </span><span class="nf">unregister</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hook_type</span><span class="p">:</span> <span class="n">HookType</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">HookCallback</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="34"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Unregister a hook callback.&quot;&quot;&quot;</span>
</span><span data-line="35">        <span class="k">if</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hooks</span><span class="p">[</span><span class="n">hook_type</span><span class="p">]:</span>
</span><span data-line="36">            <span class="bp">self</span><span class="o">.</span><span class="n">_hooks</span><span class="p">[</span><span class="n">hook_type</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
</span><span data-line="37">
</span><span data-line="38">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hook_type</span><span class="p">:</span> <span class="n">HookType</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="39"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Trigger all callbacks for a hook type.&quot;&quot;&quot;</span>
</span><span data-line="40">        <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hooks</span><span class="p">[</span><span class="n">hook_type</span><span class="p">]:</span>
</span><span data-line="41">            <span class="k">await</span> <span class="n">callback</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span></pre></div>
</div>
</section>
<section id="template-customization">
<h3>5.4 Template Customization<a class="headerlink" href="#template-customization" title="Link to this heading">¶</a></h3>
<p>Override templates by providing a custom templates directory:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.rendering.jinja</span><span class="w"> </span><span class="kn">import</span> <span class="n">JinjaTemplateEngine</span>
</span><span data-line="3">
</span><span data-line="4"><span class="n">engine</span> <span class="o">=</span> <span class="n">JinjaTemplateEngine</span><span class="p">(</span>
</span><span data-line="5">    <span class="n">templates_dir</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/path/to/custom/templates&quot;</span><span class="p">),</span>
</span><span data-line="6"><span class="p">)</span>
</span></pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="litestar-plugin-design">
<h2>6. Litestar Plugin Design<a class="headerlink" href="#litestar-plugin-design" title="Link to this heading">¶</a></h2>
<section id="plugin-implementation">
<h3>6.1 Plugin Implementation<a class="headerlink" href="#plugin-implementation" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># src/litestar_debug_toolbar/plugin.py</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span data-line="3">
</span><span data-line="4"><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
</span><span data-line="5"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span>
</span><span data-line="6">
</span><span data-line="7"><span class="kn">from</span><span class="w"> </span><span class="nn">litestar.plugins</span><span class="w"> </span><span class="kn">import</span> <span class="n">InitPluginProtocol</span>
</span><span data-line="8">
</span><span data-line="9"><span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">DebugToolbarConfig</span>
</span><span data-line="10"><span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.toolbar</span><span class="w"> </span><span class="kn">import</span> <span class="n">DebugToolbar</span>
</span><span data-line="11"><span class="kn">from</span><span class="w"> </span><span class="nn">litestar_debug_toolbar.adapter</span><span class="w"> </span><span class="kn">import</span> <span class="n">LitestarAdapter</span>
</span><span data-line="12"><span class="kn">from</span><span class="w"> </span><span class="nn">litestar_debug_toolbar.middleware</span><span class="w"> </span><span class="kn">import</span> <span class="n">DebugToolbarMiddleware</span>
</span><span data-line="13">
</span><span data-line="14"><span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="15">    <span class="kn">from</span><span class="w"> </span><span class="nn">litestar.config.app</span><span class="w"> </span><span class="kn">import</span> <span class="n">AppConfig</span>
</span><span data-line="16">
</span><span data-line="17">
</span><span data-line="18"><span class="nd">@dataclass</span>
</span><span data-line="19"><span class="k">class</span><span class="w"> </span><span class="nc">DebugToolbarPlugin</span><span class="p">(</span><span class="n">InitPluginProtocol</span><span class="p">):</span>
</span><span data-line="20"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Litestar plugin for the debug toolbar.</span>
</span><span data-line="21">
</span><span data-line="22"><span class="sd">    Usage:</span>
</span><span data-line="23"><span class="sd">        from litestar import Litestar</span>
</span><span data-line="24"><span class="sd">        from litestar_debug_toolbar import DebugToolbarPlugin</span>
</span><span data-line="25">
</span><span data-line="26"><span class="sd">        app = Litestar(</span>
</span><span data-line="27"><span class="sd">            plugins=[DebugToolbarPlugin()],</span>
</span><span data-line="28"><span class="sd">        )</span>
</span><span data-line="29">
</span><span data-line="30"><span class="sd">    With configuration:</span>
</span><span data-line="31"><span class="sd">        from litestar_debug_toolbar import DebugToolbarPlugin, DebugToolbarConfig</span>
</span><span data-line="32">
</span><span data-line="33"><span class="sd">        plugin = DebugToolbarPlugin(</span>
</span><span data-line="34"><span class="sd">            config=DebugToolbarConfig(</span>
</span><span data-line="35"><span class="sd">                panels=[...],</span>
</span><span data-line="36"><span class="sd">                max_history=100,</span>
</span><span data-line="37"><span class="sd">            ),</span>
</span><span data-line="38"><span class="sd">        )</span>
</span><span data-line="39">
</span><span data-line="40"><span class="sd">        app = Litestar(plugins=[plugin])</span>
</span><span data-line="41"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="42">
</span><span data-line="43">    <span class="n">config</span><span class="p">:</span> <span class="n">DebugToolbarConfig</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">DebugToolbarConfig</span><span class="p">)</span>
</span><span data-line="44">
</span><span data-line="45">    <span class="k">def</span><span class="w"> </span><span class="nf">on_app_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_config</span><span class="p">:</span> <span class="n">AppConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AppConfig</span><span class="p">:</span>
</span><span data-line="46"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the debug toolbar on app startup.&quot;&quot;&quot;</span>
</span><span data-line="47">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
</span><span data-line="48">            <span class="k">return</span> <span class="n">app_config</span>
</span><span data-line="49">
</span><span data-line="50">        <span class="c1"># Add Litestar-specific panels</span>
</span><span data-line="51">        <span class="k">if</span> <span class="s2">&quot;litestar_debug_toolbar.panels.routes.LitestarRoutesPanel&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">panels</span><span class="p">:</span>
</span><span data-line="52">            <span class="c1"># Replace generic routes panel with Litestar-specific one</span>
</span><span data-line="53">            <span class="k">try</span><span class="p">:</span>
</span><span data-line="54">                <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">panels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;async_debug_toolbar.panels.routes.RoutesPanel&quot;</span><span class="p">)</span>
</span><span data-line="55">                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">panels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;litestar_debug_toolbar.panels.routes.LitestarRoutesPanel&quot;</span>
</span><span data-line="56">            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span data-line="57">                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">panels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;litestar_debug_toolbar.panels.routes.LitestarRoutesPanel&quot;</span><span class="p">)</span>
</span><span data-line="58">
</span><span data-line="59">        <span class="c1"># Store config for middleware access</span>
</span><span data-line="60">        <span class="n">app_config</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;debug_toolbar_config&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
</span><span data-line="61">
</span><span data-line="62">        <span class="c1"># Add middleware (will be initialized when app is available)</span>
</span><span data-line="63">        <span class="n">app_config</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DebugToolbarMiddleware</span><span class="p">)</span>
</span><span data-line="64">
</span><span data-line="65">        <span class="c1"># Add toolbar route handlers</span>
</span><span data-line="66">        <span class="kn">from</span><span class="w"> </span><span class="nn">litestar_debug_toolbar.handlers</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_toolbar_handlers</span>
</span><span data-line="67">        <span class="n">toolbar_handlers</span> <span class="o">=</span> <span class="n">create_toolbar_handlers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
</span><span data-line="68">        <span class="n">app_config</span><span class="o">.</span><span class="n">route_handlers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">toolbar_handlers</span><span class="p">)</span>
</span><span data-line="69">
</span><span data-line="70">        <span class="k">return</span> <span class="n">app_config</span>
</span></pre></div>
</div>
</section>
<section id="middleware-implementation">
<h3>6.2 Middleware Implementation<a class="headerlink" href="#middleware-implementation" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># src/litestar_debug_toolbar/middleware.py</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span data-line="3">
</span><span data-line="4"><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span data-line="5"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span>
</span><span data-line="6">
</span><span data-line="7"><span class="kn">from</span><span class="w"> </span><span class="nn">litestar.middleware</span><span class="w"> </span><span class="kn">import</span> <span class="n">AbstractMiddleware</span>
</span><span data-line="8"><span class="kn">from</span><span class="w"> </span><span class="nn">litestar.enums</span><span class="w"> </span><span class="kn">import</span> <span class="n">ScopeType</span>
</span><span data-line="9">
</span><span data-line="10"><span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.toolbar</span><span class="w"> </span><span class="kn">import</span> <span class="n">DebugToolbar</span>
</span><span data-line="11"><span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.context</span><span class="w"> </span><span class="kn">import</span> <span class="n">RequestContextManager</span>
</span><span data-line="12"><span class="kn">from</span><span class="w"> </span><span class="nn">litestar_debug_toolbar.adapter</span><span class="w"> </span><span class="kn">import</span> <span class="n">LitestarAdapter</span>
</span><span data-line="13">
</span><span data-line="14"><span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="15">    <span class="kn">from</span><span class="w"> </span><span class="nn">litestar</span><span class="w"> </span><span class="kn">import</span> <span class="n">Litestar</span>
</span><span data-line="16">    <span class="kn">from</span><span class="w"> </span><span class="nn">litestar.types</span><span class="w"> </span><span class="kn">import</span> <span class="n">ASGIApp</span><span class="p">,</span> <span class="n">Receive</span><span class="p">,</span> <span class="n">Scope</span><span class="p">,</span> <span class="n">Send</span><span class="p">,</span> <span class="n">Message</span>
</span><span data-line="17">
</span><span data-line="18">
</span><span data-line="19"><span class="k">class</span><span class="w"> </span><span class="nc">DebugToolbarMiddleware</span><span class="p">(</span><span class="n">AbstractMiddleware</span><span class="p">):</span>
</span><span data-line="20"><span class="w">    </span><span class="sd">&quot;&quot;&quot;ASGI middleware for the debug toolbar.</span>
</span><span data-line="21">
</span><span data-line="22"><span class="sd">    Handles:</span>
</span><span data-line="23"><span class="sd">    - Request/response interception</span>
</span><span data-line="24"><span class="sd">    - Panel data collection coordination</span>
</span><span data-line="25"><span class="sd">    - Toolbar HTML injection</span>
</span><span data-line="26"><span class="sd">    - Server-Timing header generation</span>
</span><span data-line="27"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="28">
</span><span data-line="29">    <span class="n">scopes</span> <span class="o">=</span> <span class="p">{</span><span class="n">ScopeType</span><span class="o">.</span><span class="n">HTTP</span><span class="p">}</span>
</span><span data-line="30">    <span class="n">exclude</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;/_debug_toolbar&quot;</span><span class="p">]</span>
</span><span data-line="31">
</span><span data-line="32">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">:</span> <span class="n">ASGIApp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="33">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</span><span data-line="34">        <span class="bp">self</span><span class="o">.</span><span class="n">_toolbar</span><span class="p">:</span> <span class="n">DebugToolbar</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="35">        <span class="bp">self</span><span class="o">.</span><span class="n">_adapter</span><span class="p">:</span> <span class="n">LitestarAdapter</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="36">
</span><span data-line="37">    <span class="k">def</span><span class="w"> </span><span class="nf">_get_toolbar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">Scope</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DebugToolbar</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="38"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Lazily initialize toolbar from app state.&quot;&quot;&quot;</span>
</span><span data-line="39">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toolbar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="40">            <span class="n">litestar_app</span><span class="p">:</span> <span class="n">Litestar</span> <span class="o">=</span> <span class="n">scope</span><span class="p">[</span><span class="s2">&quot;app&quot;</span><span class="p">]</span>
</span><span data-line="41">            <span class="n">config</span> <span class="o">=</span> <span class="n">litestar_app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;debug_toolbar_config&quot;</span><span class="p">)</span>
</span><span data-line="42">
</span><span data-line="43">            <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
</span><span data-line="44">                <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="45">
</span><span data-line="46">            <span class="bp">self</span><span class="o">.</span><span class="n">_adapter</span> <span class="o">=</span> <span class="n">LitestarAdapter</span><span class="p">(</span><span class="n">litestar_app</span><span class="p">)</span>
</span><span data-line="47">            <span class="bp">self</span><span class="o">.</span><span class="n">_toolbar</span> <span class="o">=</span> <span class="n">DebugToolbar</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">adapter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_adapter</span><span class="p">)</span>
</span><span data-line="48">
</span><span data-line="49">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toolbar</span>
</span><span data-line="50">
</span><span data-line="51">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
</span><span data-line="52">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="53">        <span class="n">scope</span><span class="p">:</span> <span class="n">Scope</span><span class="p">,</span>
</span><span data-line="54">        <span class="n">receive</span><span class="p">:</span> <span class="n">Receive</span><span class="p">,</span>
</span><span data-line="55">        <span class="n">send</span><span class="p">:</span> <span class="n">Send</span><span class="p">,</span>
</span><span data-line="56">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="57"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Process request through toolbar.&quot;&quot;&quot;</span>
</span><span data-line="58">        <span class="n">toolbar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_toolbar</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
</span><span data-line="59">
</span><span data-line="60">        <span class="k">if</span> <span class="n">toolbar</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">toolbar</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">should_show_toolbar</span><span class="p">(</span><span class="n">scope</span><span class="p">):</span>
</span><span data-line="61">            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">receive</span><span class="p">,</span> <span class="n">send</span><span class="p">)</span>
</span><span data-line="62">            <span class="k">return</span>
</span><span data-line="63">
</span><span data-line="64">        <span class="c1"># Initialize request context</span>
</span><span data-line="65">        <span class="n">request_id</span> <span class="o">=</span> <span class="k">await</span> <span class="n">toolbar</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
</span><span data-line="66">
</span><span data-line="67">        <span class="c1"># Capture response</span>
</span><span data-line="68">        <span class="n">response_started</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="69">        <span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
</span><span data-line="70">        <span class="n">response_headers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="71">        <span class="n">body_parts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="72">
</span><span data-line="73">        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">capture_send</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="74">            <span class="k">nonlocal</span> <span class="n">response_started</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">response_headers</span>
</span><span data-line="75">
</span><span data-line="76">            <span class="k">if</span> <span class="n">message</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;http.response.start&quot;</span><span class="p">:</span>
</span><span data-line="77">                <span class="n">response_started</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="78">                <span class="n">status_code</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span>
</span><span data-line="79">                <span class="n">response_headers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;headers&quot;</span><span class="p">,</span> <span class="p">[]))</span>
</span><span data-line="80">            <span class="k">elif</span> <span class="n">message</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;http.response.body&quot;</span><span class="p">:</span>
</span><span data-line="81">                <span class="n">body</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span data-line="82">                <span class="k">if</span> <span class="n">body</span><span class="p">:</span>
</span><span data-line="83">                    <span class="n">body_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
</span><span data-line="84">
</span><span data-line="85">                <span class="c1"># Only send on final body chunk</span>
</span><span data-line="86">                <span class="n">more_body</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;more_body&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span data-line="87">                <span class="k">if</span> <span class="ow">not</span> <span class="n">more_body</span><span class="p">:</span>
</span><span data-line="88">                    <span class="c1"># Process response through toolbar</span>
</span><span data-line="89">                    <span class="n">full_body</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">body_parts</span><span class="p">)</span>
</span><span data-line="90">                    <span class="k">await</span> <span class="n">toolbar</span><span class="o">.</span><span class="n">process_response</span><span class="p">(</span>
</span><span data-line="91">                        <span class="n">scope</span><span class="p">,</span>
</span><span data-line="92">                        <span class="n">status_code</span><span class="p">,</span>
</span><span data-line="93">                        <span class="n">response_headers</span><span class="p">,</span>
</span><span data-line="94">                        <span class="n">full_body</span><span class="p">,</span>
</span><span data-line="95">                    <span class="p">)</span>
</span><span data-line="96">
</span><span data-line="97">                    <span class="c1"># Inject toolbar if appropriate</span>
</span><span data-line="98">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_inject</span><span class="p">(</span><span class="n">response_headers</span><span class="p">):</span>
</span><span data-line="99">                        <span class="n">full_body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inject_toolbar</span><span class="p">(</span>
</span><span data-line="100">                            <span class="n">toolbar</span><span class="p">,</span>
</span><span data-line="101">                            <span class="n">request_id</span><span class="p">,</span>
</span><span data-line="102">                            <span class="n">full_body</span><span class="p">,</span>
</span><span data-line="103">                        <span class="p">)</span>
</span><span data-line="104">
</span><span data-line="105">                    <span class="c1"># Add Server-Timing header</span>
</span><span data-line="106">                    <span class="n">server_timing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_server_timing</span><span class="p">(</span><span class="n">toolbar</span><span class="p">)</span>
</span><span data-line="107">                    <span class="k">if</span> <span class="n">server_timing</span><span class="p">:</span>
</span><span data-line="108">                        <span class="n">response_headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span data-line="109">                            <span class="p">(</span><span class="sa">b</span><span class="s2">&quot;Server-Timing&quot;</span><span class="p">,</span> <span class="n">server_timing</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span><span data-line="110">                        <span class="p">)</span>
</span><span data-line="111">
</span><span data-line="112">                    <span class="c1"># Update content-length</span>
</span><span data-line="113">                    <span class="n">response_headers</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="114">                        <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">response_headers</span>
</span><span data-line="115">                        <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="sa">b</span><span class="s2">&quot;content-length&quot;</span>
</span><span data-line="116">                    <span class="p">]</span>
</span><span data-line="117">                    <span class="n">response_headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span data-line="118">                        <span class="p">(</span><span class="sa">b</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">full_body</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span><span data-line="119">                    <span class="p">)</span>
</span><span data-line="120">
</span><span data-line="121">                    <span class="c1"># Send modified response</span>
</span><span data-line="122">                    <span class="k">await</span> <span class="n">send</span><span class="p">({</span>
</span><span data-line="123">                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;http.response.start&quot;</span><span class="p">,</span>
</span><span data-line="124">                        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">status_code</span><span class="p">,</span>
</span><span data-line="125">                        <span class="s2">&quot;headers&quot;</span><span class="p">:</span> <span class="n">response_headers</span><span class="p">,</span>
</span><span data-line="126">                    <span class="p">})</span>
</span><span data-line="127">                    <span class="k">await</span> <span class="n">send</span><span class="p">({</span>
</span><span data-line="128">                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;http.response.body&quot;</span><span class="p">,</span>
</span><span data-line="129">                        <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="n">full_body</span><span class="p">,</span>
</span><span data-line="130">                        <span class="s2">&quot;more_body&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="131">                    <span class="p">})</span>
</span><span data-line="132">                    <span class="k">return</span>
</span><span data-line="133">
</span><span data-line="134">            <span class="c1"># Pass through for non-final messages</span>
</span><span data-line="135">            <span class="k">if</span> <span class="n">message</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;http.response.start&quot;</span><span class="p">:</span>
</span><span data-line="136">                <span class="k">return</span>  <span class="c1"># Will be sent with body</span>
</span><span data-line="137">            <span class="k">await</span> <span class="n">send</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span data-line="138">
</span><span data-line="139">        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">receive</span><span class="p">,</span> <span class="n">capture_send</span><span class="p">)</span>
</span><span data-line="140">
</span><span data-line="141">    <span class="k">def</span><span class="w"> </span><span class="nf">_should_inject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="142"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if toolbar should be injected based on content type.&quot;&quot;&quot;</span>
</span><span data-line="143">        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
</span><span data-line="144">            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;content-type&quot;</span><span class="p">:</span>
</span><span data-line="145">                <span class="n">content_type</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;latin-1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span data-line="146">                <span class="k">return</span> <span class="s2">&quot;text/html&quot;</span> <span class="ow">in</span> <span class="n">content_type</span>
</span><span data-line="147">        <span class="k">return</span> <span class="kc">False</span>
</span><span data-line="148">
</span><span data-line="149">    <span class="k">def</span><span class="w"> </span><span class="nf">_inject_toolbar</span><span class="p">(</span>
</span><span data-line="150">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="151">        <span class="n">toolbar</span><span class="p">:</span> <span class="n">DebugToolbar</span><span class="p">,</span>
</span><span data-line="152">        <span class="n">request_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span data-line="153">        <span class="n">body</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
</span><span data-line="154">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span><span data-line="155"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Inject toolbar HTML into response body.&quot;&quot;&quot;</span>
</span><span data-line="156">        <span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.rendering.jinja</span><span class="w"> </span><span class="kn">import</span> <span class="n">JinjaTemplateEngine</span>
</span><span data-line="157">
</span><span data-line="158">        <span class="n">engine</span> <span class="o">=</span> <span class="n">JinjaTemplateEngine</span><span class="p">()</span>
</span><span data-line="159">        <span class="n">toolbar_html</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">render_toolbar</span><span class="p">(</span><span class="n">toolbar</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>
</span><span data-line="160">
</span><span data-line="161">        <span class="n">insert_before</span> <span class="o">=</span> <span class="n">toolbar</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">insert_before</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span><span data-line="162">        <span class="k">if</span> <span class="n">insert_before</span> <span class="ow">in</span> <span class="n">body</span><span class="p">:</span>
</span><span data-line="163">            <span class="k">return</span> <span class="n">body</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">insert_before</span><span class="p">,</span> <span class="n">toolbar_html</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="n">insert_before</span><span class="p">)</span>
</span><span data-line="164">
</span><span data-line="165">        <span class="k">return</span> <span class="n">body</span> <span class="o">+</span> <span class="n">toolbar_html</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span><span data-line="166">
</span><span data-line="167">    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_server_timing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">toolbar</span><span class="p">:</span> <span class="n">DebugToolbar</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="168"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate Server-Timing header from all panels.&quot;&quot;&quot;</span>
</span><span data-line="169">        <span class="n">timings</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="170">        <span class="k">for</span> <span class="n">panel</span> <span class="ow">in</span> <span class="n">toolbar</span><span class="o">.</span><span class="n">get_panels</span><span class="p">():</span>
</span><span data-line="171">            <span class="k">if</span> <span class="n">panel</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
</span><span data-line="172">                <span class="n">timing</span> <span class="o">=</span> <span class="n">panel</span><span class="o">.</span><span class="n">generate_server_timing</span><span class="p">()</span>
</span><span data-line="173">                <span class="k">if</span> <span class="n">timing</span><span class="p">:</span>
</span><span data-line="174">                    <span class="n">timings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timing</span><span class="p">)</span>
</span><span data-line="175">        <span class="k">return</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timings</span><span class="p">)</span>
</span></pre></div>
</div>
</section>
<section id="litestar-adapter">
<h3>6.3 Litestar Adapter<a class="headerlink" href="#litestar-adapter" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># src/litestar_debug_toolbar/adapter.py</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span data-line="3">
</span><span data-line="4"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span>
</span><span data-line="5">
</span><span data-line="6"><span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.adapters.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">ASGIAdapter</span>
</span><span data-line="7">
</span><span data-line="8"><span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="9">    <span class="kn">from</span><span class="w"> </span><span class="nn">litestar</span><span class="w"> </span><span class="kn">import</span> <span class="n">Litestar</span>
</span><span data-line="10">    <span class="kn">from</span><span class="w"> </span><span class="nn">litestar.routes</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTTPRoute</span>
</span><span data-line="11">
</span><span data-line="12">
</span><span data-line="13"><span class="k">class</span><span class="w"> </span><span class="nc">LitestarAdapter</span><span class="p">(</span><span class="n">ASGIAdapter</span><span class="p">):</span>
</span><span data-line="14"><span class="w">    </span><span class="sd">&quot;&quot;&quot;ASGI adapter for Litestar framework.&quot;&quot;&quot;</span>
</span><span data-line="15">
</span><span data-line="16">    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;_app&quot;</span><span class="p">,)</span>
</span><span data-line="17">
</span><span data-line="18">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">:</span> <span class="n">Litestar</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="19">        <span class="bp">self</span><span class="o">.</span><span class="n">_app</span> <span class="o">=</span> <span class="n">app</span>
</span><span data-line="20">
</span><span data-line="21">    <span class="k">def</span><span class="w"> </span><span class="nf">get_routes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span data-line="22"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract routes from Litestar application.&quot;&quot;&quot;</span>
</span><span data-line="23">        <span class="n">routes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="24">
</span><span data-line="25">        <span class="k">for</span> <span class="n">route</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">routes</span><span class="p">:</span>
</span><span data-line="26">            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">route</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">):</span>
</span><span data-line="27">                <span class="n">route_info</span> <span class="o">=</span> <span class="p">{</span>
</span><span data-line="28">                    <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">route</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
</span><span data-line="29">                    <span class="s2">&quot;methods&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span data-line="30">                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">route</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span><span data-line="31">                    <span class="s2">&quot;handler&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="32">                <span class="p">}</span>
</span><span data-line="33">
</span><span data-line="34">                <span class="c1"># Extract methods and handler info</span>
</span><span data-line="35">                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">route</span><span class="p">,</span> <span class="s2">&quot;route_handlers&quot;</span><span class="p">):</span>
</span><span data-line="36">                    <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">route</span><span class="o">.</span><span class="n">route_handlers</span><span class="p">:</span>
</span><span data-line="37">                        <span class="n">route_info</span><span class="p">[</span><span class="s2">&quot;methods&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
</span><span data-line="38">                            <span class="nb">list</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">http_methods</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="s2">&quot;http_methods&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
</span><span data-line="39">                        <span class="p">)</span>
</span><span data-line="40">                        <span class="n">route_info</span><span class="p">[</span><span class="s2">&quot;handler&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">handler</span><span class="o">.</span><span class="n">fn</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">handler</span><span class="o">.</span><span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span data-line="41">
</span><span data-line="42">                <span class="n">routes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">route_info</span><span class="p">)</span>
</span><span data-line="43">
</span><span data-line="44">        <span class="k">return</span> <span class="n">routes</span>
</span><span data-line="45">
</span><span data-line="46">    <span class="k">def</span><span class="w"> </span><span class="nf">get_request_body</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bytes</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="47"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get request body from scope extensions.&quot;&quot;&quot;</span>
</span><span data-line="48">        <span class="k">return</span> <span class="n">scope</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_debug_toolbar_body&quot;</span><span class="p">)</span>
</span><span data-line="49">
</span><span data-line="50">    <span class="k">def</span><span class="w"> </span><span class="nf">get_response_body</span><span class="p">(</span>
</span><span data-line="51">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="52">        <span class="n">scope</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span data-line="53">        <span class="n">body</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
</span><span data-line="54">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span><span data-line="55"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return response body as-is.&quot;&quot;&quot;</span>
</span><span data-line="56">        <span class="k">return</span> <span class="n">body</span>
</span><span data-line="57">
</span><span data-line="58">    <span class="k">def</span><span class="w"> </span><span class="nf">should_inject_toolbar</span><span class="p">(</span>
</span><span data-line="59">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="60">        <span class="n">scope</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span data-line="61">        <span class="n">headers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]],</span>
</span><span data-line="62">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="63"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if toolbar should be injected.&quot;&quot;&quot;</span>
</span><span data-line="64">        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
</span><span data-line="65">            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;content-type&quot;</span><span class="p">:</span>
</span><span data-line="66">                <span class="n">content_type</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;latin-1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span data-line="67">                <span class="k">return</span> <span class="s2">&quot;text/html&quot;</span> <span class="ow">in</span> <span class="n">content_type</span>
</span><span data-line="68">        <span class="k">return</span> <span class="kc">False</span>
</span><span data-line="69">
</span><span data-line="70">    <span class="k">def</span><span class="w"> </span><span class="nf">inject_toolbar</span><span class="p">(</span>
</span><span data-line="71">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="72">        <span class="n">body</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
</span><span data-line="73">        <span class="n">toolbar_html</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span data-line="74">        <span class="n">insert_before</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span data-line="75">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span><span data-line="76"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Inject toolbar HTML into response.&quot;&quot;&quot;</span>
</span><span data-line="77">        <span class="n">marker</span> <span class="o">=</span> <span class="n">insert_before</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span><span data-line="78">        <span class="k">if</span> <span class="n">marker</span> <span class="ow">in</span> <span class="n">body</span><span class="p">:</span>
</span><span data-line="79">            <span class="k">return</span> <span class="n">body</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">marker</span><span class="p">,</span> <span class="n">toolbar_html</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="n">marker</span><span class="p">)</span>
</span><span data-line="80">        <span class="k">return</span> <span class="n">body</span> <span class="o">+</span> <span class="n">toolbar_html</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span><span data-line="81">
</span><span data-line="82">    <span class="k">def</span><span class="w"> </span><span class="nf">get_dependency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span data-line="83"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get Litestar dependency by name.&quot;&quot;&quot;</span>
</span><span data-line="84">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span></pre></div>
</div>
</section>
<section id="toolbar-route-handlers">
<h3>6.4 Toolbar Route Handlers<a class="headerlink" href="#toolbar-route-handlers" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># src/litestar_debug_toolbar/handlers.py</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span data-line="3">
</span><span data-line="4"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span>
</span><span data-line="5">
</span><span data-line="6"><span class="kn">from</span><span class="w"> </span><span class="nn">litestar</span><span class="w"> </span><span class="kn">import</span> <span class="n">Controller</span><span class="p">,</span> <span class="n">get</span><span class="p">,</span> <span class="n">Response</span>
</span><span data-line="7"><span class="kn">from</span><span class="w"> </span><span class="nn">litestar.response</span><span class="w"> </span><span class="kn">import</span> <span class="n">Template</span>
</span><span data-line="8"><span class="kn">from</span><span class="w"> </span><span class="nn">litestar.status_codes</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTTP_200_OK</span><span class="p">,</span> <span class="n">HTTP_404_NOT_FOUND</span>
</span><span data-line="9">
</span><span data-line="10"><span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="11">    <span class="kn">from</span><span class="w"> </span><span class="nn">litestar</span><span class="w"> </span><span class="kn">import</span> <span class="n">Request</span>
</span><span data-line="12">    <span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">DebugToolbarConfig</span>
</span><span data-line="13">
</span><span data-line="14">
</span><span data-line="15"><span class="k">def</span><span class="w"> </span><span class="nf">create_toolbar_handlers</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">DebugToolbarConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">type</span><span class="p">]:</span>
</span><span data-line="16"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create route handlers for toolbar API.&quot;&quot;&quot;</span>
</span><span data-line="17">
</span><span data-line="18">    <span class="k">class</span><span class="w"> </span><span class="nc">DebugToolbarController</span><span class="p">(</span><span class="n">Controller</span><span class="p">):</span>
</span><span data-line="19"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Controller for debug toolbar endpoints.&quot;&quot;&quot;</span>
</span><span data-line="20">
</span><span data-line="21">        <span class="n">path</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">root_path</span>
</span><span data-line="22">        <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Debug Toolbar&quot;</span><span class="p">]</span>
</span><span data-line="23">
</span><span data-line="24">        <span class="nd">@get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
</span><span data-line="25">        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">toolbar_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
</span><span data-line="26"><span class="w">            </span><span class="sd">&quot;&quot;&quot;Toolbar index page showing request history.&quot;&quot;&quot;</span>
</span><span data-line="27">            <span class="n">toolbar</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;debug_toolbar&quot;</span><span class="p">)</span>
</span><span data-line="28">            <span class="k">if</span> <span class="n">toolbar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="29">                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
</span><span data-line="30">                    <span class="n">content</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Toolbar not initialized&quot;</span><span class="p">},</span>
</span><span data-line="31">                    <span class="n">status_code</span><span class="o">=</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">,</span>
</span><span data-line="32">                <span class="p">)</span>
</span><span data-line="33">
</span><span data-line="34">            <span class="n">history</span> <span class="o">=</span> <span class="n">toolbar</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">get_history</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
</span><span data-line="35">            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
</span><span data-line="36">                <span class="n">content</span><span class="o">=</span><span class="p">{</span>
</span><span data-line="37">                    <span class="s2">&quot;history&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span data-line="38">                        <span class="p">{</span>
</span><span data-line="39">                            <span class="s2">&quot;request_id&quot;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span>
</span><span data-line="40">                            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span data-line="41">                            <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
</span><span data-line="42">                            <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
</span><span data-line="43">                            <span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
</span><span data-line="44">                            <span class="s2">&quot;duration_ms&quot;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">duration_ms</span><span class="p">,</span>
</span><span data-line="45">                        <span class="p">}</span>
</span><span data-line="46">                        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">history</span>
</span><span data-line="47">                    <span class="p">],</span>
</span><span data-line="48">                <span class="p">},</span>
</span><span data-line="49">            <span class="p">)</span>
</span><span data-line="50">
</span><span data-line="51">        <span class="nd">@get</span><span class="p">(</span><span class="s2">&quot;/request/{request_id:str}&quot;</span><span class="p">)</span>
</span><span data-line="52">        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">toolbar_request</span><span class="p">(</span>
</span><span data-line="53">            <span class="bp">self</span><span class="p">,</span>
</span><span data-line="54">            <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
</span><span data-line="55">            <span class="n">request_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span data-line="56">        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
</span><span data-line="57"><span class="w">            </span><span class="sd">&quot;&quot;&quot;Get toolbar data for a specific request.&quot;&quot;&quot;</span>
</span><span data-line="58">            <span class="n">toolbar</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;debug_toolbar&quot;</span><span class="p">)</span>
</span><span data-line="59">            <span class="k">if</span> <span class="n">toolbar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="60">                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
</span><span data-line="61">                    <span class="n">content</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Toolbar not initialized&quot;</span><span class="p">},</span>
</span><span data-line="62">                    <span class="n">status_code</span><span class="o">=</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">,</span>
</span><span data-line="63">                <span class="p">)</span>
</span><span data-line="64">
</span><span data-line="65">            <span class="n">record</span> <span class="o">=</span> <span class="n">toolbar</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request_id</span><span class="p">)</span>
</span><span data-line="66">            <span class="k">if</span> <span class="n">record</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="67">                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
</span><span data-line="68">                    <span class="n">content</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Request not found&quot;</span><span class="p">},</span>
</span><span data-line="69">                    <span class="n">status_code</span><span class="o">=</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">,</span>
</span><span data-line="70">                <span class="p">)</span>
</span><span data-line="71">
</span><span data-line="72">            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
</span><span data-line="73">                <span class="n">content</span><span class="o">=</span><span class="p">{</span>
</span><span data-line="74">                    <span class="s2">&quot;request_id&quot;</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span>
</span><span data-line="75">                    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span data-line="76">                    <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
</span><span data-line="77">                    <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
</span><span data-line="78">                    <span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
</span><span data-line="79">                    <span class="s2">&quot;duration_ms&quot;</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">duration_ms</span><span class="p">,</span>
</span><span data-line="80">                    <span class="s2">&quot;panels&quot;</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">panels_data</span><span class="p">,</span>
</span><span data-line="81">                <span class="p">},</span>
</span><span data-line="82">            <span class="p">)</span>
</span><span data-line="83">
</span><span data-line="84">        <span class="nd">@get</span><span class="p">(</span><span class="s2">&quot;/panel/{request_id:str}/{panel_id:str}&quot;</span><span class="p">)</span>
</span><span data-line="85">        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">toolbar_panel</span><span class="p">(</span>
</span><span data-line="86">            <span class="bp">self</span><span class="p">,</span>
</span><span data-line="87">            <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
</span><span data-line="88">            <span class="n">request_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span data-line="89">            <span class="n">panel_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span data-line="90">        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
</span><span data-line="91"><span class="w">            </span><span class="sd">&quot;&quot;&quot;Get specific panel data for a request.&quot;&quot;&quot;</span>
</span><span data-line="92">            <span class="n">toolbar</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;debug_toolbar&quot;</span><span class="p">)</span>
</span><span data-line="93">            <span class="k">if</span> <span class="n">toolbar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="94">                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
</span><span data-line="95">                    <span class="n">content</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Toolbar not initialized&quot;</span><span class="p">},</span>
</span><span data-line="96">                    <span class="n">status_code</span><span class="o">=</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">,</span>
</span><span data-line="97">                <span class="p">)</span>
</span><span data-line="98">
</span><span data-line="99">            <span class="n">record</span> <span class="o">=</span> <span class="n">toolbar</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request_id</span><span class="p">)</span>
</span><span data-line="100">            <span class="k">if</span> <span class="n">record</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="101">                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
</span><span data-line="102">                    <span class="n">content</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Request not found&quot;</span><span class="p">},</span>
</span><span data-line="103">                    <span class="n">status_code</span><span class="o">=</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">,</span>
</span><span data-line="104">                <span class="p">)</span>
</span><span data-line="105">
</span><span data-line="106">            <span class="n">panel_data</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">panels_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">panel_id</span><span class="p">)</span>
</span><span data-line="107">            <span class="k">if</span> <span class="n">panel_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="108">                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
</span><span data-line="109">                    <span class="n">content</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Panel not found&quot;</span><span class="p">},</span>
</span><span data-line="110">                    <span class="n">status_code</span><span class="o">=</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">,</span>
</span><span data-line="111">                <span class="p">)</span>
</span><span data-line="112">
</span><span data-line="113">            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">panel_data</span><span class="p">)</span>
</span><span data-line="114">
</span><span data-line="115">        <span class="nd">@get</span><span class="p">(</span><span class="s2">&quot;/static/{path:path}&quot;</span><span class="p">)</span>
</span><span data-line="116">        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">toolbar_static</span><span class="p">(</span>
</span><span data-line="117">            <span class="bp">self</span><span class="p">,</span>
</span><span data-line="118">            <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
</span><span data-line="119">            <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span data-line="120">        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
</span><span data-line="121"><span class="w">            </span><span class="sd">&quot;&quot;&quot;Serve static assets for toolbar.&quot;&quot;&quot;</span>
</span><span data-line="122">            <span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
</span><span data-line="123">            <span class="kn">import</span><span class="w"> </span><span class="nn">mimetypes</span>
</span><span data-line="124">
</span><span data-line="125">            <span class="n">assets_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;async_debug_toolbar&quot;</span> <span class="o">/</span> <span class="s2">&quot;assets&quot;</span>
</span><span data-line="126">            <span class="n">file_path</span> <span class="o">=</span> <span class="n">assets_dir</span> <span class="o">/</span> <span class="n">path</span>
</span><span data-line="127">
</span><span data-line="128">            <span class="k">if</span> <span class="ow">not</span> <span class="n">file_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">file_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
</span><span data-line="129">                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
</span><span data-line="130">                    <span class="n">content</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;File not found&quot;</span><span class="p">},</span>
</span><span data-line="131">                    <span class="n">status_code</span><span class="o">=</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">,</span>
</span><span data-line="132">                <span class="p">)</span>
</span><span data-line="133">
</span><span data-line="134">            <span class="n">content_type</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mimetypes</span><span class="o">.</span><span class="n">guess_type</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
</span><span data-line="135">            <span class="n">content</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">()</span>
</span><span data-line="136">
</span><span data-line="137">            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
</span><span data-line="138">                <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
</span><span data-line="139">                <span class="n">media_type</span><span class="o">=</span><span class="n">content_type</span> <span class="ow">or</span> <span class="s2">&quot;application/octet-stream&quot;</span><span class="p">,</span>
</span><span data-line="140">            <span class="p">)</span>
</span><span data-line="141">
</span><span data-line="142">    <span class="k">return</span> <span class="p">[</span><span class="n">DebugToolbarController</span><span class="p">]</span>
</span></pre></div>
</div>
</section>
<section id="litestar-routes-panel">
<h3>6.5 Litestar Routes Panel<a class="headerlink" href="#litestar-routes-panel" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># src/litestar_debug_toolbar/panels/routes.py</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span data-line="3">
</span><span data-line="4"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">ClassVar</span><span class="p">,</span> <span class="n">TYPE_CHECKING</span>
</span><span data-line="5">
</span><span data-line="6"><span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.panels.routes</span><span class="w"> </span><span class="kn">import</span> <span class="n">RoutesPanel</span>
</span><span data-line="7">
</span><span data-line="8"><span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="9">    <span class="kn">from</span><span class="w"> </span><span class="nn">litestar</span><span class="w"> </span><span class="kn">import</span> <span class="n">Litestar</span>
</span><span data-line="10">
</span><span data-line="11">
</span><span data-line="12"><span class="k">class</span><span class="w"> </span><span class="nc">LitestarRoutesPanel</span><span class="p">(</span><span class="n">RoutesPanel</span><span class="p">):</span>
</span><span data-line="13"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Enhanced routes panel for Litestar applications.&quot;&quot;&quot;</span>
</span><span data-line="14">
</span><span data-line="15">    <span class="n">panel_id</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;litestar_routes&quot;</span>
</span><span data-line="16">    <span class="n">title</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Routes&quot;</span>
</span><span data-line="17">    <span class="n">template</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;panels/litestar_routes.html&quot;</span>
</span><span data-line="18">
</span><span data-line="19">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span data-line="20"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate Litestar-specific route information.&quot;&quot;&quot;</span>
</span><span data-line="21">        <span class="n">adapter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toolbar</span><span class="o">.</span><span class="n">adapter</span>
</span><span data-line="22">        <span class="n">base_routes</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">.</span><span class="n">get_routes</span><span class="p">()</span>
</span><span data-line="23">
</span><span data-line="24">        <span class="c1"># Enhance with Litestar-specific metadata</span>
</span><span data-line="25">        <span class="n">enhanced_routes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="26">        <span class="k">for</span> <span class="n">route</span> <span class="ow">in</span> <span class="n">base_routes</span><span class="p">:</span>
</span><span data-line="27">            <span class="n">enhanced</span> <span class="o">=</span> <span class="p">{</span>
</span><span data-line="28">                <span class="o">**</span><span class="n">route</span><span class="p">,</span>
</span><span data-line="29">                <span class="s2">&quot;guards&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span data-line="30">                <span class="s2">&quot;dependencies&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span data-line="31">                <span class="s2">&quot;middleware&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span data-line="32">                <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span data-line="33">            <span class="p">}</span>
</span><span data-line="34">            <span class="n">enhanced_routes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">enhanced</span><span class="p">)</span>
</span><span data-line="35">
</span><span data-line="36">        <span class="c1"># Group by tags</span>
</span><span data-line="37">        <span class="n">by_tag</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="38">        <span class="k">for</span> <span class="n">route</span> <span class="ow">in</span> <span class="n">enhanced_routes</span><span class="p">:</span>
</span><span data-line="39">            <span class="n">tags</span> <span class="o">=</span> <span class="n">route</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;untagged&quot;</span><span class="p">])</span>
</span><span data-line="40">            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
</span><span data-line="41">                <span class="k">if</span> <span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">by_tag</span><span class="p">:</span>
</span><span data-line="42">                    <span class="n">by_tag</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="43">                <span class="n">by_tag</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">route</span><span class="p">)</span>
</span><span data-line="44">
</span><span data-line="45">        <span class="k">return</span> <span class="p">{</span>
</span><span data-line="46">            <span class="s2">&quot;routes&quot;</span><span class="p">:</span> <span class="n">enhanced_routes</span><span class="p">,</span>
</span><span data-line="47">            <span class="s2">&quot;by_tag&quot;</span><span class="p">:</span> <span class="n">by_tag</span><span class="p">,</span>
</span><span data-line="48">            <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">enhanced_routes</span><span class="p">),</span>
</span><span data-line="49">        <span class="p">}</span>
</span></pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="advanced-alchemy-integration">
<h2>7. Advanced-Alchemy Integration<a class="headerlink" href="#advanced-alchemy-integration" title="Link to this heading">¶</a></h2>
<section id="sqlalchemy-panel">
<h3>7.1 SQLAlchemy Panel<a class="headerlink" href="#sqlalchemy-panel" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># extras/advanced_alchemy/panel.py</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span data-line="3">
</span><span data-line="4"><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span data-line="5"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">ClassVar</span><span class="p">,</span> <span class="n">TYPE_CHECKING</span>
</span><span data-line="6"><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
</span><span data-line="7">
</span><span data-line="8"><span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.panel</span><span class="w"> </span><span class="kn">import</span> <span class="n">Panel</span>
</span><span data-line="9"><span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.context</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_request_context</span>
</span><span data-line="10">
</span><span data-line="11"><span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="12">    <span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.engine</span><span class="w"> </span><span class="kn">import</span> <span class="n">Engine</span>
</span><span data-line="13">    <span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.ext.asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncEngine</span>
</span><span data-line="14">
</span><span data-line="15">
</span><span data-line="16"><span class="nd">@dataclass</span>
</span><span data-line="17"><span class="k">class</span><span class="w"> </span><span class="nc">QueryRecord</span><span class="p">:</span>
</span><span data-line="18"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Record of a single database query.&quot;&quot;&quot;</span>
</span><span data-line="19">
</span><span data-line="20">    <span class="n">sql</span><span class="p">:</span> <span class="nb">str</span>
</span><span data-line="21">    <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span> <span class="o">|</span> <span class="kc">None</span>
</span><span data-line="22">    <span class="n">duration_ms</span><span class="p">:</span> <span class="nb">float</span>
</span><span data-line="23">    <span class="n">stack_trace</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="24">    <span class="n">explain_plan</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="25">    <span class="n">is_select</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="26">    <span class="n">rows_affected</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="27">
</span><span data-line="28">
</span><span data-line="29"><span class="k">class</span><span class="w"> </span><span class="nc">SQLAlchemyPanel</span><span class="p">(</span><span class="n">Panel</span><span class="p">):</span>
</span><span data-line="30"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Panel for SQLAlchemy query tracking and analysis.</span>
</span><span data-line="31">
</span><span data-line="32"><span class="sd">    Features:</span>
</span><span data-line="33"><span class="sd">    - Query capture with timing</span>
</span><span data-line="34"><span class="sd">    - EXPLAIN plan generation (optional)</span>
</span><span data-line="35"><span class="sd">    - Query deduplication detection</span>
</span><span data-line="36"><span class="sd">    - N+1 query detection</span>
</span><span data-line="37"><span class="sd">    - Stack trace capture</span>
</span><span data-line="38"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="39">
</span><span data-line="40">    <span class="n">panel_id</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;sqlalchemy&quot;</span>
</span><span data-line="41">    <span class="n">title</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;SQLAlchemy&quot;</span>
</span><span data-line="42">    <span class="n">template</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;panels/sqlalchemy.html&quot;</span>
</span><span data-line="43">    <span class="n">weight</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50</span>
</span><span data-line="44">
</span><span data-line="45">    <span class="n">_queries</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">QueryRecord</span><span class="p">]</span>
</span><span data-line="46">    <span class="n">_enable_explain</span><span class="p">:</span> <span class="nb">bool</span>
</span><span data-line="47">    <span class="n">_capture_stack</span><span class="p">:</span> <span class="nb">bool</span>
</span><span data-line="48">
</span><span data-line="49">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="50">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="51">        <span class="bp">self</span><span class="o">.</span><span class="n">_queries</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="52">
</span><span data-line="53">        <span class="c1"># Panel-specific options</span>
</span><span data-line="54">        <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">panel_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sqlalchemy&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span data-line="55">        <span class="bp">self</span><span class="o">.</span><span class="n">_enable_explain</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enable_explain&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span data-line="56">        <span class="bp">self</span><span class="o">.</span><span class="n">_capture_stack</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capture_stack&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span data-line="57">
</span><span data-line="58">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="59"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset query list for new request.&quot;&quot;&quot;</span>
</span><span data-line="60">        <span class="bp">self</span><span class="o">.</span><span class="n">_queries</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="61">
</span><span data-line="62">    <span class="k">def</span><span class="w"> </span><span class="nf">record_query</span><span class="p">(</span>
</span><span data-line="63">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="64">        <span class="n">sql</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span data-line="65">        <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="66">        <span class="n">duration_ms</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span data-line="67">        <span class="n">rows_affected</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="68">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="69"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Record a query execution (called from event hooks).&quot;&quot;&quot;</span>
</span><span data-line="70">        <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
</span><span data-line="71">
</span><span data-line="72">        <span class="n">stack_trace</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="73">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capture_stack</span><span class="p">:</span>
</span><span data-line="74">            <span class="n">stack_trace</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_stack</span><span class="p">()[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
</span><span data-line="75">
</span><span data-line="76">        <span class="n">record</span> <span class="o">=</span> <span class="n">QueryRecord</span><span class="p">(</span>
</span><span data-line="77">            <span class="n">sql</span><span class="o">=</span><span class="n">sql</span><span class="p">,</span>
</span><span data-line="78">            <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
</span><span data-line="79">            <span class="n">duration_ms</span><span class="o">=</span><span class="n">duration_ms</span><span class="p">,</span>
</span><span data-line="80">            <span class="n">stack_trace</span><span class="o">=</span><span class="n">stack_trace</span><span class="p">,</span>
</span><span data-line="81">            <span class="n">is_select</span><span class="o">=</span><span class="n">sql</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;SELECT&quot;</span><span class="p">),</span>
</span><span data-line="82">            <span class="n">rows_affected</span><span class="o">=</span><span class="n">rows_affected</span><span class="p">,</span>
</span><span data-line="83">        <span class="p">)</span>
</span><span data-line="84">
</span><span data-line="85">        <span class="bp">self</span><span class="o">.</span><span class="n">_queries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
</span><span data-line="86">
</span><span data-line="87">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span data-line="88"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate query statistics.&quot;&quot;&quot;</span>
</span><span data-line="89">        <span class="n">total_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">duration_ms</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queries</span><span class="p">)</span>
</span><span data-line="90">
</span><span data-line="91">        <span class="c1"># Detect duplicate queries</span>
</span><span data-line="92">        <span class="n">query_counts</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="93">        <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queries</span><span class="p">:</span>
</span><span data-line="94">            <span class="n">sql</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">sql</span>
</span><span data-line="95">            <span class="n">query_counts</span><span class="p">[</span><span class="n">sql</span><span class="p">]</span> <span class="o">=</span> <span class="n">query_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span data-line="96">
</span><span data-line="97">        <span class="n">duplicates</span> <span class="o">=</span> <span class="p">{</span><span class="n">sql</span><span class="p">:</span> <span class="n">count</span> <span class="k">for</span> <span class="n">sql</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">query_counts</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">}</span>
</span><span data-line="98">
</span><span data-line="99">        <span class="c1"># Detect potential N+1 queries</span>
</span><span data-line="100">        <span class="n">n_plus_one</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="101">        <span class="k">for</span> <span class="n">sql</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span data-line="102">            <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="ow">and</span> <span class="s2">&quot;SELECT&quot;</span> <span class="ow">in</span> <span class="n">sql</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
</span><span data-line="103">                <span class="n">n_plus_one</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;sql&quot;</span><span class="p">:</span> <span class="n">sql</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">count</span><span class="p">})</span>
</span><span data-line="104">
</span><span data-line="105">        <span class="c1"># Group by type</span>
</span><span data-line="106">        <span class="n">selects</span> <span class="o">=</span> <span class="p">[</span><span class="n">q</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queries</span> <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">is_select</span><span class="p">]</span>
</span><span data-line="107">        <span class="n">writes</span> <span class="o">=</span> <span class="p">[</span><span class="n">q</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queries</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">q</span><span class="o">.</span><span class="n">is_select</span><span class="p">]</span>
</span><span data-line="108">
</span><span data-line="109">        <span class="k">return</span> <span class="p">{</span>
</span><span data-line="110">            <span class="s2">&quot;queries&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span data-line="111">                <span class="p">{</span>
</span><span data-line="112">                    <span class="s2">&quot;sql&quot;</span><span class="p">:</span> <span class="n">q</span><span class="o">.</span><span class="n">sql</span><span class="p">,</span>
</span><span data-line="113">                    <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">q</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
</span><span data-line="114">                    <span class="s2">&quot;duration_ms&quot;</span><span class="p">:</span> <span class="n">q</span><span class="o">.</span><span class="n">duration_ms</span><span class="p">,</span>
</span><span data-line="115">                    <span class="s2">&quot;stack_trace&quot;</span><span class="p">:</span> <span class="n">q</span><span class="o">.</span><span class="n">stack_trace</span><span class="p">,</span>
</span><span data-line="116">                    <span class="s2">&quot;explain_plan&quot;</span><span class="p">:</span> <span class="n">q</span><span class="o">.</span><span class="n">explain_plan</span><span class="p">,</span>
</span><span data-line="117">                    <span class="s2">&quot;is_select&quot;</span><span class="p">:</span> <span class="n">q</span><span class="o">.</span><span class="n">is_select</span><span class="p">,</span>
</span><span data-line="118">                    <span class="s2">&quot;rows_affected&quot;</span><span class="p">:</span> <span class="n">q</span><span class="o">.</span><span class="n">rows_affected</span><span class="p">,</span>
</span><span data-line="119">                <span class="p">}</span>
</span><span data-line="120">                <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queries</span>
</span><span data-line="121">            <span class="p">],</span>
</span><span data-line="122">            <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_queries</span><span class="p">),</span>
</span><span data-line="123">            <span class="s2">&quot;total_time_ms&quot;</span><span class="p">:</span> <span class="n">total_time</span><span class="p">,</span>
</span><span data-line="124">            <span class="s2">&quot;select_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">selects</span><span class="p">),</span>
</span><span data-line="125">            <span class="s2">&quot;write_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">writes</span><span class="p">),</span>
</span><span data-line="126">            <span class="s2">&quot;duplicates&quot;</span><span class="p">:</span> <span class="n">duplicates</span><span class="p">,</span>
</span><span data-line="127">            <span class="s2">&quot;n_plus_one&quot;</span><span class="p">:</span> <span class="n">n_plus_one</span><span class="p">,</span>
</span><span data-line="128">            <span class="s2">&quot;has_issues&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">duplicates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">n_plus_one</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
</span><span data-line="129">        <span class="p">}</span>
</span><span data-line="130">
</span><span data-line="131">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_response</span><span class="p">(</span>
</span><span data-line="132">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="133">        <span class="n">scope</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span data-line="134">        <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span data-line="135">        <span class="n">headers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]],</span>
</span><span data-line="136">        <span class="n">body</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
</span><span data-line="137">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="138">        <span class="n">stats</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_stats</span><span class="p">()</span>
</span><span data-line="139">        <span class="bp">self</span><span class="o">.</span><span class="n">record_stats</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
</span><span data-line="140">
</span><span data-line="141">    <span class="k">def</span><span class="w"> </span><span class="nf">generate_server_timing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="142">        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stats</span><span class="p">()</span>
</span><span data-line="143">        <span class="n">total</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total_time_ms&quot;</span><span class="p">)</span>
</span><span data-line="144">        <span class="n">count</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span data-line="145">        <span class="k">if</span> <span class="n">total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="146">            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;db;dur=</span><span class="si">{</span><span class="n">total</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">;desc=</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> queries</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
</span><span data-line="147">        <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="148">
</span><span data-line="149">    <span class="nd">@property</span>
</span><span data-line="150">    <span class="k">def</span><span class="w"> </span><span class="nf">nav_subtitle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="151">        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stats</span><span class="p">()</span>
</span><span data-line="152">        <span class="n">count</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span data-line="153">        <span class="n">total</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total_time_ms&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span data-line="154">        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="155">            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">total</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">ms&quot;</span>
</span><span data-line="156">        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
</span></pre></div>
</div>
</section>
<section id="advanced-alchemy-event-hooks">
<h3>7.2 Advanced-Alchemy Event Hooks<a class="headerlink" href="#advanced-alchemy-event-hooks" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># extras/advanced_alchemy/hooks.py</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span data-line="3">
</span><span data-line="4"><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span data-line="5"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span>
</span><span data-line="6">
</span><span data-line="7"><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">event</span>
</span><span data-line="8"><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.engine</span><span class="w"> </span><span class="kn">import</span> <span class="n">Engine</span>
</span><span data-line="9">
</span><span data-line="10"><span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="11">    <span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.engine</span><span class="w"> </span><span class="kn">import</span> <span class="n">Connection</span>
</span><span data-line="12">    <span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.engine.cursor</span><span class="w"> </span><span class="kn">import</span> <span class="n">CursorResult</span>
</span><span data-line="13">
</span><span data-line="14">
</span><span data-line="15"><span class="k">def</span><span class="w"> </span><span class="nf">setup_sqlalchemy_hooks</span><span class="p">(</span><span class="n">panel</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="16"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Set up SQLAlchemy event hooks for query tracking.&quot;&quot;&quot;</span>
</span><span data-line="17">
</span><span data-line="18">    <span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">Engine</span><span class="p">,</span> <span class="s2">&quot;before_cursor_execute&quot;</span><span class="p">)</span>
</span><span data-line="19">    <span class="k">def</span><span class="w"> </span><span class="nf">before_cursor_execute</span><span class="p">(</span>
</span><span data-line="20">        <span class="n">conn</span><span class="p">:</span> <span class="n">Connection</span><span class="p">,</span>
</span><span data-line="21">        <span class="n">cursor</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="22">        <span class="n">statement</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span data-line="23">        <span class="n">parameters</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="24">        <span class="n">context</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="25">        <span class="n">executemany</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span data-line="26">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="27"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Record query start time.&quot;&quot;&quot;</span>
</span><span data-line="28">        <span class="n">conn</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;debug_toolbar_start_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</span><span data-line="29">
</span><span data-line="30">    <span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">Engine</span><span class="p">,</span> <span class="s2">&quot;after_cursor_execute&quot;</span><span class="p">)</span>
</span><span data-line="31">    <span class="k">def</span><span class="w"> </span><span class="nf">after_cursor_execute</span><span class="p">(</span>
</span><span data-line="32">        <span class="n">conn</span><span class="p">:</span> <span class="n">Connection</span><span class="p">,</span>
</span><span data-line="33">        <span class="n">cursor</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="34">        <span class="n">statement</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span data-line="35">        <span class="n">parameters</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="36">        <span class="n">context</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="37">        <span class="n">executemany</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span data-line="38">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="39"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Record query completion and duration.&quot;&quot;&quot;</span>
</span><span data-line="40">        <span class="n">start_time</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;debug_toolbar_start_time&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="41">        <span class="k">if</span> <span class="n">start_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="42">            <span class="k">return</span>
</span><span data-line="43">
</span><span data-line="44">        <span class="n">duration_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
</span><span data-line="45">
</span><span data-line="46">        <span class="c1"># Get rows affected for non-SELECT queries</span>
</span><span data-line="47">        <span class="n">rows_affected</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="48">        <span class="k">if</span> <span class="ow">not</span> <span class="n">statement</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;SELECT&quot;</span><span class="p">):</span>
</span><span data-line="49">            <span class="n">rows_affected</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span>
</span><span data-line="50">
</span><span data-line="51">        <span class="n">panel</span><span class="o">.</span><span class="n">record_query</span><span class="p">(</span>
</span><span data-line="52">            <span class="n">sql</span><span class="o">=</span><span class="n">statement</span><span class="p">,</span>
</span><span data-line="53">            <span class="n">params</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
</span><span data-line="54">            <span class="n">duration_ms</span><span class="o">=</span><span class="n">duration_ms</span><span class="p">,</span>
</span><span data-line="55">            <span class="n">rows_affected</span><span class="o">=</span><span class="n">rows_affected</span><span class="p">,</span>
</span><span data-line="56">        <span class="p">)</span>
</span><span data-line="57">
</span><span data-line="58">
</span><span data-line="59"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">setup_async_hooks</span><span class="p">(</span><span class="n">panel</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">engine</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="60"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Set up hooks for async SQLAlchemy engines.&quot;&quot;&quot;</span>
</span><span data-line="61">    <span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.ext.asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncEngine</span>
</span><span data-line="62">
</span><span data-line="63">    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">AsyncEngine</span><span class="p">):</span>
</span><span data-line="64">        <span class="k">return</span>
</span><span data-line="65">
</span><span data-line="66">    <span class="c1"># Async engine wraps sync engine</span>
</span><span data-line="67">    <span class="n">setup_sqlalchemy_hooks</span><span class="p">(</span><span class="n">panel</span><span class="p">)</span>
</span></pre></div>
</div>
</section>
<section id="integration-with-litestar-plugin">
<h3>7.3 Integration with Litestar Plugin<a class="headerlink" href="#integration-with-litestar-plugin" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># extras/advanced_alchemy/__init__.py</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span data-line="3">
</span><span data-line="4"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span>
</span><span data-line="5">
</span><span data-line="6"><span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">DebugToolbarConfig</span>
</span><span data-line="7">
</span><span data-line="8"><span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="9">    <span class="kn">from</span><span class="w"> </span><span class="nn">litestar</span><span class="w"> </span><span class="kn">import</span> <span class="n">Litestar</span>
</span><span data-line="10">
</span><span data-line="11">
</span><span data-line="12"><span class="k">def</span><span class="w"> </span><span class="nf">configure_advanced_alchemy_panel</span><span class="p">(</span>
</span><span data-line="13">    <span class="n">config</span><span class="p">:</span> <span class="n">DebugToolbarConfig</span><span class="p">,</span>
</span><span data-line="14">    <span class="n">enable_explain</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="15">    <span class="n">capture_stack</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="16"><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="17"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Configure the SQLAlchemy panel for Advanced-Alchemy.</span>
</span><span data-line="18">
</span><span data-line="19"><span class="sd">    Usage:</span>
</span><span data-line="20"><span class="sd">        from async_debug_toolbar.config import DebugToolbarConfig</span>
</span><span data-line="21"><span class="sd">        from async_debug_toolbar.extras.advanced_alchemy import configure_advanced_alchemy_panel</span>
</span><span data-line="22">
</span><span data-line="23"><span class="sd">        config = DebugToolbarConfig()</span>
</span><span data-line="24"><span class="sd">        configure_advanced_alchemy_panel(config, enable_explain=True)</span>
</span><span data-line="25"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="26">    <span class="c1"># Add panel if not present</span>
</span><span data-line="27">    <span class="n">panel_path</span> <span class="o">=</span> <span class="s2">&quot;async_debug_toolbar.extras.advanced_alchemy.panel.SQLAlchemyPanel&quot;</span>
</span><span data-line="28">    <span class="k">if</span> <span class="n">panel_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">panels</span><span class="p">:</span>
</span><span data-line="29">        <span class="c1"># Insert after response panel</span>
</span><span data-line="30">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="31">            <span class="n">idx</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">panels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;async_debug_toolbar.panels.response.ResponsePanel&quot;</span><span class="p">)</span>
</span><span data-line="32">            <span class="n">config</span><span class="o">.</span><span class="n">panels</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">panel_path</span><span class="p">)</span>
</span><span data-line="33">        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span data-line="34">            <span class="n">config</span><span class="o">.</span><span class="n">panels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">panel_path</span><span class="p">)</span>
</span><span data-line="35">
</span><span data-line="36">    <span class="c1"># Configure panel options</span>
</span><span data-line="37">    <span class="n">config</span><span class="o">.</span><span class="n">panel_options</span><span class="p">[</span><span class="s2">&quot;sqlalchemy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span data-line="38">        <span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="39">        <span class="s2">&quot;enable_explain&quot;</span><span class="p">:</span> <span class="n">enable_explain</span><span class="p">,</span>
</span><span data-line="40">        <span class="s2">&quot;capture_stack&quot;</span><span class="p">:</span> <span class="n">capture_stack</span><span class="p">,</span>
</span><span data-line="41">    <span class="p">}</span>
</span><span data-line="42">
</span><span data-line="43">
</span><span data-line="44"><span class="k">def</span><span class="w"> </span><span class="nf">init_advanced_alchemy_hooks</span><span class="p">(</span><span class="n">app</span><span class="p">:</span> <span class="n">Litestar</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="45"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize Advanced-Alchemy hooks after app startup.</span>
</span><span data-line="46">
</span><span data-line="47"><span class="sd">    Call this in your app&#39;s on_startup handler:</span>
</span><span data-line="48">
</span><span data-line="49"><span class="sd">        from async_debug_toolbar.extras.advanced_alchemy import init_advanced_alchemy_hooks</span>
</span><span data-line="50">
</span><span data-line="51"><span class="sd">        async def on_startup(app: Litestar) -&gt; None:</span>
</span><span data-line="52"><span class="sd">            init_advanced_alchemy_hooks(app)</span>
</span><span data-line="53"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="54">    <span class="kn">from</span><span class="w"> </span><span class="nn">advanced_alchemy.extensions.litestar</span><span class="w"> </span><span class="kn">import</span> <span class="n">SQLAlchemyPlugin</span>
</span><span data-line="55">    <span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.extras.advanced_alchemy.hooks</span><span class="w"> </span><span class="kn">import</span> <span class="n">setup_sqlalchemy_hooks</span>
</span><span data-line="56">
</span><span data-line="57">    <span class="n">toolbar</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;debug_toolbar&quot;</span><span class="p">)</span>
</span><span data-line="58">    <span class="k">if</span> <span class="n">toolbar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="59">        <span class="k">return</span>
</span><span data-line="60">
</span><span data-line="61">    <span class="n">panel</span> <span class="o">=</span> <span class="n">toolbar</span><span class="o">.</span><span class="n">get_panel</span><span class="p">(</span><span class="s2">&quot;sqlalchemy&quot;</span><span class="p">)</span>
</span><span data-line="62">    <span class="k">if</span> <span class="n">panel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="63">        <span class="k">return</span>
</span><span data-line="64">
</span><span data-line="65">    <span class="c1"># Find SQLAlchemy plugin and get engine</span>
</span><span data-line="66">    <span class="k">for</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">plugins</span><span class="p">:</span>
</span><span data-line="67">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="n">SQLAlchemyPlugin</span><span class="p">):</span>
</span><span data-line="68">            <span class="c1"># Set up hooks for sync engine</span>
</span><span data-line="69">            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="s2">&quot;engine&quot;</span><span class="p">):</span>
</span><span data-line="70">                <span class="n">setup_sqlalchemy_hooks</span><span class="p">(</span><span class="n">panel</span><span class="p">)</span>
</span><span data-line="71">            <span class="k">break</span>
</span></pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="data-flow">
<h2>8. Data Flow<a class="headerlink" href="#data-flow" title="Link to this heading">¶</a></h2>
<section id="request-lifecycle">
<h3>8.1 Request Lifecycle<a class="headerlink" href="#request-lifecycle" title="Link to this heading">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span data-line="1">                                    ASGI Application
</span><span data-line="2">                                          │
</span><span data-line="3">                                          ▼
</span><span data-line="4">┌─────────────────────────────────────────────────────────────────────────────┐
</span><span data-line="5">│                         DebugToolbarMiddleware                               │
</span><span data-line="6">│                                                                              │
</span><span data-line="7">│   1. Check should_show_toolbar(scope)                                       │
</span><span data-line="8">│      └─► If false, pass through to app                                      │
</span><span data-line="9">│                                                                              │
</span><span data-line="10">│   2. toolbar.process_request(scope)                                         │
</span><span data-line="11">│      ├─► Generate request_id (UUID)                                         │
</span><span data-line="12">│      ├─► Initialize RequestContext (contextvar)                             │
</span><span data-line="13">│      └─► Call panel.process_request() for each enabled panel                │
</span><span data-line="14">│                                                                              │
</span><span data-line="15">│   3. await app(scope, receive, capture_send)                                │
</span><span data-line="16">│      └─► Application processes request                                       │
</span><span data-line="17">│      └─► Panels record data via record_stats()                              │
</span><span data-line="18">│                                                                              │
</span><span data-line="19">│   4. capture_send intercepts response                                        │
</span><span data-line="20">│      ├─► Capture status_code, headers, body                                 │
</span><span data-line="21">│      └─► Call panel.process_response() for each enabled panel               │
</span><span data-line="22">│                                                                              │
</span><span data-line="23">│   5. toolbar.process_response(scope, status, headers, body)                 │
</span><span data-line="24">│      ├─► Finalize panel statistics                                          │
</span><span data-line="25">│      └─► Store in ToolbarStorage (LRU)                                      │
</span><span data-line="26">│                                                                              │
</span><span data-line="27">│   6. Inject toolbar if HTML response                                         │
</span><span data-line="28">│      ├─► Render toolbar HTML                                                │
</span><span data-line="29">│      ├─► Insert before &lt;/body&gt;                                              │
</span><span data-line="30">│      └─► Update Content-Length header                                       │
</span><span data-line="31">│                                                                              │
</span><span data-line="32">│   7. Add Server-Timing header                                                │
</span><span data-line="33">│      └─► Collect from all panels                                            │
</span><span data-line="34">│                                                                              │
</span><span data-line="35">│   8. Send modified response                                                  │
</span><span data-line="36">└─────────────────────────────────────────────────────────────────────────────┘
</span></pre></div>
</div>
</section>
<section id="panel-data-collection">
<h3>8.2 Panel Data Collection<a class="headerlink" href="#panel-data-collection" title="Link to this heading">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span data-line="1">┌─────────────────────────────────────────────────────────────────────────────┐
</span><span data-line="2">│                              Panel Lifecycle                                 │
</span><span data-line="3">│                                                                              │
</span><span data-line="4">│   ┌─────────────────────────────────────────────────────────────────────┐   │
</span><span data-line="5">│   │ process_request(scope)                                               │   │
</span><span data-line="6">│   │   • Called when request starts                                       │   │
</span><span data-line="7">│   │   • Initialize panel-specific tracking (e.g., start timer)          │   │
</span><span data-line="8">│   │   • Access scope for request data                                    │   │
</span><span data-line="9">│   └─────────────────────────────────────────────────────────────────────┘   │
</span><span data-line="10">│                                    │                                         │
</span><span data-line="11">│                                    ▼                                         │
</span><span data-line="12">│   ┌─────────────────────────────────────────────────────────────────────┐   │
</span><span data-line="13">│   │ [During Request Processing]                                          │   │
</span><span data-line="14">│   │   • Panel hooks (e.g., SQLAlchemy events) collect data              │   │
</span><span data-line="15">│   │   • Logging handler captures log records                             │   │
</span><span data-line="16">│   │   • Profiler runs (if enabled)                                       │   │
</span><span data-line="17">│   └─────────────────────────────────────────────────────────────────────┘   │
</span><span data-line="18">│                                    │                                         │
</span><span data-line="19">│                                    ▼                                         │
</span><span data-line="20">│   ┌─────────────────────────────────────────────────────────────────────┐   │
</span><span data-line="21">│   │ process_response(scope, status_code, headers, body)                  │   │
</span><span data-line="22">│   │   • Called after response generated                                  │   │
</span><span data-line="23">│   │   • Finalize data collection (e.g., stop timer)                     │   │
</span><span data-line="24">│   │   • Access response for data extraction                              │   │
</span><span data-line="25">│   └─────────────────────────────────────────────────────────────────────┘   │
</span><span data-line="26">│                                    │                                         │
</span><span data-line="27">│                                    ▼                                         │
</span><span data-line="28">│   ┌─────────────────────────────────────────────────────────────────────┐   │
</span><span data-line="29">│   │ generate_stats() -&gt; dict[str, Any]                                   │   │
</span><span data-line="30">│   │   • Compute final statistics                                         │   │
</span><span data-line="31">│   │   • Return dictionary for storage/rendering                          │   │
</span><span data-line="32">│   └─────────────────────────────────────────────────────────────────────┘   │
</span><span data-line="33">│                                    │                                         │
</span><span data-line="34">│                                    ▼                                         │
</span><span data-line="35">│   ┌─────────────────────────────────────────────────────────────────────┐   │
</span><span data-line="36">│   │ record_stats(stats)                                                  │   │
</span><span data-line="37">│   │   • Store in RequestContext.panels_data[panel_id]                   │   │
</span><span data-line="38">│   │   • Data persisted to ToolbarStorage                                 │   │
</span><span data-line="39">│   └─────────────────────────────────────────────────────────────────────┘   │
</span><span data-line="40">│                                                                              │
</span><span data-line="41">└─────────────────────────────────────────────────────────────────────────────┘
</span></pre></div>
</div>
</section>
<section id="storage-architecture">
<h3>8.3 Storage Architecture<a class="headerlink" href="#storage-architecture" title="Link to this heading">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span data-line="1">┌─────────────────────────────────────────────────────────────────────────────┐
</span><span data-line="2">│                            ToolbarStorage (LRU)                              │
</span><span data-line="3">│                                                                              │
</span><span data-line="4">│   max_size = 50 (configurable)                                              │
</span><span data-line="5">│                                                                              │
</span><span data-line="6">│   ┌─────────────────────────────────────────────────────────────────────┐   │
</span><span data-line="7">│   │ OrderedDict[request_id -&gt; ToolbarRecord]                             │   │
</span><span data-line="8">│   │                                                                      │   │
</span><span data-line="9">│   │   &quot;abc-123&quot; ─► ToolbarRecord(                                       │   │
</span><span data-line="10">│   │                   request_id=&quot;abc-123&quot;,                             │   │
</span><span data-line="11">│   │                   timestamp=datetime(...),                          │   │
</span><span data-line="12">│   │                   method=&quot;GET&quot;,                                      │   │
</span><span data-line="13">│   │                   path=&quot;/api/users&quot;,                                 │   │
</span><span data-line="14">│   │                   status_code=200,                                   │   │
</span><span data-line="15">│   │                   duration_ms=45.2,                                  │   │
</span><span data-line="16">│   │                   panels_data={                                      │   │
</span><span data-line="17">│   │                       &quot;timer&quot;: {...},                                │   │
</span><span data-line="18">│   │                       &quot;request&quot;: {...},                              │   │
</span><span data-line="19">│   │                       &quot;sqlalchemy&quot;: {...},                           │   │
</span><span data-line="20">│   │                   }                                                  │   │
</span><span data-line="21">│   │               )                                                      │   │
</span><span data-line="22">│   │                                                                      │   │
</span><span data-line="23">│   │   &quot;def-456&quot; ─► ToolbarRecord(...)                                   │   │
</span><span data-line="24">│   │   ...                                                                │   │
</span><span data-line="25">│   │   [Oldest entries evicted when max_size exceeded]                   │   │
</span><span data-line="26">│   └─────────────────────────────────────────────────────────────────────┘   │
</span><span data-line="27">│                                                                              │
</span><span data-line="28">│   Operations:                                                                │
</span><span data-line="29">│   • store(request_id, data) ─► O(1) insert, LRU eviction                   │
</span><span data-line="30">│   • get(request_id) ─► O(1) lookup, moves to end (LRU update)              │
</span><span data-line="31">│   • get_history(limit) ─► Returns most recent N records                     │
</span><span data-line="32">│   • Thread-safe via RLock                                                    │
</span><span data-line="33">│                                                                              │
</span><span data-line="34">└─────────────────────────────────────────────────────────────────────────────┘
</span></pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="security-considerations">
<h2>9. Security Considerations<a class="headerlink" href="#security-considerations" title="Link to this heading">¶</a></h2>
<section id="access-control">
<h3>9.1 Access Control<a class="headerlink" href="#access-control" title="Link to this heading">¶</a></h3>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Risk</p></th>
<th class="head"><p>Mitigation</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Sensitive data exposure</p></td>
<td><p>Toolbar disabled by default in production</p></td>
</tr>
<tr class="row-odd"><td><p>Remote access</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">require_local=True</span></code> restricts to localhost</p></td>
</tr>
<tr class="row-even"><td><p>Host spoofing</p></td>
<td><p>Validate against <code class="docutils literal notranslate"><span class="pre">allowed_hosts</span></code> list</p></td>
</tr>
<tr class="row-odd"><td><p>Path traversal</p></td>
<td><p>Sanitize static file paths</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="configuration-best-practices">
<h3>9.2 Configuration Best Practices<a class="headerlink" href="#configuration-best-practices" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># Production-safe configuration</span>
</span><span data-line="2"><span class="n">config</span> <span class="o">=</span> <span class="n">DebugToolbarConfig</span><span class="p">(</span>
</span><span data-line="3">    <span class="c1"># Only enable via environment variable</span>
</span><span data-line="4">    <span class="n">enabled</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DEBUG_TOOLBAR_ENABLED&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
</span><span data-line="5">
</span><span data-line="6">    <span class="c1"># Restrict to local access</span>
</span><span data-line="7">    <span class="n">require_local</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="8">    <span class="n">allowed_hosts</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="s2">&quot;::1&quot;</span><span class="p">],</span>
</span><span data-line="9">
</span><span data-line="10">    <span class="c1"># Custom callback for fine-grained control</span>
</span><span data-line="11">    <span class="n">show_toolbar_callback</span><span class="o">=</span><span class="k">lambda</span> <span class="n">scope</span><span class="p">:</span> <span class="p">(</span>
</span><span data-line="12">        <span class="n">scope</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;app&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span>
</span><span data-line="13">        <span class="ow">and</span> <span class="n">scope</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;client&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,))[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="s2">&quot;::1&quot;</span><span class="p">]</span>
</span><span data-line="14">    <span class="p">),</span>
</span><span data-line="15"><span class="p">)</span>
</span></pre></div>
</div>
</section>
<section id="data-sanitization">
<h3>9.3 Data Sanitization<a class="headerlink" href="#data-sanitization" title="Link to this heading">¶</a></h3>
<p>Panels must sanitize sensitive data:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="n">SENSITIVE_HEADERS</span> <span class="o">=</span> <span class="p">{</span>
</span><span data-line="2">    <span class="s2">&quot;authorization&quot;</span><span class="p">,</span>
</span><span data-line="3">    <span class="s2">&quot;cookie&quot;</span><span class="p">,</span>
</span><span data-line="4">    <span class="s2">&quot;set-cookie&quot;</span><span class="p">,</span>
</span><span data-line="5">    <span class="s2">&quot;x-api-key&quot;</span><span class="p">,</span>
</span><span data-line="6">    <span class="s2">&quot;x-auth-token&quot;</span><span class="p">,</span>
</span><span data-line="7"><span class="p">}</span>
</span><span data-line="8">
</span><span data-line="9"><span class="n">SENSITIVE_PARAMS</span> <span class="o">=</span> <span class="p">{</span>
</span><span data-line="10">    <span class="s2">&quot;password&quot;</span><span class="p">,</span>
</span><span data-line="11">    <span class="s2">&quot;secret&quot;</span><span class="p">,</span>
</span><span data-line="12">    <span class="s2">&quot;token&quot;</span><span class="p">,</span>
</span><span data-line="13">    <span class="s2">&quot;api_key&quot;</span><span class="p">,</span>
</span><span data-line="14">    <span class="s2">&quot;apikey&quot;</span><span class="p">,</span>
</span><span data-line="15"><span class="p">}</span>
</span><span data-line="16">
</span><span data-line="17"><span class="k">def</span><span class="w"> </span><span class="nf">sanitize_value</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="18"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Redact sensitive values.&quot;&quot;&quot;</span>
</span><span data-line="19">    <span class="n">key_lower</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span data-line="20">    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">s</span> <span class="ow">in</span> <span class="n">key_lower</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">SENSITIVE_PARAMS</span><span class="p">):</span>
</span><span data-line="21">        <span class="k">return</span> <span class="s2">&quot;[REDACTED]&quot;</span>
</span><span data-line="22">    <span class="k">return</span> <span class="n">value</span>
</span></pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="performance-considerations">
<h2>10. Performance Considerations<a class="headerlink" href="#performance-considerations" title="Link to this heading">¶</a></h2>
<section id="overhead-analysis">
<h3>10.1 Overhead Analysis<a class="headerlink" href="#overhead-analysis" title="Link to this heading">¶</a></h3>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Component</p></th>
<th class="head"><p>Enabled Overhead</p></th>
<th class="head"><p>Disabled Overhead</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Middleware check</p></td>
<td><p>~0.1ms</p></td>
<td><p>~0.01ms</p></td>
</tr>
<tr class="row-odd"><td><p>Panel processing</p></td>
<td><p>1-5ms</p></td>
<td><p>0ms</p></td>
</tr>
<tr class="row-even"><td><p>Template rendering</p></td>
<td><p>2-10ms</p></td>
<td><p>0ms</p></td>
</tr>
<tr class="row-odd"><td><p>Storage operations</p></td>
<td><p>~0.1ms</p></td>
<td><p>0ms</p></td>
</tr>
<tr class="row-even"><td><p><strong>Total</strong></p></td>
<td><p><strong>3-15ms</strong></p></td>
<td><p><strong>~0.01ms</strong></p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="optimization-strategies">
<h3>10.2 Optimization Strategies<a class="headerlink" href="#optimization-strategies" title="Link to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p><strong>Lazy Initialization</strong>: Toolbar and panels initialized on first request</p></li>
<li><p><strong>Conditional Processing</strong>: Skip all panel logic when disabled</p></li>
<li><p><strong>LRU Caching</strong>: Bounded memory for request history</p></li>
<li><p><strong>Template Caching</strong>: Compiled templates cached</p></li>
<li><p><strong>Async-Native</strong>: No blocking operations in request path</p></li>
</ol>
</section>
<section id="memory-usage">
<h3>10.3 Memory Usage<a class="headerlink" href="#memory-usage" title="Link to this heading">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="n">Base</span> <span class="n">toolbar</span> <span class="n">instance</span><span class="p">:</span>    <span class="o">~</span><span class="mi">50</span> <span class="n">KB</span>
</span><span data-line="2"><span class="n">Per</span> <span class="n">request</span> <span class="p">(</span><span class="mi">50</span> <span class="n">history</span><span class="p">):</span> <span class="o">~</span><span class="mi">10</span> <span class="n">KB</span> <span class="n">average</span>
</span><span data-line="3">  <span class="o">-</span> <span class="n">Timer</span> <span class="n">panel</span><span class="p">:</span>          <span class="o">~</span><span class="mi">100</span> <span class="nb">bytes</span>
</span><span data-line="4">  <span class="o">-</span> <span class="n">Request</span> <span class="n">panel</span><span class="p">:</span>        <span class="o">~</span><span class="mi">2</span> <span class="n">KB</span>
</span><span data-line="5">  <span class="o">-</span> <span class="n">Response</span> <span class="n">panel</span><span class="p">:</span>       <span class="o">~</span><span class="mi">1</span> <span class="n">KB</span> <span class="p">(</span><span class="n">truncated</span> <span class="n">body</span><span class="p">)</span>
</span><span data-line="6">  <span class="o">-</span> <span class="n">Logging</span> <span class="n">panel</span><span class="p">:</span>        <span class="o">~</span><span class="mi">1</span><span class="o">-</span><span class="mi">10</span> <span class="n">KB</span> <span class="p">(</span><span class="n">varies</span><span class="p">)</span>
</span><span data-line="7">  <span class="o">-</span> <span class="n">SQLAlchemy</span> <span class="n">panel</span><span class="p">:</span>     <span class="o">~</span><span class="mi">5</span> <span class="n">KB</span> <span class="p">(</span><span class="mi">10</span> <span class="n">queries</span> <span class="n">avg</span><span class="p">)</span>
</span><span data-line="8">
</span><span data-line="9"><span class="n">Total</span> <span class="n">memory</span> <span class="n">footprint</span><span class="p">:</span>   <span class="o">~</span><span class="mi">550</span> <span class="n">KB</span> <span class="p">(</span><span class="mi">50</span> <span class="n">requests</span><span class="p">)</span>
</span></pre></div>
</div>
</section>
<section id="profiling-panel-impact">
<h3>10.4 Profiling Panel Impact<a class="headerlink" href="#profiling-panel-impact" title="Link to this heading">¶</a></h3>
<p>The ProfilingPanel has significant overhead and should only be enabled when needed:</p>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Mode</p></th>
<th class="head"><p>Overhead</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Disabled</p></td>
<td><p>0ms</p></td>
</tr>
<tr class="row-odd"><td><p>Basic profiling</p></td>
<td><p>20-100ms</p></td>
</tr>
<tr class="row-even"><td><p>With call graph</p></td>
<td><p>50-200ms</p></td>
</tr>
</tbody>
</table>
</div>
</section>
</section>
<hr class="docutils" />
<section id="implementation-roadmap">
<h2>11. Implementation Roadmap<a class="headerlink" href="#implementation-roadmap" title="Link to this heading">¶</a></h2>
<section id="phase-1-core-foundation-week-1-2">
<h3>Phase 1: Core Foundation (Week 1-2)<a class="headerlink" href="#phase-1-core-foundation-week-1-2" title="Link to this heading">¶</a></h3>
<ul class="contains-task-list simple">
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> Project scaffolding with uv</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> Core config and settings system</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> Request context management</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> Storage backend with LRU</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> Base Panel abstract class</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> Template engine with Jinja2</p></li>
</ul>
</section>
<section id="phase-2-built-in-panels-week-2-3">
<h3>Phase 2: Built-in Panels (Week 2-3)<a class="headerlink" href="#phase-2-built-in-panels-week-2-3" title="Link to this heading">¶</a></h3>
<ul class="contains-task-list simple">
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> TimerPanel</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> RequestPanel</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> ResponsePanel</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> LoggingPanel</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> VersionsPanel</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> RoutesPanel</p></li>
</ul>
</section>
<section id="phase-3-litestar-integration-week-3-4">
<h3>Phase 3: Litestar Integration (Week 3-4)<a class="headerlink" href="#phase-3-litestar-integration-week-3-4" title="Link to this heading">¶</a></h3>
<ul class="contains-task-list simple">
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> LitestarAdapter implementation</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> DebugToolbarMiddleware</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> DebugToolbarPlugin</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> Route handlers for toolbar API</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> Static asset serving</p></li>
</ul>
</section>
<section id="phase-4-advanced-features-week-4-5">
<h3>Phase 4: Advanced Features (Week 4-5)<a class="headerlink" href="#phase-4-advanced-features-week-4-5" title="Link to this heading">¶</a></h3>
<ul class="contains-task-list simple">
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> ProfilingPanel with cProfile</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> SQLAlchemyPanel for Advanced-Alchemy</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> Event hooks system</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> N+1 query detection</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> EXPLAIN plan integration</p></li>
</ul>
</section>
<section id="phase-5-ui-ux-week-5-6">
<h3>Phase 5: UI/UX (Week 5-6)<a class="headerlink" href="#phase-5-ui-ux-week-5-6" title="Link to this heading">¶</a></h3>
<ul class="contains-task-list simple">
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> Toolbar HTML/CSS/JS assets</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> Panel templates</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> History view</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> Request detail view</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> Theme support (light/dark)</p></li>
</ul>
</section>
<section id="phase-6-testing-documentation-week-6-7">
<h3>Phase 6: Testing &amp; Documentation (Week 6-7)<a class="headerlink" href="#phase-6-testing-documentation-week-6-7" title="Link to this heading">¶</a></h3>
<ul class="contains-task-list simple">
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> Unit tests (90%+ coverage)</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> Integration tests with Litestar</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> Performance benchmarks</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> API documentation</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> Usage examples</p></li>
</ul>
</section>
<section id="phase-7-polish-release-week-7-8">
<h3>Phase 7: Polish &amp; Release (Week 7-8)<a class="headerlink" href="#phase-7-polish-release-week-7-8" title="Link to this heading">¶</a></h3>
<ul class="contains-task-list simple">
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> Security audit</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> Performance optimization</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> PyPI packaging</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> Release automation</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> Announcement/marketing</p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="appendix-a-api-quick-reference">
<h2>Appendix A: API Quick Reference<a class="headerlink" href="#appendix-a-api-quick-reference" title="Link to this heading">¶</a></h2>
<section id="toolbar-configuration">
<h3>Toolbar Configuration<a class="headerlink" href="#toolbar-configuration" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">DebugToolbarConfig</span>
</span><span data-line="2">
</span><span data-line="3"><span class="n">config</span> <span class="o">=</span> <span class="n">DebugToolbarConfig</span><span class="p">(</span>
</span><span data-line="4">    <span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="5">    <span class="n">panels</span><span class="o">=</span><span class="p">[</span><span class="o">...</span><span class="p">],</span>
</span><span data-line="6">    <span class="n">max_history</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
</span><span data-line="7">    <span class="n">root_path</span><span class="o">=</span><span class="s2">&quot;/_debug_toolbar&quot;</span><span class="p">,</span>
</span><span data-line="8"><span class="p">)</span>
</span></pre></div>
</div>
</section>
<section id="litestar-integration">
<h3>Litestar Integration<a class="headerlink" href="#litestar-integration" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="kn">from</span><span class="w"> </span><span class="nn">litestar</span><span class="w"> </span><span class="kn">import</span> <span class="n">Litestar</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">litestar_debug_toolbar</span><span class="w"> </span><span class="kn">import</span> <span class="n">DebugToolbarPlugin</span>
</span><span data-line="3">
</span><span data-line="4"><span class="n">app</span> <span class="o">=</span> <span class="n">Litestar</span><span class="p">(</span>
</span><span data-line="5">    <span class="n">plugins</span><span class="o">=</span><span class="p">[</span><span class="n">DebugToolbarPlugin</span><span class="p">()],</span>
</span><span data-line="6"><span class="p">)</span>
</span></pre></div>
</div>
</section>
<section id="custom-panel">
<h3>Custom Panel<a class="headerlink" href="#custom-panel" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.panel</span><span class="w"> </span><span class="kn">import</span> <span class="n">Panel</span>
</span><span data-line="2">
</span><span data-line="3"><span class="k">class</span><span class="w"> </span><span class="nc">MyPanel</span><span class="p">(</span><span class="n">Panel</span><span class="p">):</span>
</span><span data-line="4">    <span class="n">panel_id</span> <span class="o">=</span> <span class="s2">&quot;my_panel&quot;</span>
</span><span data-line="5">    <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;My Panel&quot;</span>
</span><span data-line="6">    <span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;panels/my_panel.html&quot;</span>
</span><span data-line="7">
</span><span data-line="8">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span data-line="9">        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;custom&quot;</span><span class="p">:</span> <span class="s2">&quot;data&quot;</span><span class="p">}</span>
</span></pre></div>
</div>
</section>
<section id="id1">
<h3>Advanced-Alchemy Integration<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="kn">from</span><span class="w"> </span><span class="nn">litestar_debug_toolbar</span><span class="w"> </span><span class="kn">import</span> <span class="n">DebugToolbarPlugin</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">async_debug_toolbar.extras.advanced_alchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">configure_advanced_alchemy_panel</span>
</span><span data-line="3">
</span><span data-line="4"><span class="n">config</span> <span class="o">=</span> <span class="n">DebugToolbarConfig</span><span class="p">()</span>
</span><span data-line="5"><span class="n">configure_advanced_alchemy_panel</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><span data-line="6">
</span><span data-line="7"><span class="n">app</span> <span class="o">=</span> <span class="n">Litestar</span><span class="p">(</span>
</span><span data-line="8">    <span class="n">plugins</span><span class="o">=</span><span class="p">[</span><span class="n">DebugToolbarPlugin</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)],</span>
</span><span data-line="9"><span class="p">)</span>
</span></pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="appendix-b-template-structure">
<h2>Appendix B: Template Structure<a class="headerlink" href="#appendix-b-template-structure" title="Link to this heading">¶</a></h2>
<section id="base-toolbar-template">
<h3>Base Toolbar Template<a class="headerlink" href="#base-toolbar-template" title="Link to this heading">¶</a></h3>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="cm">&lt;!-- templates/toolbar.html --&gt;</span>
</span><span data-line="2"><span class="cp">&lt;!DOCTYPE html&gt;</span>
</span><span data-line="3"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;debug-toolbar&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;debug-toolbar&quot;</span><span class="p">&gt;</span>
</span><span data-line="4">  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;toolbar-handle&quot;</span><span class="p">&gt;</span>
</span><span data-line="5">    <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;toolbar-toggle&quot;</span><span class="p">&gt;</span>Debug<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
</span><span data-line="6">  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span><span data-line="7">
</span><span data-line="8">  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;toolbar-content&quot;</span><span class="p">&gt;</span>
</span><span data-line="9">    <span class="p">&lt;</span><span class="nt">nav</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;toolbar-nav&quot;</span><span class="p">&gt;</span>
</span><span data-line="10">      {% for panel_data in panels %}
</span><span data-line="11">      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;nav-item&quot;</span> <span class="na">data-panel</span><span class="o">=</span><span class="s">&quot;{{ panel_data.panel.panel_id }}&quot;</span><span class="p">&gt;</span>
</span><span data-line="12">        <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;nav-title&quot;</span><span class="p">&gt;</span>{{ panel_data.panel.title }}<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
</span><span data-line="13">        <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;nav-subtitle&quot;</span><span class="p">&gt;</span>{{ panel_data.panel.nav_subtitle }}<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
</span><span data-line="14">      <span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
</span><span data-line="15">      {% endfor %}
</span><span data-line="16">    <span class="p">&lt;/</span><span class="nt">nav</span><span class="p">&gt;</span>
</span><span data-line="17">
</span><span data-line="18">    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;panels-container&quot;</span><span class="p">&gt;</span>
</span><span data-line="19">      {% for panel_data in panels %}
</span><span data-line="20">      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;panel&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;panel-{{ panel_data.panel.panel_id }}&quot;</span><span class="p">&gt;</span>
</span><span data-line="21">        {{ panel_data.content|safe }}
</span><span data-line="22">      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span><span data-line="23">      {% endfor %}
</span><span data-line="24">    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span><span data-line="25">  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span><span data-line="26"><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span><span data-line="27">
</span><span data-line="28"><span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;{{ config.root_path }}/static/css/toolbar.css&quot;</span><span class="p">&gt;</span>
</span><span data-line="29"><span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;{{ config.root_path }}/static/js/toolbar.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></pre></div>
</div>
<hr class="docutils" />
<p><em>Document Version: 1.0.0</em>
<em>Last Updated: 2025-11-26</em>
<em>Status: Proposed</em></p>
</section>
</section>
</section>

        </article><button class="back-to-top" type="button">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
  </svg>
  <span>Back to top</span>
</button><div class="navigation flex print:hidden"><div class="navigation-prev">
    <a href="../api/_autosummary/debug_toolbar.litestar.routes.handlers.html">
      <i class="i-lucide chevron-left"></i>
      <div class="page-info">
        <span>Previous</span><div class="title">debug_toolbar.litestar.routes.handlers</div></div>
    </a>
  </div><div class="navigation-next">
    <a href="adr/ADR-001-dual-package-architecture.html">
      <div class="page-info">
        <span>Next</span>
        <div class="title">ADR-001: Dual Package Architecture</div>
      </div>
      <i class="i-lucide chevron-right"></i>
    </a>
  </div></div></div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2024, Jacob Coffee</p>
  
  <p>
    Made with
    
    <a href="https://www.sphinx-doc.org/">Sphinx</a> and
    
    <a href="https://shibuya.lepture.com">Shibuya theme</a>.
  </p>
</div>
      <div class="sy-foot-socials">
<a href="https://github.com/JacobCoffee/async-python-debug-toolbar" aria-label="GitHub">
  <iconify-icon icon="simple-icons:github"></iconify-icon>
</a></div>
    </div>
  </div>
</footer>
      <script src="../_static/documentation_options.js?v=01f34227"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../_static/copybutton.js?v=fd10adb8"></script>
      <script src="../_static/design-tabs.js?v=f930bc37"></script>
      <script src="../_static/shibuya.js?v=c1cf1a6b"></script></body>
</html>