name: Publish

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  id-token: write

jobs:
  # ==================================================================================== #
  # BUILD
  # ==================================================================================== #
  build:
    name: Build Package
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          persist-credentials: false

      - name: Set up uv
        uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244 # v6
        with:
          enable-cache: true
          version: "0.9.12"

      - name: Build package
        run: uv build

      - name: Upload dist artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: dist
          path: dist/
          retention-days: 7

  # ==================================================================================== #
  # SIGN
  # ==================================================================================== #
  sign:
    name: Sign Distributions
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: Download dist artifacts
        uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4
        with:
          name: dist
          path: dist/

      - name: Sign distributions with Sigstore
        uses: sigstore/gh-action-sigstore-python@e0bbae5e2ed3beb4c51c3d11beaa74e5cc7f4dc2 # v3.0.0
        with:
          inputs: ./dist/*

      - name: Upload signed artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: dist-signed
          path: dist/
          retention-days: 7

  # ==================================================================================== #
  # DRAFT RELEASE
  # ==================================================================================== #
  draft-release:
    name: Create Draft Release
    runs-on: ubuntu-latest
    needs: [sign]
    steps:
      - name: Download signed artifacts
        uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4
        with:
          name: dist-signed
          path: dist/

      - name: Create GitHub Release (Draft)
        uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # v2
        with:
          draft: true
          files: |
            dist/*
          generate_release_notes: true

  # ==================================================================================== #
  # PUBLISH TO PYPI
  # ==================================================================================== #
  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [draft-release]
    environment:
      name: pypi
      url: https://pypi.org/project/async-debug-toolbar/
    steps:
      - name: Download dist artifacts (unsigned)
        uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4
        with:
          name: dist
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@15c56dba361d8335944d31a2ecd17d700fc7bcbc # release/v1
        with:
          print-hash: true
          attestations: true

  # ==================================================================================== #
  # FINALIZE RELEASE
  # ==================================================================================== #
  publish-release:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: [publish-pypi]
    steps:
      - name: Mark Release as Published
        uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # v2
        with:
          draft: false

  # ==================================================================================== #
  # CLEANUP ON FAILURE
  # ==================================================================================== #
  cleanup-draft:
    name: Cleanup Draft Release
    runs-on: ubuntu-latest
    needs: [publish-pypi]
    if: failure()
    steps:
      - name: Delete Draft Release
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7
        with:
          script: |
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            const draft = releases.data.find(r => r.draft && r.tag_name === context.ref.replace('refs/tags/', ''));
            if (draft) {
              await github.rest.repos.deleteRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: draft.id
              });
            }
